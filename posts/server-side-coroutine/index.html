<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Androidアプリのように、GUIを使う場合にはマルチスレッドで処理するのはもはや常識のようなものです。シングルスレッドだと何か思い処理が"><title>BackendでCoroutineを使う</title><link rel=canonical href=https://retheviper.github.io/posts/server-side-coroutine/><link rel=stylesheet href=/scss/style.min.fbb68fe51fb77bdd639dccfe1c7b590d2330cf8b81da91f1585b35c3d07fbac8.css><meta property="og:title" content="BackendでCoroutineを使う"><meta property="og:description" content="Androidアプリのように、GUIを使う場合にはマルチスレッドで処理するのはもはや常識のようなものです。シングルスレッドだと何か思い処理が"><meta property="og:url" content="https://retheviper.github.io/posts/server-side-coroutine/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="kotlin"><meta property="article:tag" content="go"><meta property="article:tag" content="coroutine"><meta property="article:tag" content="goroutine"><meta property="article:tag" content="concurrency"><meta property="article:published_time" content="2022-06-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-05T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/magic.jpg"><meta name=twitter:title content="BackendでCoroutineを使う"><meta name=twitter:description content="Androidアプリのように、GUIを使う場合にはマルチスレッドで処理するのはもはや常識のようなものです。シングルスレッドだと何か思い処理が"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/magic.jpg"><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-BYJBEJB6DX',{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e='StackColorScheme';localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t='StackColorScheme',e=localStorage.getItem(t),n=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;e=='dark'||e==='auto'&&n?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/server-side-coroutine/><img src=/../../images/magic.jpg loading=lazy alt="Featured image of post BackendでCoroutineを使う"></a></div><div class=article-details><header class=article-category><a href=/categories/languages/ style=background-color:#2a9d8f;color:#fff>languages</a></header><h2 class=article-title><a href=/posts/server-side-coroutine/>BackendでCoroutineを使う</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 05, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>15 minute read</time></div></footer></div></header><section class=article-content><p>Androidアプリのように、GUIを使う場合にはマルチスレッドで処理するのはもはや常識のようなものです。シングルスレッドだと何か思い処理が行われる間に画面が固まるからです。他にもプログレスバーのようにリアルタイムで変化されるコンポーネントの状態を更新したり、チャット、通知の表示などさまざまな場面でスレッドを分けて処理する必要がある場合が多いですね。</p><p>ただ、バックエンドの処理においては少し事情が違うものです。そもそもGUIを考慮する必要がないということもありあすが、サーバでは一つのリクエストに対しての処理を「順次的に」行う場合が多いため、マルチスレッドを利用した処理の分散の利点を活かすのはなかなか難しいものです。<a class=link href=https://www.reactive-streams.org target=_blank rel=noopener>Reactive Streams</a>のようなものもありますが、これは一つのリクエストを分散するというより少ないリソースで多くのリクエストに対する処理を行うためのものなので、一つの処理を分散して効率を上げたいという場合にはあまりふさわしくないものですね。</p><p>もちろん、だからと言ってバックエンドにおいて分散処理が全く必要ないというわけではありません。確かに一つのリクエストに対しての処理を行う中でも、処理によってスレッドを分けて性能向上を期待できる場面があります。例えば後続の処理と関係のない処理を途中に挟んでい場合では、別スレッドで処理したくなりますね。</p><p>なので、今回は<a class=link href=https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3 target=_blank rel=noopener>Coroutine</a>を使ったバックエンドでの処理の分散するという一例を紹介したいと思います。</p><h2 id=apiの呼び出しを並列化する>APIの呼び出しを並列化する</h2><p>まず並列化で効率を上げられるケースとして、バッチ処理を考えられます。バッチ処理では、条件に当てはまるデータを複数抽出し、それぞれのデータに対して同じ処理を繰り返すことが多いですね。このように個別のデータに対しての処理が独立的に実行されるものであり、並行して走っても特に問題はないという場合は十分その処理を分散できるものです。</p><p>仕事ではGoで作成されたサーバから定期的に日付を基準にDBから処理対象のデータを抽出し、そのデータを配列にしてループしながらKotlinで作成されたサーバのAPIを呼び出すようになっています。また、KotlinサーバでもBackendのAPIを呼び出すケースがあり、これもまたループでデータの参照を行っている状態です。サービスが成長するにつれて、処理にかかる時間によりAPI呼び出しがタイムアウトになるなどパフォーマンスの問題が出てきたので、このループの中でのAPI呼び出しを並列化することで処理にかかる時間を減らすことにします。</p><h2 id=実装してみる>実装してみる</h2><p>まずはCoroutineにより、ループの中でのAPIの呼び出しを実現してみます。上述したとおり、実際の仕事で使えるかどうかを検証してみたく書いたコードなので、各サーバの処理は大して変わらないものとなっています。まずループの中で互いのAPIを呼び出すような処理を書き、呼び出される側では5秒を待ってレスポンスを送るようになっています。これをCoroutineを利用して並列化していきます。</p><h3 id=go>Go</h3><p>まず、以下のような処理があるとします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> callResults <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span>    Response []<span style=color:#ff79c6>*</span>client.Response <span style=color:#f1fa8c>`json:&#34;response&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>CallKotlinServer</span>(c <span style=color:#ff79c6>*</span>gin.Context) {
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServer] start&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    results <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>callResults{}
</span></span><span style=display:flex><span>    tries <span style=color:#ff79c6>:=</span> []<span style=color:#8be9fd>int</span>{<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>3</span>, <span style=color:#bd93f9>4</span>, <span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>6</span>, <span style=color:#bd93f9>7</span>, <span style=color:#bd93f9>8</span>, <span style=color:#bd93f9>9</span>, <span style=color:#bd93f9>10</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, i <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> tries {
</span></span><span style=display:flex><span>        log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServer] before request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>var</span> result <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        r, err <span style=color:#ff79c6>:=</span> client.<span style=color:#50fa7b>Post</span>(i) <span style=color:#6272a4>// KotlinサーバにPOSTでリクエストを送る
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> <span style=color:#ff79c6>||</span> r <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>            result = <span style=color:#f1fa8c>&#34;failed&#34;</span>
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            result = r.Result
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServer] after request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results.Response = <span style=color:#8be9fd;font-style:italic>append</span>(results.Response, <span style=color:#ff79c6>&amp;</span>client.Response{
</span></span><span style=display:flex><span>            ID:     i,
</span></span><span style=display:flex><span>            Result: result,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServer] done&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    c.<span style=color:#50fa7b>JSON</span>(http.StatusOK, results)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上記のコードは<a class=link href=https://gin-gonic.com target=_blank rel=noopener>Gin</a>を使ったサーバのサンプルで、handlerの部分です。この関数の中ではAPIが呼び出されると、10回のループの中でKotlinサーバにリクエストを送ります。そして帰ってきたAPI呼び出しの結果を持ってレスポンスのstructを作成して、最終的には10回の実行結果をまとめてJSONとして返す構造となっています。</p><p>ここでKotlin側が返すレスポンスは5秒かかるため、ループの回数が多くなれば多くなるほどレスポンスが帰ってくるのも遅くなります。ログを吐くようにしているので、サーバのログを確認するとリクエストからレスポンスに50秒がかかっているのを確認できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022/06/05 18:49:31 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022/06/05 18:49:31 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:36 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:36 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:41 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:41 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:46 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:46 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:51 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:51 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:56 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 18:49:56 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:01 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:01 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:06 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:06 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:11 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:11 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:16 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:16 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:21 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 18:50:21 <span style=color:#ff79c6>[</span>CallKotlinServer<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>GIN<span style=color:#ff79c6>]</span> 2022/06/05 - 18:50:21 | <span style=color:#bd93f9>200</span> | 50.250251292s |       127.0.0.1 | GET      <span style=color:#f1fa8c>&#34;/api/v1/call-kotlin-server&#34;</span>
</span></span></code></pre></div><h4 id=goroutineで並列化する1>Goroutineで並列化する(1)</h4><p>では、以上の処理を並列化することにします。Goには<a class=link href=https://go-tour-jp.appspot.com/concurrency/1 target=_blank rel=noopener>Goroutine</a>が基本的に含まれています。使い方は単純で、実行したい関数の前に<code>go</code>のキーワードをつけるだけですね。ただ、レスポンスでは10回の実行結果を待ってから返す必要があるのですが、goroutineでAPIの呼び出しをするとメインスレッドが先に終わってしまう可能性があります。</p><p>というわけで、ループの中でのAPIの呼び出しにgoroutineを使い、さらにそのgoroutineが全て終了してから結果を返すようにします。goには<code>sync</code>というパッケージに<a class=link href=https://pkg.go.dev/sync#WaitGroup target=_blank rel=noopener>waitGroup</a>があり、goroutineの終了を待つことができるようになっています。また、goroutineをループの中で実行する場合、順番はランダムになるのでレスポンスを返す際は一度ソートをかけるようにします。以上を考慮して実装した結果は以下の通りです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>CallKotlinServerAsync</span>(c <span style=color:#ff79c6>*</span>gin.Context) {
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsync] start&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    results <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>callResults{}
</span></span><span style=display:flex><span>    tries <span style=color:#ff79c6>:=</span> []<span style=color:#8be9fd>int</span>{<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>3</span>, <span style=color:#bd93f9>4</span>, <span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>6</span>, <span style=color:#bd93f9>7</span>, <span style=color:#bd93f9>8</span>, <span style=color:#bd93f9>9</span>, <span style=color:#bd93f9>10</span>}
</span></span><span style=display:flex><span>    group <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>sync.WaitGroup{} <span style=color:#6272a4>// waitGroupを定義
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, i <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> tries {
</span></span><span style=display:flex><span>        group.<span style=color:#50fa7b>Add</span>(<span style=color:#bd93f9>1</span>) <span style=color:#6272a4>// ループごとに実行するgoroutineの回数を追加
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>go</span> <span style=color:#8be9fd;font-style:italic>func</span>(i <span style=color:#8be9fd>int</span>) { <span style=color:#6272a4>// goroutineでAPIの呼び出す
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsync] before request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>var</span> result <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            r, err <span style=color:#ff79c6>:=</span> client.<span style=color:#50fa7b>Post</span>(i)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> <span style=color:#ff79c6>||</span> r <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>                result = <span style=color:#f1fa8c>&#34;failed&#34;</span>
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                result = r.Result
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsync] after request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            results.Response = <span style=color:#8be9fd;font-style:italic>append</span>(results.Response, <span style=color:#ff79c6>&amp;</span>client.Response{
</span></span><span style=display:flex><span>                ID:     i,
</span></span><span style=display:flex><span>                Result: result,
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            group.<span style=color:#50fa7b>Done</span>() <span style=color:#6272a4>// waitGroupにgoroutineの終了を設定
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        }(i)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    group.<span style=color:#50fa7b>Wait</span>() <span style=color:#6272a4>// 全てのgoroutineが終了するのを待つ
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sort.<span style=color:#50fa7b>Slice</span>(results.Response, <span style=color:#8be9fd;font-style:italic>func</span>(i, j <span style=color:#8be9fd>int</span>) <span style=color:#8be9fd>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> results.Response[i].ID &lt; results.Response[j].ID
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsync] done&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    c.<span style=color:#50fa7b>JSON</span>(http.StatusOK, results)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このように修正して実行した結果のログは以下のとおりです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:30 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 18:52:35 <span style=color:#ff79c6>[</span>CallKotlinServerAsync<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>GIN<span style=color:#ff79c6>]</span> 2022/06/05 - 18:52:35 | <span style=color:#bd93f9>200</span> |  5.012657333s |       127.0.0.1 | GET      <span style=color:#f1fa8c>&#34;/api/v1/call-kotlin-server-async&#34;</span>
</span></span></code></pre></div><p>10回のループがほぼ同時に実行されたため、レスポンスまで5秒ほどかかっているのがわかります。そしてやはりgoroutineの実行が順番に行われてないことがわかりますね。なので、実行の順番が重要でなくても、結果は順番を守って返す必要がある時はやはりソートが必要ということがわかります。</p><h4 id=goroutineで並列化する2>Goroutineで並列化する(2)</h4><p>場合によっては並列化できるからって、全ての処理を同時に走らせるのは危険な時もあります。上記のコードの場合、リクエストの数は10となっていますが、もしそれより多くのリクエストが必要か、さらに重い処理のAPIを呼び出す場合はどうでしょうか。Go側はリクエストを投げるだけなので処理の負荷はあまり変わらないものですが、APIを呼び出されている側としてはかなりの負荷になるはずです。</p><p>だとすると、やはり並列の数を制限する必要があるはずです。例えば並列の数を2にすると、リクエストは2件づつ送られるのでリクエストの全体の数がいくら増えても負荷は一定に保てます。同時に全てのリクエストを送るよりは遅くなりますが、リソースの状況を見ながら並列数を増やすだけで柔軟に対応ができるので、外部設定ファイルなどで並列数を指定できるようにするとアプリのビルドなしでも柔軟に対応ができるというメリットもありますね。</p><p>スレッドを使う場合だと、このような処理をするためにはかなり複雑な処理を書くことになるはずです。例えば、並列数に合わせてスレッドを定義して、さらにスレッドごとに割り当てる処理を分けなければならないですね。今は10件のリクエストを想定しているので、スレッドごとに5件づつというふうにリクエストを分けるだけで対応ができますが、リクエスト数をスレッド数で割った結果を考慮してループする要素数を適宜分割するような処理をまず足す必要があります。</p><p>しかし、実はgoroutineを使うとそのような複雑な処理をまた足す必要はないです。goroutineでは<a class=link href=https://go-tour-jp.appspot.com/concurrency/2 target=_blank rel=noopener>Channel</a>を利用して、同時に実行されるgoroutineの数を指定できます。以下のようにです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>CallKotlinServerAsyncDual</span>(c <span style=color:#ff79c6>*</span>gin.Context) {
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsyncDual] start&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    results <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>callResults{}
</span></span><span style=display:flex><span>    tries <span style=color:#ff79c6>:=</span> []<span style=color:#8be9fd>int</span>{<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>3</span>, <span style=color:#bd93f9>4</span>, <span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>6</span>, <span style=color:#bd93f9>7</span>, <span style=color:#bd93f9>8</span>, <span style=color:#bd93f9>9</span>, <span style=color:#bd93f9>10</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    concurrency <span style=color:#ff79c6>:=</span> <span style=color:#bd93f9>2</span> <span style=color:#6272a4>// goroutineの同時実行数を指定
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    group <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>sync.WaitGroup{}
</span></span><span style=display:flex><span>    guard <span style=color:#ff79c6>:=</span> <span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd;font-style:italic>struct</span>{}, concurrency) <span style=color:#6272a4>// 同時実行数でChannelを定義
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, i <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> tries {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        group.<span style=color:#50fa7b>Add</span>(<span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>        guard <span style=color:#ff79c6>&lt;-</span> <span style=color:#8be9fd;font-style:italic>struct</span>{}{} <span style=color:#6272a4>// Channelに実行を一つたす
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>go</span> <span style=color:#8be9fd;font-style:italic>func</span>(i <span style=color:#8be9fd>int</span>) {
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsyncDual] before request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>var</span> result <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            r, err <span style=color:#ff79c6>:=</span> client.<span style=color:#50fa7b>Post</span>(i)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> <span style=color:#ff79c6>||</span> r <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>                result = <span style=color:#f1fa8c>&#34;failed&#34;</span>
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                result = r.Result
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsyncDual] after request with id: &#34;</span>, i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            results.Response = <span style=color:#8be9fd;font-style:italic>append</span>(results.Response, <span style=color:#ff79c6>&amp;</span>client.Response{
</span></span><span style=display:flex><span>                ID:     i,
</span></span><span style=display:flex><span>                Result: result,
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            group.<span style=color:#50fa7b>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;-</span>guard <span style=color:#6272a4>// Channelを準備させる
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        }(i)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    group.<span style=color:#50fa7b>Wait</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sort.<span style=color:#50fa7b>Slice</span>(results.Response, <span style=color:#8be9fd;font-style:italic>func</span>(i, j <span style=color:#8be9fd>int</span>) <span style=color:#8be9fd>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> results.Response[i].ID &lt; results.Response[j].ID
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log.<span style=color:#50fa7b>Print</span>(<span style=color:#f1fa8c>&#34;[CallKotlinServerAsyncDual] done&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    c.<span style=color:#50fa7b>JSON</span>(http.StatusOK, results)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Channelには指定した数分だけ送信すると、Channelから値を受信するまでは新しいgoroutineの実行はブロックされます。なので、実際に実行してみると、意図通り最大2件づつのリクエストが送信されているのを確認できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022/06/05 19:56:10 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022/06/05 19:56:10 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:10 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:15 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:15 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:15 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:15 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:21 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:21 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:21 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:21 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:26 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:26 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:26 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:26 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:31 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:31 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:31 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:31 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:36 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:36 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022/06/05 19:56:36 <span style=color:#ff79c6>[</span>CallKotlinServerAsyncDual<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>GIN<span style=color:#ff79c6>]</span> 2022/06/05 - 19:56:36 | <span style=color:#bd93f9>200</span> | 25.194952625s |       127.0.0.1 | GET      <span style=color:#f1fa8c>&#34;/api/v1/call-kotlin-server-async-dual&#34;</span>
</span></span></code></pre></div><h3 id=kotlin>Kotlin</h3><p>まずは順次処理する場合のコードから見ていきます。基本的にGoの場合と同じ処理をKotlin側にも用意していて、特に変わったものはありません。以下がそのコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>callGoServer</span>(): List&lt;CallGoServerDto&gt; {
</span></span><span style=display:flex><span>    logger.info(<span style=color:#f1fa8c>&#34;[CallGoServer] start&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> tries.map {
</span></span><span style=display:flex><span>        logger.info(<span style=color:#f1fa8c>&#34;[CallGoServer] before request with id: </span><span style=color:#f1fa8c>$it</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>        goServerClient.call(<span style=color:#ff79c6>it</span>) <span style=color:#ff79c6>?:</span> CallGoServerDto(<span style=color:#ff79c6>it</span>, <span style=color:#f1fa8c>&#34;failed&#34;</span>) <span style=color:#6272a4>// GoのAPIを呼び出す
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        .also { result <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>            logger.info(<span style=color:#f1fa8c>&#34;[CallGoServer] after request with id: </span><span style=color:#f1fa8c>${result.id}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }.also {
</span></span><span style=display:flex><span>        logger.info(<span style=color:#f1fa8c>&#34;[CallGoServer] done&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Curlで実行してみた結果は以下の通りです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022-06-05 20:06:33.429  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022-06-05 20:06:33.430  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:38.483  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:38.483  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:43.490  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:43.491  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:48.498  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:48.499  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:53.509  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:53.510  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:58.518  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:06:58.518  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:03.530  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:03.531  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:08.538  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:08.539  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:13.552  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:13.553  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:18.561  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:18.562  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:23.570  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:07:23.570  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServer<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>こちらもGoの時と同じく、リクエストからレスポンスまで50秒ほどかかっているのがわかります。これをCoroutineを持って並列化していきましょう。</p><h4 id=coroutineで並列化する1>Coroutineで並列化する(1)</h4><p>Goと違って、KotlinのCoroutineは言語の基本仕様ではありません。なので、依存関係をまず追加する必要があります。ただ、公式の説明では<code>coroutine-core</code>だけを追加すると対応できそうなイメージですが、SpringのようにReactive Streamが必要な場合は<code>coroutine-reactor</code>を依存関係に追加する必要があります。</p><p>依存関係を追加した上で、コードを直していきます。ここではSpring Bootを使っていて、Controllerの関数を<code>suspend</code>にすることができるので、Contollerから呼び出している関数にもsuspendにしていきます。また、coroutineでの処理はスコープの指定が必要なのでループの周りを<a class=link href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html target=_blank rel=noopener>coroutineScope</a>で包むようにします。その後は<code>map</code>関数の中で<a class=link href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html target=_blank rel=noopener>async</a>としてAPIの呼び出しを行い、<code>map</code>した結果は<a class=link href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/index.html target=_blank rel=noopener>Deferred</a>として帰ってくるので<a class=link href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/await-all.html target=_blank rel=noopener>awaitAll</a>で終了を待ちます。説明では複雑ですが、以下のコードをみるとわかりやすいかなと思います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>callGoServerAsync</span>(): List&lt;CallGoServerDto&gt; {
</span></span><span style=display:flex><span>    logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsync] start&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> coroutineScope { <span style=color:#6272a4>// coroutineとして処理する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        tries.map {
</span></span><span style=display:flex><span>            async { <span style=color:#6272a4>// 並列に実行
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsync] before request with id: </span><span style=color:#f1fa8c>$it</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>                goServerClient.call(<span style=color:#ff79c6>it</span>) <span style=color:#ff79c6>?:</span> CallGoServerDto(<span style=color:#ff79c6>it</span>, <span style=color:#f1fa8c>&#34;failed&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }.awaitAll() <span style=color:#6272a4>// APIの呼び出し結果を待つ
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            .also {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>it</span>.forEach { result <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                    logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] after request with id: </span><span style=color:#f1fa8c>${result.id}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] done&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>また、APIを呼び出している関数(<code>goServerClient.call()</code>)もsuspendにしておく必要があります。ここではSpringの<a class=link href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html target=_blank rel=noopener>RestTemplate</a>を使い、以下のような関数を定義しておきました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> client = RestTemplate()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> header = HttpHeaders().apply {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>set</span>(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>call</span>(id: Int): CallGoServerDto? {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>val</span> request = HttpEntity(CallGoServerRequest(id), header)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> withContext(Dispatchers.IO) {
</span></span><span style=display:flex><span>        client.postForObject(<span style=color:#f1fa8c>&#34;http://localhost:8800/api/v1/some-process&#34;</span>, request, CallGoServerDto<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上記のようにコードを修正して実行してみると、Goの時と同じく並列で10件のリクエストが送られているのがわかります。ただ、違う点としてはgoroutineと違って実行の順番が保証されているというところですね。この特徴があるため、Kotlinの場合はレスポンスのソートが必要ないです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022-06-05 20:46:52.934  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022-06-05 20:46:52.939  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.939  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.939  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.940  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.940  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.940  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.941  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.941  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.941  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:52.941  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-1<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsync<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:46:57.951  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h4 id=coroutineで並列化する2>Coroutineで並列化する(2)</h4><p>上記のコードもGoの時と同じく、リクエストを同時に全部送っているのは問題になる可能性があるので、同時に送信するリクエストの数を制限することにします。Goでもそうであったように、KotlinでもCoroutineの同時実行の数を制限する仕組みがあります。<a class=link href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.sync/-semaphore/index.html target=_blank rel=noopener>Semaphore</a>というものです。</p><p>Sempaphoreに数値を指定し、asyncの中でSemaphoreに指定した数で実行数を制限することで並行実行数を制限するような形です。以下がそのコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>callGoServerAsyncDual</span>(): List&lt;CallGoServerDto&gt; {
</span></span><span style=display:flex><span>    logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] start&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>val</span> semaphore = Semaphore(<span style=color:#bd93f9>2</span>) <span style=color:#6272a4>// 同時実行数を制限するためのSempahoreの定義
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> coroutineScope {
</span></span><span style=display:flex><span>        tries.map {
</span></span><span style=display:flex><span>            async {
</span></span><span style=display:flex><span>                semaphore.withPermit { <span style=color:#6272a4>// asyncの同時実行数をSemaphoreに指定した数値に制限
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                    logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] before request with id: </span><span style=color:#f1fa8c>$it</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>                    goServerClient.call(<span style=color:#ff79c6>it</span>) <span style=color:#ff79c6>?:</span> CallGoServerDto(<span style=color:#ff79c6>it</span>, <span style=color:#f1fa8c>&#34;failed&#34;</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }.awaitAll()
</span></span><span style=display:flex><span>        .also {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>it</span>.forEach { result <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] after request with id: </span><span style=color:#f1fa8c>${result.id}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            logger.info(<span style=color:#f1fa8c>&#34;[CallGoServerAsyncDual] done&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>書き方が少し違うだけで、Goとほぼ同じ感覚でasyncの処理を制限できるコードが出来ました。特にコンパイルエラーが出ることはないので勘違いしやすいところではないかと思います。<code>async{ semaphore.withPermit{ } }</code>の順番をちゃんと守る必要がありますので注意しましょう。実行結果は以下の通りです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2022-06-05 20:50:50.361  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-6<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> start
</span></span><span style=display:flex><span>2022-06-05 20:50:50.365  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-6<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:50:50.366  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>nio-8900-exec-6<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:50:55.369  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:50:55.369  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:00.377  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:00.379  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:05.386  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:05.386  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:10.393  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-2<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:10.393  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> before request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.404  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.404  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> after request with id: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>2022-06-05 20:51:15.405  INFO <span style=color:#bd93f9>60551</span> --- <span style=color:#ff79c6>[</span>atcher-worker-8<span style=color:#ff79c6>]</span> c.e.c.d.service.CallGoServerService      : <span style=color:#ff79c6>[</span>CallGoServerAsyncDual<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>ログを吐く場所が微妙だったのですが、リクエストを送っている時間をみると、5秒置きで2つづつを送信しているのがわかります。</p><h2 id=最後に>最後に</h2><p>あまりCoroutineに詳しくないゆえ、もっと良い書き方はあったかなと思いますが(goroutineの実行順を決めておく、Kotlinのログ出力箇所を調整するなど)、これで簡単にAPIの呼び出しを並列化することができるというのがわかったので個人的にはかなり満足しています。Jetpack Composeを少し触りながらcoroutineに触れたことはあったものの、こうやって仕事で必要となり調査と検証をしてみたのは初めてだったのでかなりの収穫を得たと言えますね。また、各言語においての感想は以下の通りです。</p><ul><li>Go<ul><li>依存関係の追加なしで使えるのはメリット</li><li>Kotlinのようにsuspendやscopeを意識しなくていいので便利</li></ul></li><li>Kotlin<ul><li>asyncでも実行順が保証されているのはメリット</li><li>goroutineよりは注意点が多い</li></ul></li></ul><p>二つの言語を比べると一長一短があるという感覚ですが、どれも応用が難しいものではないので、すぐにプロダクションコードにも適用できそうなものが書けるのは確かに良いものという印象を受けました。これからもcoroutineを使って性能向上ができる箇所はないか、色々と試してみたくなるものです。</p><p>では、また！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/kotlin/>kotlin</a>
<a href=/tags/go/>go</a>
<a href=/tags/coroutine/>coroutine</a>
<a href=/tags/goroutine/>goroutine</a>
<a href=/tags/concurrency/>concurrency</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/languages-comparsion-sorting/><div class=article-image><img src=/../../images/magic.jpg loading=lazy data-key data-hash=/../../images/magic.jpg></div><div class=article-details><h2 class=article-title>色々な言語でやってみた（ソート編）</h2></div></a></article><article class=has-image><a href=/posts/kotlin-prospect/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>Kotlinのこれからを語る</h2></div></a></article><article class=has-image><a href=/posts/jvm-to-go/><div class=article-image><img src=/../../images/go.jpg loading=lazy data-key data-hash=/../../images/go.jpg></div><div class=article-details><h2 class=article-title>JVM言語経験者がGoを触る時のハマりどころ</h2></div></a></article><article class=has-image><a href=/posts/rust-first-impression/><div class=article-image><img src=/../../images/rust.jpg loading=lazy data-key data-hash=/../../images/rust.jpg></div><div class=article-details><h2 class=article-title>Kotlinプログラマが見たRust</h2></div></a></article><article class=has-image><a href=/posts/go-first-impression/><div class=article-image><img src=/../../images/go.jpg loading=lazy data-key data-hash=/../../images/go.jpg></div><div class=article-details><h2 class=article-title>JavaプログラマーがみたGo</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2022 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#apiの呼び出しを並列化する>APIの呼び出しを並列化する</a></li><li><a href=#実装してみる>実装してみる</a><ol><li><a href=#go>Go</a><ol><li><a href=#goroutineで並列化する1>Goroutineで並列化する(1)</a></li><li><a href=#goroutineで並列化する2>Goroutineで並列化する(2)</a></li></ol></li><li><a href=#kotlin>Kotlin</a><ol><li><a href=#coroutineで並列化する1>Coroutineで並列化する(1)</a></li><li><a href=#coroutineで並列化する2>Coroutineで並列化する(2)</a></li></ol></li></ol></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>