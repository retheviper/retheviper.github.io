<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="こないだはGoに関するポストを作成しましたが、やはり本業はKotlinなので、Kotlinに関しても何かわかったことや閃いたことなどあれば、"><title>Kotlinで書いてみた〜その一〜</title>
<link rel=canonical href=https://retheviper.github.io/posts/kotlin-code-in-my-style-1/>
<link rel=stylesheet href=/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css><meta property="og:title" content="Kotlinで書いてみた〜その一〜">
<meta property="og:description" content="こないだはGoに関するポストを作成しましたが、やはり本業はKotlinなので、Kotlinに関しても何かわかったことや閃いたことなどあれば、">
<meta property="og:url" content="https://retheviper.github.io/posts/kotlin-code-in-my-style-1/">
<meta property="og:site_name" content="Korean-man in Tokyo">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="kotlin"><meta property="article:tag" content="java"><meta property="article:published_time" content="2021-03-28T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-28T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/kotlin.jpg">
<meta name=twitter:title content="Kotlinで書いてみた〜その一〜">
<meta name=twitter:description content="こないだはGoに関するポストを作成しましたが、やはり本業はKotlinなので、Kotlinに関しても何かわかったことや閃いたことなどあれば、"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://retheviper.github.io/images/kotlin.jpg">
<link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png>
<link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png>
<link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png>
<link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png>
<link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png>
<link rel=manifest href=/favicon/manifest.json>
<meta name=msapplication-TileColor content="#ffffff">
<meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png">
<meta name=theme-color content="#ffffff">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-139986442-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/posts/kotlin-code-in-my-style-1/>
<img src=/../../images/kotlin.jpg loading=lazy alt="Featured image of post Kotlinで書いてみた〜その一〜">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/categories/kotlin/ style=background-color:#2a9d8f;color:#fff>
kotlin
</a>
</header>
<h2 class=article-title>
<a href=/posts/kotlin-code-in-my-style-1/>Kotlinで書いてみた〜その一〜</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 28, 2021</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
8 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>こないだはGoに関するポストを作成しましたが、やはり本業はKotlinなので、Kotlinに関しても何かわかったことや閃いたことなどあれば、順次に書いていこうと思っています。今回はKotlinでAPIを作りながら、業務での要件をどんなコードで満たしたかを簡単に説明させていただきたいと思います。</p>
<p>サーバサイドエンジニアをやっていると、要求される機能を以下に実現している方法がどんなものあれ(GraphQL、REST API、マイクロサービスみたいな技術やアーキテクチャの観点の以前の話として)、業務としてはある程度パターン化しているように感じることがあります。こういう場合には、コードよりもロジックが大事であるかのように見える場合もありますね。でも逆に、むしろ似たようなロジックが多いので、より良いコードを書くために工夫できる余地もまた多いのではないか、とも思います。</p>
<p>正直自分はアルゴリズムに強いわけでもないので、効率的なコードを書くとしたら限界はあるだろうなという気はしています。とりあえず動くコードを書いて、それをリファクタリングしながら少しづつ整える感じのことしかできないのかも知れません。</p>
<p>しかし、そんな自分にも良いコードを書くためにできることが全くないわけでもないと思います。例えば、Javaでコードを書くときは、参照の問題などからなるべく<code>final</code>をつけてオブジェクトを<a class=link href=https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%96%E3%83%AB target=_blank rel=noopener>immutable</a>にするようにと教わりましたが、実際は<a class=link href="https://www.baeldung.com/java-final-performance?__s=m4suw1p9x2sbizbhxrew" target=_blank rel=noopener>ベンチマークで比較した結果</a>でもわかるように、性能の改善にも繋がっています。また、JavaでもKotlinでも色々と便利なAPIを提供していて、バージョンアップの度にまた新しいAPIが追加されるので、それらの用途と使い方をよく理解した上で、積極的に使用するだけでも読みやすく、性能も良いコードを書くことができます。</p>
<p>ということで、今回はKotlinのAPIを使って書いていたコードを一部紹介したいと思います。</p>
<h2 id=リストのグループ化>リストのグループ化</h2>
<p>DBに商品情報テーブルがあって、さらに商品属性テーブル、生産地や販売店テーブルなどがある場合に、業務によっては「販売店ごとにどんな商品が販売されているかを確認したい」とか、「特定の商品属性に当てはまる商品だけみたい」とかのケースがあるはずですね。</p>
<p>そういった場合、APIとしてはテーブルから取得したデータを、特定のカラムを基準にまとめたもの返す必要があります。これをコードに書くとしたら<code>List</code>で取得したデータを、中の一つの属性をキーに<code>Map</code>にまとめて返すということになりますね。Javaだと、以下のような形になるかと思います。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// DBのデータの例
</span><span class=c1></span><span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>list</span> <span class=o>=</span> <span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span>
        <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=s>&#34;John&#34;</span><span class=o>,</span> <span class=n>20</span><span class=o>,</span> <span class=s>&#34;USA&#34;</span><span class=o>,</span> <span class=s>&#34;Programmer&#34;</span><span class=o>),</span>
        <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=s>&#34;James&#34;</span><span class=o>,</span> <span class=n>30</span><span class=o>,</span> <span class=s>&#34;Canada&#34;</span><span class=o>,</span> <span class=s>&#34;Sales&#34;</span><span class=o>),</span>
        <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=s>&#34;Jack&#34;</span><span class=o>,</span> <span class=n>35</span><span class=o>,</span> <span class=s>&#34;UK&#34;</span><span class=o>,</span> <span class=s>&#34;Programmer&#34;</span><span class=o>)</span>
<span class=o>);</span>
<span class=c1>// UserのJobを基準にまとめる
</span><span class=c1></span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Pair</span><span class=o>&gt;&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=n>list</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
        <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>groupingBy</span><span class=o>(</span><span class=n>User</span><span class=o>::</span><span class=n>getJob</span><span class=o>,</span>
                <span class=n>Collectors</span><span class=o>.</span><span class=na>mapping</span><span class=o>(</span><span class=n>user</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Pair</span><span class=o>(</span><span class=n>user</span><span class=o>.</span><span class=na>getAge</span><span class=o>(),</span> <span class=n>user</span><span class=o>.</span><span class=na>getName</span><span class=o>()),</span> <span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>())));</span>
<span class=c1>// {James=[Pair(first=30, second=Sales)], John=[Pair(first=20, second=Programmer), Pair(first=35, second=Writer)]}
</span><span class=c1></span>
<span class=nd>@Data</span>
<span class=nd>@AllArgsConstructor</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>User</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>age</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>address</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>job</span><span class=o>;</span>
<span class=o>}</span>

<span class=nd>@Data</span>
<span class=nd>@AllArgsConstructor</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>Pair</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=n>Object</span> <span class=n>first</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>Object</span> <span class=n>second</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>KotlinでもJavaのAPIをそのまま使うことができるので、上記の<code>Stream</code>と<code>Collector</code>を使って同じことはできます。ただ、せっかく違う言語と使っているわけなので、できればKotlinが提供するAPIを活用して同じことをしたいものです。</p>
<p>KotlinはCollectionで提供する機能だけでも<code>Stream</code>と<code>Collector</code>を組み合わせたものと似たような処理ができる場合が多いので、JavaのAPIに対応した機能があるかどうかを探すだけで事足りるケースが多いです。ということは、上記の処理でキモになっている<code>Collectors.groupingBy()</code>と<code>Collectors.mapping()</code>と似たようなものがあればいいというわけですが、<code>groupBy()</code>でそれらの処理をまとめることができます。なので、上記のコードをKotlinで変えると、以下のようになります。色々とスッキリしますね。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=c1>// DBデータの例
</span><span class=c1></span><span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;John&#34;</span><span class=p>,</span> <span class=m>20</span><span class=p>,</span> <span class=s2>&#34;USA&#34;</span><span class=p>,</span> <span class=s2>&#34;Programmer&#34;</span><span class=p>),</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;James&#34;</span><span class=p>,</span> <span class=m>30</span><span class=p>,</span> <span class=s2>&#34;Canada&#34;</span><span class=p>,</span> <span class=s2>&#34;Sales&#34;</span><span class=p>),</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;Jack&#34;</span><span class=p>,</span> <span class=m>35</span><span class=p>,</span> <span class=s2>&#34;UK&#34;</span><span class=p>,</span> <span class=s2>&#34;Programmer&#34;</span><span class=p>)</span>
  <span class=p>)</span>
<span class=c1>// Jobを基準にMap&lt;String, List&lt;Pair&lt;Int, String&gt;&gt;&gt;にまとめる
</span><span class=c1></span><span class=k>val</span> <span class=py>map</span> <span class=p>=</span> <span class=n>list</span><span class=p>.</span><span class=n>groupBy</span><span class=p>({</span> <span class=k>it</span><span class=p>.</span><span class=n>job</span> <span class=p>},</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>age</span> <span class=n>to</span> <span class=k>it</span><span class=p>.</span><span class=n>name</span> <span class=p>})</span>
<span class=c1>// {Programmer=[(20, John), (35, Jack)], Sales=[(30, James)]}
</span><span class=c1></span>
<span class=k>data</span> <span class=k>class</span> <span class=nc>User</span><span class=p>(</span>
    <span class=k>val</span> <span class=py>name</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
    <span class=k>val</span> <span class=py>age</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
    <span class=k>val</span> <span class=py>address</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
    <span class=k>val</span> <span class=py>job</span><span class=p>:</span> <span class=n>String</span>
<span class=p>)</span>
</code></pre></div><h2 id=mapのvalueだけを変える>Mapのvalueだけを変える</h2>
<p>上記の処理に加えて、もっと条件がつく場合もあるかと思います。例えば、金額計算とかの例があるとします。従業員が案件ごとに賃金をもらうということになっていて、案件はコードで管理されている場合、賃金を払う側としては同じ案件に対しては合算した金額のみが知りたいとかのケースもあるでしょう。こういう場合には、従業員ごとにデータをまとめた上で、さらにその人が担当した案件のリスト野中で重複するものがあれば、金額だけを合算するようにする必要がありますね。</p>
<p>こういう場合は、グルーピングの段階からそういう処理を入れるのがもっとも効率的ではあるとは思いますが、スレッドの問題もあるので(生成中のMapの中を巡回するという)、実際のコードに書くとするとかなり複雑になる可能性もあります。なのでここではまず、<code>List</code>を<code>Map</code>にまとめた結果を持ってさらに処理を加えるという形を取ります。</p>
<p>Kotlinの<code>Map</code>には、<code>map()</code>以外にも<code>mapKeys()</code>や<code>mapValues()</code>のような関数があって、必要な部分だけをマッピングできます。今回は<code>value</code>だけを変えたいので、<code>mapValues()</code>を使った方が無駄がなく、コードを読む側としても意図が明確になって良いと思います。<code>mapValues()</code>を使ってさらにマッピングを行うコードは、以下のようになります。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>data</span> <span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=k>val</span> <span class=py>name</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=k>val</span> <span class=py>id</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span> <span class=k>val</span> <span class=py>amount</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span>

<span class=c1>// DBデータの例
</span><span class=c1></span><span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>1000</span><span class=p>),</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>2000</span><span class=p>),</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4000</span><span class=p>),</span>
    <span class=n>User</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>5000</span><span class=p>)</span>
<span class=p>)</span>
<span class=c1>// nameでまとめた後、重複するidを一つにまとめる(amountを合算)
</span><span class=c1></span><span class=k>val</span> <span class=py>map</span> <span class=p>=</span> <span class=n>list</span><span class=p>.</span><span class=n>groupBy</span><span class=p>({</span> <span class=k>it</span><span class=p>.</span><span class=n>name</span> <span class=p>},</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>id</span> <span class=n>to</span> <span class=k>it</span><span class=p>.</span><span class=n>amount</span> <span class=p>})</span>
    <span class=p>.</span><span class=n>mapValues</span> <span class=p>{</span>
        <span class=c1>// idでグルーピング
</span><span class=c1></span>        <span class=k>it</span><span class=p>.</span><span class=n>value</span><span class=p>.</span><span class=n>groupBy</span> <span class=p>{</span> <span class=n>pair</span> <span class=o>-&gt;</span> <span class=n>pair</span><span class=p>.</span><span class=n>first</span> <span class=p>}</span>
        <span class=c1>// keyはそのまま、valueだけを合算する
</span><span class=c1></span>            <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>map</span> <span class=o>-&gt;</span> <span class=n>map</span><span class=p>.</span><span class=n>key</span> <span class=n>to</span> <span class=n>map</span><span class=p>.</span><span class=n>value</span><span class=p>.</span><span class=n>sumBy</span> <span class=p>{</span> <span class=n>pair</span> <span class=o>-&gt;</span> <span class=n>pair</span><span class=p>.</span><span class=n>second</span> <span class=p>}</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=c1>// {A=[(1, 3000), (2, 4000)], B=[(3, 5000)]}
</span></code></pre></div><p><code>List</code>を<code>Map</code>にまとめるもう一つの方法は、<code>groupingBy()</code>があります。この関数を使うと、Collectionが<a class=link href=https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/-grouping target=_blank rel=noopener>Grouping</a>というオブジェクトに変わって、<code>aggregate()</code>・<code>reduce()</code>・<code>fold()</code>・<code>eachCount()</code>のような関数を使うことで後続の処理ができます。上記のコードを<code>Grouping</code>を使ったものに変えるとしたら、以下のようになります。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=c1>// Groupingのaggregateを利用してMapに変えた後から、valueの処理を行う
</span><span class=c1></span><span class=k>val</span> <span class=py>map</span> <span class=p>=</span> <span class=n>list</span><span class=p>.</span><span class=n>groupingBy</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>name</span> <span class=p>}</span>
    <span class=p>.</span><span class=n>aggregate</span> <span class=p>{</span> <span class=n>_</span><span class=p>,</span> <span class=n>accumulator</span><span class=p>:</span> <span class=n>MutableList</span><span class=p>&lt;</span><span class=n>Pair</span><span class=p>&lt;</span><span class=n>Int</span><span class=p>,</span> <span class=n>Int</span><span class=p>&gt;&gt;?,</span> <span class=n>element</span><span class=p>,</span> <span class=n>first</span> <span class=o>-&gt;</span>
        <span class=c1>// 新しいキーなら、MutableListを作る
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>first</span><span class=p>)</span>
            <span class=n>mutableListOf</span><span class=p>(</span><span class=n>element</span><span class=p>.</span><span class=n>id</span> <span class=n>to</span> <span class=n>element</span><span class=p>.</span><span class=n>amount</span><span class=p>)</span>
        <span class=c1>// そうではない場合は、存在するListに要素を追加する
</span><span class=c1></span>        <span class=k>else</span>
            <span class=n>accumulator</span><span class=o>?.</span><span class=n>apply</span> <span class=p>{</span> <span class=n>add</span><span class=p>(</span><span class=n>element</span><span class=p>.</span><span class=n>id</span> <span class=n>to</span> <span class=n>element</span><span class=p>.</span><span class=n>amount</span><span class=p>)</span> <span class=p>}</span>
    <span class=p>}.</span><span class=n>mapValues</span> <span class=p>{</span>
        <span class=k>it</span><span class=p>.</span><span class=n>value</span><span class=o>?.</span><span class=n>groupBy</span> <span class=p>{</span> <span class=n>pair</span> <span class=o>-&gt;</span> <span class=n>pair</span><span class=p>.</span><span class=n>first</span> <span class=p>}</span>
            <span class=o>?.</span><span class=n>map</span> <span class=p>{</span> <span class=n>pair</span> <span class=o>-&gt;</span> <span class=n>pair</span><span class=p>.</span><span class=n>key</span> <span class=n>to</span> <span class=n>pair</span><span class=p>.</span><span class=n>value</span><span class=p>.</span><span class=n>sumBy</span> <span class=p>{</span> <span class=n>pair</span> <span class=o>-&gt;</span> <span class=n>pair</span><span class=p>.</span><span class=n>second</span> <span class=p>}</span> <span class=p>}</span>
    <span class=p>}</span>
</code></pre></div><p>一見、<code>groupingBy()</code>の方が複雑にも見えますが、<code>accumulator</code>を使ってマッピングした値を積み重ねることができるので、場合によっては考慮する価値があるかもですね。</p>
<h2 id=mapを使ったキャッシュ>Mapを使ったキャッシュ</h2>
<p>DBの参照が頻繁であり、なお参照されるデータそのものは更新される頻度が高くない場合は、アプリケーション内にキャッシュして置くのが良いケースもたまにありますね。こういう場合には、パラメータをキーとして持つ<code>Map</code>を宣言しておいて、そのキーがない場合だけDBにアクセスする(そして<code>Map</code>に追加する)という形にすれば良いでしょう。Javaでは1.8から<code>computeIfAbsent()</code>というメソッドを提供しているので、簡単に実装ができます。例えば以下のようになります。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// DBデータの例
</span><span class=c1></span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>list</span> <span class=o>=</span> <span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;A&#34;</span><span class=o>,</span> <span class=s>&#34;B&#34;</span><span class=o>,</span> <span class=s>&#34;C&#34;</span><span class=o>);</span>
<span class=c1>// キャッシュのMap
</span><span class=c1></span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
<span class=c1>// パラメータ
</span><span class=c1></span><span class=n>String</span> <span class=n>element</span> <span class=o>=</span> <span class=s>&#34;A&#34;</span><span class=o>;</span>

<span class=c1>// キャッシュにパラメータがない場合はDBデータを参照して、追加した後に返す
</span><span class=c1></span><span class=n>Boolean</span> <span class=n>exists</span> <span class=o>=</span> <span class=n>map</span><span class=o>.</span><span class=na>computeIfAbsent</span><span class=o>(</span><span class=n>element</span><span class=o>,</span> <span class=n>key</span> <span class=o>-&gt;</span> <span class=n>list</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>element</span><span class=o>));</span>
<span class=c1>// Method Referenceを使った例
</span><span class=c1></span><span class=n>exists</span> <span class=o>=</span> <span class=n>map</span><span class=o>.</span><span class=na>computeIfAbsent</span><span class=o>(</span><span class=n>element</span><span class=o>,</span> <span class=n>list</span><span class=o>::</span><span class=n>contains</span><span class=o>);</span>
</code></pre></div><p>Javaで提供する機能なので、もちろんKotlinでも全く同じ形で実装できます。ただ、Kotlinの仕様上<code>compute</code>のコードが<a class=link href=https://kotlinlang.org/docs/lambdas.html#instantiating-a-function-type target=_blank rel=noopener>LambdaかMethod Referenceかによって書き方が違う</a>ので、そこだけ注意する必要があります。これはKotlin自体の仕様によるものですが、Javaの書き方に慣れていると最初はなかなかわかりにくいところかも知れません。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=c1>// DBデータの例
</span><span class=c1></span><span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>,</span> <span class=s2>&#34;C&#34;</span><span class=p>)</span>
<span class=c1>// キャッシュのMap
</span><span class=c1></span><span class=k>val</span> <span class=py>map</span> <span class=p>=</span> <span class=n>ConcurrentHashMap</span><span class=p>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Boolean</span><span class=p>&gt;()</span>
<span class=c1>// パラメータ
</span><span class=c1></span><span class=k>val</span> <span class=py>element</span> <span class=p>=</span> <span class=s2>&#34;A&#34;</span>

<span class=c1>// Lambdaの場合
</span><span class=c1></span><span class=k>var</span> <span class=py>exists</span> <span class=p>=</span> <span class=n>map</span><span class=p>.</span><span class=n>computeIfAbsent</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=p>{</span> <span class=n>list</span><span class=p>.</span><span class=n>contains</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=p>}</span> <span class=c1>// false
</span><span class=c1>// Method Referenceの場合
</span><span class=c1></span><span class=n>exists</span> <span class=p>=</span> <span class=n>map</span><span class=p>.</span><span class=n>computeIfAbsent</span><span class=p>(</span><span class=n>element</span><span class=p>,</span> <span class=n>list</span><span class=o>::</span><span class=n>contains</span><span class=p>)</span>
</code></pre></div><p>ちなみに、似たような機能をするメソッドとして<code>putIfAbsent()</code>がありますが、<code>computIfAbsent()</code>の場合<code>Map</code>にキーがなかった場合にだけ後続の処理が行われるに対して、<code>putIfAbsent()</code>はキーがあるかないかに関係なく処理が走ってしまうという違いがあるらしいです。なのでキャッシュとして使う場合は、<code>computeIfAbsent()</code>を使った方が良いでしょう。</p>
<h2 id=最後に>最後に</h2>
<p>自分が書いたコードをいくつか紹介しましたが、いかがだったでしょうか。まだKotlinに移行したばかりなので色々とわからないことが多く、本当はもっとスマートな方法があるのかも知れませんが、自分的には、こうやって実際の業務の要件に合わせて違う言語とコードを比べながら、APIのソースをみたりで自分なりにどうやって書くかを考えてみるのは意味のあることで、楽しいとも思います。</p>
<p>というわけで、これからもKotlinでの書き方に対する研究はこれからも続きます。そろそろGoでも簡単なAPIでも作ってみたりで勉強をしないとやばそうな気もしていますが…まぁ、なんとかなるでしょう。</p>
<p>では、また！</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/kotlin/>kotlin</a>
<a href=/tags/java/>java</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/posts/kotlin-japanese-era/>
<div class=article-image>
<img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Kotlinで和暦を使う</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/kotlin-hidden-cost-3/>
<div class=article-image>
<img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Kotlinの隠されたコストーその３</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/kotlin-hidden-cost-2/>
<div class=article-image>
<img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Kotlinの隠されたコストーその２</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/kotlin-hidden-cost-1/>
<div class=article-image>
<img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Kotlinの隠されたコストーその１</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/kotlin-code-in-my-style-3/>
<div class=article-image>
<img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Kotlinで書いてみた〜その三〜</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2019 -
2022 Korean-man in Tokyo
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#リストのグループ化>リストのグループ化</a></li>
<li><a href=#mapのvalueだけを変える>Mapのvalueだけを変える</a></li>
<li><a href=#mapを使ったキャッシュ>Mapを使ったキャッシュ</a></li>
<li><a href=#最後に>最後に</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>