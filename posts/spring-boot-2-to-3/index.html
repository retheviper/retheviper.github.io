<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Spring Boot 2 (Spring Framework 5) から Spring Boot 3 (Spring Framework 6) にアップデートしてみました。 Java 17 仕事でJavaを使っていたごろは、Java 17をずっと待っていました。以前こちら"><title>Spring Boot 3を導入してみた</title><link rel=canonical href=https://retheviper.github.io/posts/spring-boot-2-to-3/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Spring Boot 3を導入してみた"><meta property="og:description" content="Spring Boot 2 (Spring Framework 5) から Spring Boot 3 (Spring Framework 6) にアップデートしてみました。 Java 17 仕事でJavaを使っていたごろは、Java 17をずっと待っていました。以前こちら"><meta property="og:url" content="https://retheviper.github.io/posts/spring-boot-2-to-3/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="kotlin"><meta property="article:tag" content="java"><meta property="article:tag" content="spring"><meta property="article:published_time" content="2023-01-29T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-29T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/spring.jpg"><meta name=twitter:title content="Spring Boot 3を導入してみた"><meta name=twitter:description content="Spring Boot 2 (Spring Framework 5) から Spring Boot 3 (Spring Framework 6) にアップデートしてみました。 Java 17 仕事でJavaを使っていたごろは、Java 17をずっと待っていました。以前こちら"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/spring.jpg"><link rel="shortcut icon" href=true><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BYJBEJB6DX",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu768313a802c015f07dded3abd3d4245d_264018_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>👋</span></figure><div class=site-meta><h1 class=site-name><a href=/>Korean-man in Tokyo</a></h1><h2 class=site-description>一人前になりたいです</h2></div></header><ol class=social-menu><li><a href=https://www.credly.com/users/youngbin-kim.6d7122f1/badges target=_blank title=Certificates rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-certificate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="15" cy="15" r="3"/><path d="M13 17.5V22l2-1.5 2 1.5v-4.5"/><path d="M10 19H5a2 2 0 01-2-2V7c0-1.1.9-2 2-2h14a2 2 0 012 2v10a2 2 0 01-1 1.73"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="12" x2="9" y2="12"/><line x1="6" y1="15" x2="8" y2="15"/></svg></a></li><li><a href=https://github.com/retheviper target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/%E8%8B%B1%E6%96%8C-%E9%87%91-6736ba194/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://retheviper.github.io/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#java-17>Java 17</a><ol><li><a href=#record>Record</a></li><li><a href=#docker-image>Docker Image</a></li><li><a href=#依存関係>依存関係</a></li></ol></li><li><a href=#spring-boot-3>Spring Boot 3</a><ol><li><a href=#constructorbinding>@ConstructorBinding</a></li><li><a href=#tracingの変更>Tracingの変更</a></li><li><a href=#jakarta-ee>Jakarta EE</a></li><li><a href=#springdoc>springdoc</a></li><li><a href=#liquibase>Liquibase</a></li></ol></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/spring-boot-2-to-3/><img src=/../../images/spring.jpg loading=lazy alt="Featured image of post Spring Boot 3を導入してみた"></a></div><div class=article-details><header class=article-category><a href=/categories/spring/ style=background-color:#2a9d8f;color:#fff>spring</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/spring-boot-2-to-3/>Spring Boot 3を導入してみた</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 29, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><p>Spring Boot 2 (Spring Framework 5) から Spring Boot 3 (Spring Framework 6) にアップデートしてみました。</p><h2 id=java-17>Java 17</h2><p>仕事でJavaを使っていたごろは、Java 17をずっと待っていました。以前こちらのブログの記事として整理したこともありましたがテキストブロックやSwitchを式で使えるなど便利な機能がたくさん追加されたためです。しかし、Kotlinを使っている今は機能や言語仕の観点からJavaのバージョンを機にする必要はありません。なので、既存のアプリケーションがJava 11で動いているのであれば、Java 17に上げるモチベーションはあまりないように見えるかもしれません。</p><p>それでもあえてバージョンを上げようとした理由は、まずサポート期間が今年の9月で終わるからということになります。正確にはJava 11のPremier Supportが2023年9月で終わり、それに準するExtended Supportは2026年9月までということになります。ただ、「準する」という表現が曖昧で、11は今の時点ではもうだいぶ古く、17もリリースから1年以上の期間の間に十分検証されていると判断しました。</p><p>サポート期間の話だけだと、まだ終了まで半年以上の時間が残っているのですが、このタイミングで行うのは会社で「リファクタ期間」というものを設けているためです。この期間中は主に技術負債の解消や依存関係のバージョンアップなどを重点的に行うので、新しい機能の開発とバージョンアップが重なり問題が起こるような事項は避けたいと思いました。</p><p>そのほかでも、新しいJavaのバージョンを採用することでパフォーマンスの向上を図ることができる点があります。例えば、<a class=link href=https://www.optaplanner.org/blog/2021/09/15/HowMuchFasterIsJava17.html target=_blank rel=noopener>Java 11よりGCの性能が改善されていたり</a>、状況によって<a class=link href=https://malloc.se/blog/zgc-jdk17 target=_blank rel=noopener>ZGCの導入を考慮できる</a>オプションができたりです。Javaのバージョンが上がるということは、JVMの改善を含むということになるので、Kotlinでも十分その恩義を受けられることになるでしょう。</p><p>なので、Java 17を採用することで決め、以降時の経験に関して共有したいと思います。</p><h3 id=record>Record</h3><p>社内ではORMとして<a class=link href=https://www.jooq.org/ target=_blank rel=noopener>jOOQ</a>を採用していて、これから自動生成されたテーブル定義のコードをKotlinのコード(Repository)で呼び出す構造となっています。ただ、場合によってはこの自動生成のコードによりJava 17でのコンパイルが失敗することがあります。今回の場合は、以下のようなエラーメッセージと共にコンパイルが失敗するのを確認できました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>エラー: Recordの参照はあいまいです
</span></span><span style=display:flex><span>    public &lt;O extends Record&gt; SomeTable(Table&lt;O&gt; child, ForeignKey&lt;O, SomeRecord&gt; key) {
</span></span><span style=display:flex><span>                      ^
</span></span><span style=display:flex><span>  org.jooqのインタフェース org.jooq.Recordとjava.langのクラス java.lang.Recordの両方が一致します
</span></span></code></pre></div><p>これはjOOQに<a class=link href=https://www.jooq.org/javadoc/latest/org.jooq/org/jooq/Record.html target=_blank rel=noopener>Record</a>というクラスが存在していて、自動生成のコードでそれを利用しているためです。Java 14以降Lombokの<a class=link href=https://projectlombok.org/features/Value target=_blank rel=noopener>@Value</a>と似た機能を持つ<a class=link href=https://docs.oracle.com/en/java/javase/15/language/records.html target=_blank rel=noopener>Record Class</a>が登場していて、<code>record</code>キーワードを使って定義したクラスは全て<a class=link href=https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Record.html target=_blank rel=noopener>java.lang.Record</a>を実装する形になっています。というわけで、「jOOQのRecordを意味するのか、JavaのRecordを意味するのかコンパイラが判断できない」とエラーが発生してしまうのです。</p><p>これは、既存の自動生成コードのインポートを修正するだけで回避できます。既存のコードだと、自動生成のコードでは以下のようにjOOQのクラスをインポートしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.jooq.*<span style=color:#f92672>;</span>
</span></span></code></pre></div><p>これを、明確にjOOQのRecordを指定するように修正します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.jooq.Record<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.jooq.*<span style=color:#f92672>;</span>
</span></span></code></pre></div><p>以上で問題なくコンパイルが通るようになりました。もし自作のライブラリなどで<code>Record</code>というクラスを定義している場合はここと同じエラーになる可能性があるので、なるべくクラスの名前を変えた方が良いかもです。</p><h3 id=docker-image>Docker Image</h3><p>現在開発中のサービスは<a class=link href=https://github.com/GoogleContainerTools/jib target=_blank rel=noopener>Jib</a>を使ってコンテナ化しています。ここでベースとなるイメージの指定が必要なのですが、既存で使っていたイメージはOpenJDKの<a class=link href="https://hub.docker.com/layers/library/openjdk/11-jre/images/sha256-762d8d035c3b1c98d30c5385f394f4d762302ba9ee8e0da8c93344c688d160b2?context=explore" target=_blank rel=noopener>11-jre</a>でした。これが17からはJREのみのイメージはなく、<a class=link href="https://hub.docker.com/layers/library/openjdk/17-jdk/images/sha256-98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13?context=explore" target=_blank rel=noopener>17-jdk</a>のみとなったので、バージョンをあげる際は注意する必要があります。</p><p>ただ、OpenJDK以外のイメージ意外を使っている場合は状況が違うかもしれませんので確認が必要です。例えば、<a class=link href="https://hub.docker.com/layers/library/eclipse-temurin/17-jre/images/sha256-402c656f078bc116a6db1e2e23b08c6f4a78920a2c804ea4c2d3e197f1d6b47c?context=explore" target=_blank rel=noopener>Temurin</a>や<a class=link href="https://hub.docker.com/layers/azul/zulu-openjdk/17-jre/images/sha256-09163c13aefbe5e0aa3dc7910d9997e416031e777ca0c50bd9b66a63b46be481?context=explore" target=_blank rel=noopener>Zulu</a>は<code>17-jre</code>を提供していて、Libericaの場合は<a class=link href="https://hub.docker.com/layers/bellsoft/liberica-openjdk-alpine/17/images/sha256-50feb980f142b152e19c9dc25c835e0e451321eb3b837a3a924f457b11ce8c59?context=explore" target=_blank rel=noopener>17</a>とバージョンだけになっているなど使っているJDKの種類によってタグ名が違うので、JDKのバージョンアップの際には使っているイメージのタグはチェックしておく方が良いでしょう。</p><h3 id=依存関係>依存関係</h3><p>自分の担当しているアプリで発生していた問題ではないのですが(マイクロサービスとして、Kotlinのサービスは複数あります)、一部でJavaのバージョンを11から17に上げた際に<a class=link href=https://github.com/TIBCOSoftware/jasperreports target=_blank rel=noopener>Jasperreports</a>を使った帳票の出力で報告された問題がありました。このライブラリはPDFの出力のために利用しているのですが、レイアウトに問題はなかったものの、表の中の表示文字数が少し減ったという問題がありました。幸い、これは大きい問題ではなかったのでまずは対応なしとなりそうですが場合によっては致命的かもしれません。</p><p>おそらくこのような問題が発生したら、依存しているライブラリのバージョンをJava 17に対応したものにあげれば解消できるのではないかと思いますが、まだ17に対応していないライブラリがある可能性もあるので、事前に依存関係の方をチェックしておいた方が胃良いでしょう。</p><h2 id=spring-boot-3>Spring Boot 3</h2><p>Java 17は今年に11のサポートが終了するということで必須としていましたが、Spring Boot 3(Spring Framework 6)の場合は去年の12月にリリースされたばかりなので今回はあえて移行を試す必要はありませんでした。ただ、Spring Boot 3からちょうどJava 17が最低バージョンになり、以前からサーバレスの<a class=link href=https://ja.wikipedia.org/wiki/Google_App_Engine target=_blank rel=noopener>GAE</a>上で起動しているプロジェクトもあったので、起動時間を減らすために<a class=link href=https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html target=_blank rel=noopener>Spring Native</a>を試してみたいと思っていたためでもあります。Spring NativeはSpring Boot 3から正式にサポートされることになったので。</p><p>また、Spring Boot 3で依存関係が変わったり、プロパティの記述方法が変わったりするケースがあるとしても、自分が扱っているアプリケーションはマイクロサービスなので比較的に影響が少ないと予測できたからです。おそらくモノリシックで、Springの様々な機能に依存している場合は移行が難しい場合もあるかなと思います。なので、もし移行を考えている場合はなるべくリリースノートなどを確認しておいた方が良いでしょう。</p><p>Spring Boot 2系から3系の移行は、基本的に<a class=link href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide target=_blank rel=noopener>公式のマイグレーションガイド</a>を参照すると良いのですが、マイグレーションガイドだけではわからないことや、Spring Frameworkの依存関係の変化により他のライブラリに影響が出ることがあります。なので自分の場合はどのように対応したかを少し紹介したいと思います。</p><h3 id=constructorbinding>@ConstructorBinding</h3><p><a class=link href=https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/ConstructorBinding.html target=_blank rel=noopener>@ConstructorBinding</a>は、<a class=link href=https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html target=_blank rel=noopener>@ConfigurationProperties</a>を付けたクラスにアプリケーションプロパティファイルから読み込んだ値をコンストラクタインジェクションするためのアノテーションです。現在のプロジェクトではAWSのS3のバケット名やメールのテンプレート、他のAPIを呼び出すためのエンドポイントなどを<code>application.yaml</code>に記載して読み込むようにしています。</p><p>ここで、Spring Boot 3だと<code>@ConstructorBinding</code>なしでもプロパティを読み込むようになって、そもそもこのアノテーション自体がDeprecatedになっています。なので、最初はコンパイルエラーとなりますが、<code>@ConstructorBinding</code>を削除するだけで問題なく動作するようになりました。最も簡単な対応でした。</p><h3 id=tracingの変更>Tracingの変更</h3><p>現在のアプリケーションでは、他のマイクロサービスのAPIを呼び出す際に<a class=link href=https://github.com/openzipkin/brave target=_blank rel=noopener>Brave</a>を使ってヘッダに<code>Trace Context</code>を載せています。この場合、同じTrace IDが連携されるのでログの確認がやりやすくなりますね。今までは<a class=link href=https://spring.io/projects/spring-cloud-sleuth target=_blank rel=noopener>Spring Cloud Sleuth</a>を通じてBraveをDIしていましたが、これがSpring Boot 3になくなり(Spring Bootに統合）、<a class=link href=https://micrometer.io/ target=_blank rel=noopener>Micrometer</a>の新しいAPIを利用することになったらしいです。</p><p>つまり、既存のSpring Cloud SleuthによるDIは使えなくなり、依存関係も変化があるということです。まずは、DIを担当していた<a class=link href=https://docs.spring.io/spring-boot/docs/3.0.1/api/org/springframework/boot/actuate/autoconfigure/tracing/BraveAutoConfiguration.html target=_blank rel=noopener>BraveAutoConfiguration</a>が<a class=link href=https://github.com/spring-projects/spring-boot/tree/v3.0.2/spring-boot-project/spring-boot-actuator target=_blank rel=noopener>Spring Boot Actuator</a>に移りました。なので、もうSpring Cloud Sleuthはいらなくなります。</p><p>ただ、Spring Boot Actuatorだけだと<code>BraveAutoConfiguration</code>によるDIはできません。なので以下のようにブリッジの依存関係を追加する必要があります。(バージョンはSpring Bootのものが使われる)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>implementation(<span style=color:#e6db74>&#34;io.micrometer:micrometer-tracing-bridge-brave&#34;</span>)
</span></span></code></pre></div><p>依存関係が変わるので、<code>application.yaml</code>の設定も変更が必要になります。既存では、以下のように記載していました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>sleuth</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>propagation</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>w3c</span>
</span></span></code></pre></div><p>Micrometerに移行したので、このように変更します。実際は、以下の設定はデフォルトなので記載しなくても問題はありませんが、メンテナンス時に現在の設定がわかりやすいように記載しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>tracing</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>propagation</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>w3c</span>
</span></span></code></pre></div><p>ただ、最もつまづいた部分はユニットテストでした。テストを実行してみると、なぜか以下のようなエラーメッセージが出ていました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type <span style=color:#e6db74>&#39;brave.Tracing&#39;</span> available: expected at least <span style=color:#ae81ff>1</span> bean which qualifies as autowire candidate. Dependency annotations: <span style=color:#f92672>{}</span>
</span></span></code></pre></div><p>Spring Cloud Sleuthを使っていた頃はユニットテスト時もDIができていたのですが、なぜか<code>BraveAutoConfiguration</code>によるDIが聞かない状態です。ローカルで起動した場合は同じエラーにならないので、おそらくテスト時にだけAutoConfigurationが呼ばれてないように思われます。</p><p><a class=link href=https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/test/context/TestConfiguration.html target=_blank rel=noopener>@TestConfiguration</a>などを使って、直接Bean登録をする方法もあるかと思いますが、調査してみると<a class=link href=https://www.baeldung.com/spring-boot-3-observability#testing-observations target=_blank rel=noopener>Micrometerにはテスト用のライブラリが用意されている</a>ので、それを使うことにしました。このライブラリがリリースされたのは2022年の12月なので、なかなか情報を見つけるのが難しいです。とにかく、以下のようにライブラリを追加することでDIの問題は解消できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>testImplementation(<span style=color:#e6db74>&#34;io.micrometer:micrometer-tracing-test&#34;</span>)
</span></span></code></pre></div><p>今回はライブラリの追加だけで解消できたのですが、新しいライブラリの情報はこちらで調べないとなかなかわからないというのが問題でしたね。他のライブラリの場合も同じ問題があるかもしれないので、もしAutoConfigurationによりDIされるはずのBeanが見つからないとのエラーが出る場合は、テスト用のライブラリが追加されてないか確認するのが良いかもしれません。</p><p>追加で、<a class=link href=https://www.datadoghq.com/ja/ target=_blank rel=noopener>Datadog</a>の場合もMicrometerの設定の記載方法が全体的に変わったためか、一部プロパティの記載方法が変わっています。以前の場合は以下のように記載していました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>metrics</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>export</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>datadog</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apiKey</span>: <span style=color:#ae81ff>${API_KEY}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>step</span>: <span style=color:#ae81ff>1m</span>
</span></span></code></pre></div><p>これが以下のように変わります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datadog</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metrics</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>export</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>api-key</span>: <span style=color:#ae81ff>${API_KEY}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>step</span>: <span style=color:#ae81ff>1m</span>
</span></span></code></pre></div><p>他にもMicrometerの機能を使っている場合、既存のSpring Boot 2と比べプロパティの設定方法が変わってないか確認した方がいいでしょう。</p><h3 id=jakarta-ee>Jakarta EE</h3><p>Spring Framework 6はOracleの<code>Java EE</code>からEclipseの<code>Jakarta EE</code>に移行しているので、コンパイルが通らない場合があります。主に<a class=link href=https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html target=_blank rel=noopener>HttpServletRequest</a>などsevlet系や<a class=link href=https://docs.oracle.com/javaee/7/api/javax/validation/Valid.html target=_blank rel=noopener>@Valid</a>などvalidation系パッケージがよく使われているかと思います。これらはimport時のパッケージ名を変更することで対応できます。例えば、以下のようなパッケージを使っている場合だとします。</p><ul><li>javax.servlet</li><li>javax.validation</li></ul><p>これらは以下のように変更します。</p><ul><li>jakarta.servlet</li><li>jakarta.validation</li></ul><p>パッケージ名が変わっただけで、中身は変わっていないので、簡単な対応となります。</p><h3 id=springdoc>springdoc</h3><p><a class=link href=https://springdoc.org/ target=_blank rel=noopener>springdoc-openapi</a>を使ってAPIドキュメントを生成している場合、既存のバージョンだとSpring Boot 3と互換性がないようです。CIでは<code>/v3/api-docs</code>から取得したJSONを解析してS3にドキュメントをアップロードするようになっていますが、Spring Boot 3だと404エラーとなっていました。</p><p>幸い、これも依存関係を変更することで対応ができます。以前は以下のように依存関係を追加していました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>implementation(<span style=color:#e6db74>&#34;org.springdoc:springdoc-openapi-ui:1.6.14&#34;</span>)
</span></span><span style=display:flex><span>implementation(<span style=color:#e6db74>&#34;org.springdoc:springdoc-openapi-kotlin:1.6.14&#34;</span>)
</span></span></code></pre></div><p>これを、<a class=link href=https://springdoc.org/v2/ target=_blank rel=noopener>springdoc-openapiのv2</a>に変更するだけで良いです。Kotlinのサポートも含まれるので、以下のみで問題なく動きます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>implementation(<span style=color:#e6db74>&#34;org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2&#34;</span>)
</span></span></code></pre></div><p>これで404エラーは発生することなく、S3へのドキュメントのアップロードもできます。</p><h3 id=liquibase>Liquibase</h3><p>Spring Frameworkとの直接的な関係がある訳ではないのですが、Spring Bootのバージョンを上げたことにより影響を受けたのでこちらのケースも紹介します。DBのマイグレーションのためにGradleのプラグインとして<a class=link href=https://www.liquibase.org/ target=_blank rel=noopener>Liquibase</a>を使っている場合、バージョンによっては以下のようなエラーが出る場合があります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>SLF4J: No SLF4J providers were found.
</span></span><span style=display:flex><span>SLF4J: Defaulting to no-operation (NOP) logger implementation
</span></span><span style=display:flex><span>SLF4J: See https://www.slf4j.org/codes.html#noProviders for further details.
</span></span><span style=display:flex><span>SLF4J: Class path contains SLF4J bindings targeting slf4j-api versions 1.7.x or earlier.
</span></span><span style=display:flex><span>SLF4J: Ignoring binding found at [jar:file:/root/.gradle/caches/modules-2/files-2.1/ch.qos.logback/logback-classic/1.2.11/4741689214e9d1e8408b206506cbe76d1c6a7d60/logback-classic-1.2.11.jar!/org/slf4j/impl/StaticLoggerBinder.class]
</span></span><span style=display:flex><span>SLF4J: See https://www.slf4j.org/codes.html#ignoredBindings for an explanation.
</span></span><span style=display:flex><span>Exception in thread &#34;main&#34; java.lang.ClassCastException: class org.slf4j.helpers.NOPLogger cannot be cast to class ch.qos.logback.classic.Logger (org.slf4j.helpers.NOPLogger and ch.qos.logback.classic.Logger are in unnamed module of loader &#39;app&#39;)
</span></span><span style=display:flex><span>  at liquibase.integration.commandline.Main.setupLogging(Main.java:233)
</span></span><span style=display:flex><span>  at liquibase.integration.commandline.Main.run(Main.java:145)
</span></span><span style=display:flex><span>  at liquibase.integration.commandline.Main.main(Main.java:129)
</span></span></code></pre></div><p>これはおそらく、Spring Boot 3から<a class=link href=https://www.slf4j.org/ target=_blank rel=noopener>SLF4J</a>のバージョンが2系になったためですね。Liquibaseのプラグインでは今まで<a class=link href=https://logback.qos.ch/index.html target=_blank rel=noopener>Logback</a>を使ってマイグレーションの状況を出力していたのですが、このLogbackのバージョンが1.2だったのでSLF4Jの2系と互換性がなかったのです。Logbackの1.3から互換性があるらしいので、それ以前のバージョンを使っている場合はこちらも合わせてバージョンを上げておく必要があるでしょう。</p><h2 id=最後に>最後に</h2><p>何とかJavaとSpring Bootのバージョンアップには成功していますが、前述した通り、これはあくまで自分が開発しているアプリケーションがマイクロサービスで、依存関係が比較的少なかったからできたことなのではないかと思います。モノリシックなアプリケーションだったり、より複雑な依存関係を持っているアプリケーションならここに記載したこと以外の部分でも問題が発生する可能性は高いでしょう。</p><p>ただ、Springの場合はいずれSpring Boot 2のサポートが切れ、3系に移行するしかない状況が来るかもしれませんが、その時は十分マイグレーションの実例も出てくるのではないかと思います。Javaの場合は11から17に上げる場合なら大きく問題はないかと思いますが、8から移行する場合はJava 9で導入された<a class=link href=https://www.oracle.com/webfolder/technetwork/jp/javamagazine/Java-JA18-LibrariesToModules.pdf target=_blank rel=noopener>Module</a>で問題が起こる可能性もあるかと思いますので、慎重に行うべきかなと思います。</p><p>嬉しいことに、まだNative化までは試してないのですが、JVM上でもアプリケーションの起動時間が減少していることを確認できました。ローカルで起動した場合、Java 11 & Spring Boot 2だと31秒がかかり、Java 17 & Spring Boot 3だと23秒がかかっていたので、断定はできないものの全体的な性能の向上もある程度は期待できるのではないかという気がします。正確なデータはまだ取れていないので、今後の課題として残しておきますが、ありがたいことですね。</p><p>では、また！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/kotlin/>kotlin</a>
<a href=/tags/java/>java</a>
<a href=/tags/spring/>spring</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/spring-webflux-dividing-router-and-handler/><div class=article-image><img src=/../../images/spring.jpg loading=lazy data-key data-hash=/../../images/spring.jpg></div><div class=article-details><h2 class=article-title>WebFluxのFunctional Enpointに対する小考察</h2></div></a></article><article class=has-image><a href=/posts/spring-webflux-router/><div class=article-image><img src=/../../images/spring.jpg loading=lazy data-key data-hash=/../../images/spring.jpg></div><div class=article-details><h2 class=article-title>WebFluxではFunctional Enpointを使うべきか</h2></div></a></article><article class=has-image><a href=/posts/spring-conditional/><div class=article-image><img src=/../../images/spring.jpg loading=lazy data-key data-hash=/../../images/spring.jpg></div><div class=article-details><h2 class=article-title>条件で動作するアノテーションを使う</h2></div></a></article><article class=has-image><a href=/posts/spring-settings-encryption/><div class=article-image><img src=/../../images/spring.jpg loading=lazy data-key data-hash=/../../images/spring.jpg></div><div class=article-details><h2 class=article-title>Jasyptでプロパティを暗号化する</h2></div></a></article><article class=has-image><a href=/posts/spring-switching-service/><div class=article-image><img src=/../../images/spring.jpg loading=lazy data-key data-hash=/../../images/spring.jpg></div><div class=article-details><h2 class=article-title>ServiceのImplクラスをYAMLで選択する</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2023 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>