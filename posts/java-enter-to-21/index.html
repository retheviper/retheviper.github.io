<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Java 17がリリースされてから約2年、今月にはJava 21がリリースされます。まだ案件によっては1.7など古いバージョンを使っている場合も多いと'><title>Java 21は何が変わったか</title>
<link rel=canonical href=https://retheviper.github.io/posts/java-enter-to-21/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property='og:title' content='Java 21は何が変わったか'><meta property='og:description' content='Java 17がリリースされてから約2年、今月にはJava 21がリリースされます。まだ案件によっては1.7など古いバージョンを使っている場合も多いと'><meta property='og:url' content='https://retheviper.github.io/posts/java-enter-to-21/'><meta property='og:site_name' content='Korean-man in Tokyo'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='java'><meta property='article:tag' content='kotlin'><meta property='article:published_time' content='2023-09-18T00:00:00+00:00'><meta property='article:modified_time' content='2023-09-18T00:00:00+00:00'><meta property='og:image' content='https://retheviper.github.io/images/java.jpg'><meta name=twitter:title content="Java 21は何が変わったか"><meta name=twitter:description content="Java 17がリリースされてから約2年、今月にはJava 21がリリースされます。まだ案件によっては1.7など古いバージョンを使っている場合も多いと"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://retheviper.github.io/images/java.jpg'><link rel="shortcut icon" href=/favicon.ico><link rel=icon href=/favicon/favicon.ico><link rel=mask-icon href=safari-pinned-tab.svg color=black><link rel=manifest href=/favicon/manifest.json><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BYJBEJB6DX")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu768313a802c015f07dded3abd3d4245d_264018_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>👋</span></figure><div class=site-meta><h1 class=site-name><a href=/>Korean-man in Tokyo</a></h1><h2 class=site-description>一人前になりたいです</h2></div></header><ol class=social-menu><li><a href=https://www.credly.com/users/youngbin-kim.6d7122f1/badges target=_blank title=Certificates rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-certificate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="15" cy="15" r="3"/><path d="M13 17.5V22l2-1.5 2 1.5v-4.5"/><path d="M10 19H5a2 2 0 01-2-2V7c0-1.1.9-2 2-2h14a2 2 0 012 2v10a2 2 0 01-1 1.73"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="12" x2="9" y2="12"/><line x1="6" y1="15" x2="8" y2="15"/></svg></a></li><li><a href=https://github.com/retheviper target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/%E8%8B%B1%E6%96%8C-%E9%87%91-6736ba194/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://retheviper.github.io/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://retheviper.github.io/ selected></option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#言語スペック>言語スペック</a><ol><li><a href=#string-templates-preview>String Templates (Preview)</a></li><li><a href=#sequenced-collections>Sequenced Collections</a></li><li><a href=#generational-zgc>Generational ZGC</a></li><li><a href=#record-patterns>Record Patterns</a></li><li><a href=#pattern-matching-for-switch>Pattern Matching for switch</a></li><li><a href=#foreign-fuctions-and-memory-access-api-third-preview>Foreign Fuctions and Memory Access API (Third Preview)</a></li><li><a href=#unnamed-patterns-and-variables-preview>Unnamed Patterns and Variables (Preview)</a></li><li><a href=#virtual-threads>Virtual threads</a></li><li><a href=#unnamed-classes-and-instance-main-methods-preview>Unnamed Classes and Instance Main Methods (Preview)</a></li><li><a href=#scoped-values-preview>Scoped Values (Preview)</a></li><li><a href=#vector-api-sixth-incubator>Vector API (Sixth Incubator)</a></li><li><a href=#deprecate-the-windows-32-bit-x86-port-for-removal>Deprecate the Windows 32-bit x86 Port for Removal</a></li><li><a href=#prepare-to-disallow-the-dynamic-loading-of-agents>Prepare to Disallow the Dynamic Loading of Agents</a></li><li><a href=#key-encapsulation-mechanism-api>Key Encapsulation Mechanism API</a></li><li><a href=#structured-concurrency-preview>Structured Concurrency (Preview)</a></li></ol></li><li><a href=#api>API</a></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/java-enter-to-21/><img src=/images/java.jpg loading=lazy alt="Featured image of post Java 21は何が変わったか"></a></div><div class=article-details><header class=article-category><a href=/categories/java/ style=background-color:#2a9d8f;color:#fff>java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/java-enter-to-21/>Java 21は何が変わったか</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 18, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><p>Java 17がリリースされてから約2年、今月にはJava 21がリリースされます。まだ案件によっては1.7など古いバージョンを使っている場合も多いと思いますが、21は新しいLTSなので、今後新しいプロジェクトを始めるときは採用を検討するのも良いかもしれません。そこで今回はJava 21で何が変わったのかをざっくりとまとめてみました。</p><p>今回の記事はJava 17からの変化について述べているので、Java 11から17までの変化については<a class=link href=../java-enter-to-17/>前回のポスト</a>を参照してください。</p><h2 id=言語スペック>言語スペック</h2><h3 id=string-templates-preview>String Templates (Preview)</h3><p>Kotlinのような言語にはいわゆるString Interpolationという機能があります。これは文字列の中に変数を埋め込むことができる機能ですね。例えばxとyという変数があったとして、それをStringに埋め込むときにKotlinだと以下のように書くことができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> s = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$x</span><span style=color:#e6db74> plus </span><span style=color:#e6db74>$y</span><span style=color:#e6db74> equals </span><span style=color:#e6db74>${x + y}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>これをJavaで実現するためには以下のように書くことになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// String concatenation</span>
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> x <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; plus &#34;</span> <span style=color:#f92672>+</span> y <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; equals &#34;</span> <span style=color:#f92672>+</span> (x <span style=color:#f92672>+</span> y);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// StringBuilder</span>
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder()
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>append</span>(x)
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34; plus &#34;</span>)
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>append</span>(y)
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34; equals &#34;</span>)
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>append</span>(x <span style=color:#f92672>+</span> y)
</span></span><span style=display:flex><span>                 .<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// String.format</span>
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%2$d plus %1$d equals %3$d&#34;</span>, x, y, x <span style=color:#f92672>+</span> y);
</span></span><span style=display:flex><span>String t <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;%2$d plus %1$d equals %3$d&#34;</span>.<span style=color:#a6e22e>formatted</span>(x, y, x <span style=color:#f92672>+</span> y);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MessageFormat</span>
</span></span><span style=display:flex><span>MessageFormat mf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MessageFormat(<span style=color:#e6db74>&#34;{0} plus {1} equals {2}&#34;</span>);
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> mf.<span style=color:#a6e22e>format</span>(x, y, x <span style=color:#f92672>+</span> y);
</span></span></code></pre></div><p>これらの方法はどれも冗長で、可読性が低いです。そこでJava 21ではString Templatesという機能が追加されました。これは文字列の中に変数を埋め込むことができる機能です。なので、Javaでももっと簡単な方法でStringを作成することができるようになりました。</p><p>ただ、String InterpolationにはSQL Injectionのような問題があるので、Javaでは別のアプローチを取りました。これは文字列の中に変数を埋め込むのではなく、文字列の中に変数を埋め込むための<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/StringTemplate.html target=_blank rel=noopener>テンプレート</a>をまず作成して、それを使って文字列を作成するという方法になっています。なのでコード以下のようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// STRを使う場合</span>
</span></span><span style=display:flex><span>String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Joan&#34;</span>;
</span></span><span style=display:flex><span>String info <span style=color:#f92672>=</span> STR.<span style=color:#e6db74>&#34;My name is \{name}&#34;</span>; <span style=color:#75715e>// My name is Joan</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RAWを使う場合</span>
</span></span><span style=display:flex><span>String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Joan&#34;</span>;
</span></span><span style=display:flex><span>StringTemplate st <span style=color:#f92672>=</span> RAW.<span style=color:#e6db74>&#34;My name is \{name}&#34;</span>;
</span></span><span style=display:flex><span>String info <span style=color:#f92672>=</span> STR.<span style=color:#a6e22e>process</span>(st); <span style=color:#75715e>// My name is Joan</span>
</span></span></code></pre></div><p><a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/StringTemplate.html#STR target=_blank rel=noopener>STR</a>や<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/StringTemplate.html#RAW target=_blank rel=noopener>RAW</a>はStringTemplateのインスタンスをまず作るようになっていますが、このStringTemplateのインスタンスにはfragmentsというフィールドとvaluesという配列があります。fragmentsは文字列の中に変数があるところを空文字列に置き換えたものの配列で、valuesは変数の値の配列です。なので、変数を埋め込んだ結果の文字列だけでなく実際与えられた変数の値も取得することができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> 10, y <span style=color:#f92672>=</span> 20;
</span></span><span style=display:flex><span>StringTemplate st <span style=color:#f92672>=</span> RAW.<span style=color:#e6db74>&#34;\{x} plus \{y} equals \{x + y}&#34;</span>;
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> st.<span style=color:#a6e22e>toString</span>(); <span style=color:#75715e>// StringTemplate{ fragments = [ &#34;&#34;, &#34; plus &#34;, &#34; equals &#34;, &#34;&#34; ], values = [10, 20, 30] }</span>
</span></span></code></pre></div><p>また、StringTemplateにはProcessorというInterfaceがあり、Functional Interfaceとして独自の実装をすることも可能です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Processor Interface</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>StringTemplate</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@FunctionalInterface</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Processor</span><span style=color:#f92672>&lt;</span>R, E <span style=color:#66d9ef>extends</span> Throwable<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        R <span style=color:#a6e22e>process</span>(StringTemplate st) <span style=color:#66d9ef>throws</span> E;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> INTER <span style=color:#f92672>=</span> StringTemplate.<span style=color:#a6e22e>Processor</span>.<span style=color:#a6e22e>of</span>(StringTemplate::interpolate);
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> INTER.<span style=color:#e6db74>&#34;\{x} plus \{y} equals \{x + y}&#34;</span>;
</span></span></code></pre></div><p>まだPreviewなので、このような使い方は今後変わる可能性がありますが、かなり面白いアプローチなので今後の動向に注目したい機能でした。</p><h3 id=sequenced-collections>Sequenced Collections</h3><p>JavaのCollectionの場合、種類によって最後の要素を取るためには色々書き方が変わったり、冗長になったりしますね。例えば、最初の要素と最後の要素を取る場合Collecitonの種類によって以下のようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// List</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> firstOnList <span style=color:#f92672>=</span> list.<span style=color:#a6e22e>get</span>(0);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> lastOnList <span style=color:#f92672>=</span> list.<span style=color:#a6e22e>get</span>(list.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>-</span> 1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Deque</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> firstOnDeque <span style=color:#f92672>=</span> deque.<span style=color:#a6e22e>getFirst</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> lastOnDeque <span style=color:#f92672>=</span> deque.<span style=color:#a6e22e>getLast</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SortedSet</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> firstOnSortedSet <span style=color:#f92672>=</span> sortedSet.<span style=color:#a6e22e>first</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> lastOnSortedSet <span style=color:#f92672>=</span> sortedSet.<span style=color:#a6e22e>last</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// LinkedHashSet</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> firstOnLinkedHashSet <span style=color:#f92672>=</span> linkedHashSet.<span style=color:#a6e22e>iterator</span>().<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> lastOnLinkedHashSet <span style=color:#f92672>=</span> linkedHashSet.<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>reduce</span>((first, second) <span style=color:#f92672>-&gt;</span> second).<span style=color:#a6e22e>orElse</span>(<span style=color:#66d9ef>null</span>);
</span></span></code></pre></div><p>また、ループを逆順にする場合もコードは冗長になったり、使い勝手が悪く感じられる場合もあります。例えば以下のコードを見ると、やろうとしていることは一緒なのに、コードが全然違うということがわかります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// NavigableSet with descendingSet</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> e: navigableSet.<span style=color:#a6e22e>descendingSet</span>()) {
</span></span><span style=display:flex><span>    process(e);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Deque with reverse Iterator</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> it <span style=color:#f92672>=</span> deque.<span style=color:#a6e22e>descendingIterator</span>(); it.<span style=color:#a6e22e>hasNext</span>(); ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> e <span style=color:#f92672>=</span> it.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>    process(e);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List with reverse ListIterator</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> it <span style=color:#f92672>=</span> list.<span style=color:#a6e22e>listIterator</span>(list.<span style=color:#a6e22e>size</span>()); it.<span style=color:#a6e22e>hasPrevious</span>(); ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> e <span style=color:#f92672>=</span> it.<span style=color:#a6e22e>previous</span>();
</span></span><span style=display:flex><span>    process(e);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>また実装クラスによっては要素の順番が保持されるCollectionからそうでないものにダウングレードされるケースもあります。例えばLinkedHashSetをCollections::unmodifiableSetでラップすると、LinkedHashSetの順番が失われることになります。</p><p>そこでJava 21では<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/SequencedCollection.html target=_blank rel=noopener>SequencedCollection</a>および<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/SequencedSet.html target=_blank rel=noopener>SequencedSet</a>というInterfaceを追加して、上記の問題を解決します。これらInterfaceは以下のようなメソッドを提供します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SequencedCollection</span><span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> Collection<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// new method</span>
</span></span><span style=display:flex><span>    SequencedCollection<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>reversed</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// methods promoted from Deque</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addFirst</span>(E);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addLast</span>(E);
</span></span><span style=display:flex><span>    E <span style=color:#a6e22e>getFirst</span>();
</span></span><span style=display:flex><span>    E <span style=color:#a6e22e>getLast</span>();
</span></span><span style=display:flex><span>    E <span style=color:#a6e22e>removeFirst</span>();
</span></span><span style=display:flex><span>    E <span style=color:#a6e22e>removeLast</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SequencedSet</span><span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> Set<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span>, SequencedCollection<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    SequencedSet<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>reversed</span>();    <span style=color:#75715e>// covariant override</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>またMapにおいても<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/SequencedMap.html target=_blank rel=noopener>SequencedMap</a>というInterfaceが追加されていて、以下のようなメソッドを提供します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SequencedMap</span><span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> Map<span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// new methods</span>
</span></span><span style=display:flex><span>    SequencedMap<span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>reversed</span>();
</span></span><span style=display:flex><span>    SequencedSet<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>sequencedKeySet</span>();
</span></span><span style=display:flex><span>    SequencedCollection<span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>sequencedValues</span>();
</span></span><span style=display:flex><span>    SequencedSet<span style=color:#f92672>&lt;</span>Entry<span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>sequencedEntrySet</span>();
</span></span><span style=display:flex><span>    V <span style=color:#a6e22e>putFirst</span>(K, V);
</span></span><span style=display:flex><span>    V <span style=color:#a6e22e>putLast</span>(K, V);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// methods promoted from NavigableMap</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>firstEntry</span>();
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>lastEntry</span>();
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pollFirstEntry</span>();
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pollLastEntry</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>これらの新しいInterfaceが追加されることで、Collection全体の継承関係が以下のように変更されました。</p><p><img src=/posts/java-enter-to-21/SequencedCollectionDiagram20220216.webp width=1512 height=840 srcset="/posts/java-enter-to-21/SequencedCollectionDiagram20220216_hu52eadc6c156a34b7d2f6c016bafa6cff_17846_480x0_resize_q75_h2_box_2.webp 480w, /posts/java-enter-to-21/SequencedCollectionDiagram20220216_hu52eadc6c156a34b7d2f6c016bafa6cff_17846_1024x0_resize_q75_h2_box_2.webp 1024w" loading=lazy alt="Sequenced Collections" class=gallery-image data-flex-grow=180 data-flex-basis=432px>
<em>出典：OpenJDK - <a class=link href=https://openjdk.org/jeps/431 target=_blank rel=noopener>JEP 431: Sequenced Collections</a></em></p><p>継承関係によってダウンキャストが発生する場合もあるかなと思いますが、Listの場合はSequencedCollectionを継承しているのでそのまま新しいメソッドを使うことができます。</p><h3 id=generational-zgc>Generational ZGC</h3><p>ZGCはJava 11で導入されたGarbage Collectorですが、Java 21ではGenerational ZGCという機能が追加されました。これはZGCの性能を向上させるために、ZGCのヒープをYoung GenerationとOld Generationに分けることになります。これによって、Young GenerationのGCをより頻繁に行うことができるようになり、Young GenerationのGCの時間を短縮することができ、メモリやCPUのオーバーヘッドを減らすことができるらしいです。</p><p>Generational ZGCを使うには以下のように起動オプションを指定します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>java -XX:+UseZGC -XX:+ZGenerational
</span></span></code></pre></div><p>ただ、新しいGCに関しては<a class=link href=https://openjdk.org/jeps/439 target=_blank rel=noopener>公式のドキュメント</a>を参照すると色々と設計や実装について述べていますが、アプリケーションエンジニアの立場としてはそれを使った場合の実際の性能上の利点がどれくらいあるのかが気になるところですね。なので、実際にGenerational ZGCを使った場合の性能については<a class=link href=https://timefold.ai/blog/2023/java-21-performance/ target=_blank rel=noopener>こちらの記事</a>が参考になるかと思います。結論としてはまだParallelGCがもっとも性能が良いということになっています。もちろんこれはマシンスペック（特にメモリ）によっても変わってくると思うので、自分の環境で試してみるのが良いかと思います。</p><h3 id=record-patterns>Record Patterns</h3><p>Java 16では<a class=link href=https://openjdk.org/jeps/394 target=_blank rel=noopener>Pattern Matching</a>という機能が導入され、instanceOfで型チェックをした後にキャストするというコードを簡潔に書くことができるようになりました。例えば以下のようなものです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Prior to Java 16</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (obj <span style=color:#66d9ef>instanceof</span> String) {
</span></span><span style=display:flex><span>    String s <span style=color:#f92672>=</span> (String)obj;
</span></span><span style=display:flex><span>    ... use s ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// As of Java 16</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (obj <span style=color:#66d9ef>instanceof</span> String s) {
</span></span><span style=display:flex><span>    ... use s ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Java 21ではこのPattern Matchingを、同じくJava 16で導入された<a class=link href=https://openjdk.org/jeps/395 target=_blank rel=noopener>Record</a>にも適用することができるようになりました。例えば以下のようなコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// As of Java 16</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>record</span> <span style=color:#a6e22e>Point</span>(<span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printSum</span>(Object obj) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (obj <span style=color:#66d9ef>instanceof</span> Point p) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> p.<span style=color:#a6e22e>x</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> y <span style=color:#f92672>=</span> p.<span style=color:#a6e22e>y</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(x<span style=color:#f92672>+</span>y);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// As of Java 21</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printSum</span>(Object obj) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (obj <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>Point</span>(<span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y)) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(x<span style=color:#f92672>+</span>y);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらにネストしたRecordにも適用することができます。例えば以下のようなコードも可能です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printXCoordOfUpperLeftPointWithPatterns</span>(Rectangle r) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (r <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>Rectangle</span>(ColoredPoint(Point(<span style=color:#66d9ef>var</span> x, <span style=color:#66d9ef>var</span> y), <span style=color:#66d9ef>var</span> c),
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>var</span> lr)) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Upper-left corner: &#34;</span> <span style=color:#f92672>+</span> x);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=pattern-matching-for-switch>Pattern Matching for switch</h3><p>Pattern Matchingの改善はswitchにも適用されています。例えば以下のように、switchのcaseにnullを指定することができたり、スマートキャストが使えたり、さらにwhenを使った条件分岐ができるようになりました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testStringEnhanced</span>(String response) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (response) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>-&gt;</span> { }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;Y&#34;</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;You got it&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;n&#34;</span>, <span style=color:#e6db74>&#34;N&#34;</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Shame&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> String s
</span></span><span style=display:flex><span>        when s.<span style=color:#a6e22e>equalsIgnoreCase</span>(<span style=color:#e6db74>&#34;YES&#34;</span>) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;You got it&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> String s
</span></span><span style=display:flex><span>        when s.<span style=color:#a6e22e>equalsIgnoreCase</span>(<span style=color:#e6db74>&#34;NO&#34;</span>) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Shame&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> String s <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Sorry?&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この改善はEnumにも適用されています。例えば以下のようなコードが可能になりました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>exhaustiveSwitchWithBetterEnumSupport</span>(CardClassification c) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (c) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Suit.<span style=color:#a6e22e>CLUBS</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;It&#39;s clubs&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Suit.<span style=color:#a6e22e>DIAMONDS</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;It&#39;s diamonds&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Suit.<span style=color:#a6e22e>HEARTS</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;It&#39;s hearts&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Suit.<span style=color:#a6e22e>SPADES</span> <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;It&#39;s spades&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Tarot t <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;It&#39;s a tarot&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>まだprimitive typeには適用されないのですが、これは今後改善する予定らしいので、また次のバージョンで期待したいところです。</p><h3 id=foreign-fuctions-and-memory-access-api-third-preview>Foreign Fuctions and Memory Access API (Third Preview)</h3><p>Java 19から導入された機能で、Java runtime外のコードやデータにアクセスできるようなAPIが追加されます。これはJava 21ではThird Previewとして提供されていて、JavaからCやC++のコードを呼び出すことができるようになります。例えば以下のようなコードでCのライブラリを呼び出すことができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 1. Find foreign function on the C library path</span>
</span></span><span style=display:flex><span>Linker linker          <span style=color:#f92672>=</span> Linker.<span style=color:#a6e22e>nativeLinker</span>();
</span></span><span style=display:flex><span>SymbolLookup stdlib    <span style=color:#f92672>=</span> linker.<span style=color:#a6e22e>defaultLookup</span>();
</span></span><span style=display:flex><span>MethodHandle radixsort <span style=color:#f92672>=</span> linker.<span style=color:#a6e22e>downcallHandle</span>(stdlib.<span style=color:#a6e22e>find</span>(<span style=color:#e6db74>&#34;radixsort&#34;</span>), ...);
</span></span><span style=display:flex><span><span style=color:#75715e>// 2. Allocate on-heap memory to store four strings</span>
</span></span><span style=display:flex><span>String<span style=color:#f92672>[]</span> javaStrings <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;mouse&#34;</span>, <span style=color:#e6db74>&#34;cat&#34;</span>, <span style=color:#e6db74>&#34;dog&#34;</span>, <span style=color:#e6db74>&#34;car&#34;</span> };
</span></span><span style=display:flex><span><span style=color:#75715e>// 3. Use try-with-resources to manage the lifetime of off-heap memory</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> (Arena offHeap <span style=color:#f92672>=</span> Arena.<span style=color:#a6e22e>ofConfined</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. Allocate a region of off-heap memory to store four pointers</span>
</span></span><span style=display:flex><span>    MemorySegment pointers
</span></span><span style=display:flex><span>        <span style=color:#f92672>=</span> offHeap.<span style=color:#a6e22e>allocateArray</span>(ValueLayout.<span style=color:#a6e22e>ADDRESS</span>, javaStrings.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. Copy the strings from on-heap to off-heap</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> javaStrings.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        MemorySegment cString <span style=color:#f92672>=</span> offHeap.<span style=color:#a6e22e>allocateUtf8String</span>(javaStrings<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>        pointers.<span style=color:#a6e22e>setAtIndex</span>(ValueLayout.<span style=color:#a6e22e>ADDRESS</span>, i, cString);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 6. Sort the off-heap data by calling the foreign function</span>
</span></span><span style=display:flex><span>    radixsort.<span style=color:#a6e22e>invoke</span>(pointers, javaStrings.<span style=color:#a6e22e>length</span>, MemorySegment.<span style=color:#a6e22e>NULL</span>, <span style=color:#e6db74>&#39;\0&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 7. Copy the (reordered) strings from off-heap to on-heap</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> javaStrings.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        MemorySegment cString <span style=color:#f92672>=</span> pointers.<span style=color:#a6e22e>getAtIndex</span>(ValueLayout.<span style=color:#a6e22e>ADDRESS</span>, i);
</span></span><span style=display:flex><span>        javaStrings<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> cString.<span style=color:#a6e22e>getUtf8String</span>(0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} <span style=color:#75715e>// 8. All off-heap memory is deallocated here</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> Arrays.<span style=color:#a6e22e>equals</span>(javaStrings,
</span></span><span style=display:flex><span>                     <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]</span> {<span style=color:#e6db74>&#34;car&#34;</span>, <span style=color:#e6db74>&#34;cat&#34;</span>, <span style=color:#e6db74>&#34;dog&#34;</span>, <span style=color:#e6db74>&#34;mouse&#34;</span>});  <span style=color:#75715e>// true</span>
</span></span></code></pre></div><p>今はJavaを使って他の言語で作られたライブラリやアプリケーションを参照する場合、WrapperやRuntimeを利用した形が多いかなと思いますが、これを使うことでより簡単に他の言語のライブラリを呼び出すことができ、アプリケーションのサイズを減らしたり、パフォーマンスを向上させることができるようになるかなと思います。ただ、まだPreviewなので今後変わる可能性があるのと、直接メモリにアクセスするのでメモリリークの可能性があるかなと思いますので、使用時には注意が必要かと思います。</p><h3 id=unnamed-patterns-and-variables-preview>Unnamed Patterns and Variables (Preview)</h3><p>処理の中で使われてない変数を<code>_</code>で表現することができるようになりました。なので、以下のようなコードが書けるようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Loop</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> acc <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (Order _ : orders) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (acc <span style=color:#f92672>&lt;</span> LIMIT) { 
</span></span><span style=display:flex><span>        ... acc<span style=color:#f92672>++</span> ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Multiple assignment</span>
</span></span><span style=display:flex><span>Queue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> q <span style=color:#f92672>=</span> ... <span style=color:#75715e>// x1, y1, z1, x2, y2, z2, ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> (q.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>&gt;=</span> 3) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> x <span style=color:#f92672>=</span> q.<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> _ <span style=color:#f92672>=</span> q.<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> _ <span style=color:#f92672>=</span> q.<span style=color:#a6e22e>remove</span>(); 
</span></span><span style=display:flex><span>    ... <span style=color:#66d9ef>new</span> Point(x, 0) ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Catch block</span>
</span></span><span style=display:flex><span>String s <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> { 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> Integer.<span style=color:#a6e22e>parseInt</span>(s);
</span></span><span style=display:flex><span>    ... i ...
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (NumberFormatException _) { 
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Bad number: &#34;</span> <span style=color:#f92672>+</span> s);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// try-with-resources</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> (<span style=color:#66d9ef>var</span> _ <span style=color:#f92672>=</span> ScopedContext.<span style=color:#a6e22e>acquire</span>()) {
</span></span><span style=display:flex><span>    ... no use of acquired resource ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Lambda</span>
</span></span><span style=display:flex><span>stream.<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>toMap</span>(String::toUpperCase, _ <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;NODATA&#34;</span>))
</span></span></code></pre></div><h3 id=virtual-threads>Virtual threads</h3><p>Project Loomという名で長い間開発されていた機能です。個人的な意見ですが、Java 21においてもっとも注目されている機能ではないかと思います。既存のマルチスレッドプログラミングでは生成できるスレッドの数において物理的な制約があったのですが、今回の導入される仮想スレッドはそのOSのスレッドをさらに細かく分けて使うことになるので、より多くのスレッドを同時に扱うことができるのが特徴です。</p><p>使い方としては既存の物理スレッドと大きく変わるわけではないので、以下のようなコードで使うことができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>try</span> (<span style=color:#66d9ef>var</span> executor <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newVirtualThreadPerTaskExecutor</span>()) {
</span></span><span style=display:flex><span>    IntStream.<span style=color:#a6e22e>range</span>(0, 10_000).<span style=color:#a6e22e>forEach</span>(i <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(Duration.<span style=color:#a6e22e>ofSeconds</span>(1));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> i;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}  <span style=color:#75715e>// executor.close() is called implicitly, and waits</span>
</span></span></code></pre></div><p>仮想スレッドは実際のOSのスレッドに1:1対応しないので、既存のようにThreadPoolを作成してスレッドの数を制限する必要はほとんどありません。公式でもPoolを使うことをおすすめしないと言っているくらいです。</p><p>実際<a class=link href=https://kt.academy/article/dispatcher-loom target=_blank rel=noopener>KotlinでJavaの仮想スレッドを利用するようにDispatcherを実装して実験した記事</a>によると、30スレッドのマシンでも100万の
仮想スレッドを作成して処理を行うことができるのがわかります。JVM言語で作成されたサーバーサイドアプリケーションの場合、従来のスレッドモデルではスレッドの数を制限する必要があったので、この仮想スレッドの導入によって、より多くのリクエストを同時に処理することができるようになるかなと思います。</p><h3 id=unnamed-classes-and-instance-main-methods-preview>Unnamed Classes and Instance Main Methods (Preview)</h3><p>関数をトップレベルに定義することができるようになりました。なので、伝統のHello Worldのサンプルは以下のようなコードが書けるようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Prior to Java 21</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorld</span> { 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) { 
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Hello, World!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// As of Java 21</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Hello, World!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>トップレベルの関数やフィールドもUnnamed Classのメンバー扱いとなるので、以下のようなコードも問題なく動きます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Method</span>
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>greeting</span>() { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello, World!&#34;</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(greeting());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Field</span>
</span></span><span style=display:flex><span>String greeting <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello, World!&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(greeting);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>また、main関数を持つUnnamed Classは以下のように実行することができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>new</span> Object() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the unnamed class&#39;s body</span>
</span></span><span style=display:flex><span>}.<span style=color:#a6e22e>main</span>();
</span></span></code></pre></div><h3 id=scoped-values-preview>Scoped Values (Preview)</h3><p>Webアプリケーションの場合、一つのリクエストに対してはスレッドが割り当てられ、一貫したコンテキストの中で実行されるようにするのが一般的です。ただ、そこでコンテキストをオブジェクトとして扱う場合、既存だと実行される関数の引数として渡す必要があります。例えば以下のようなコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handle</span>(Request request, Response response, FrameworkContext context) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> userInfo <span style=color:#f92672>=</span> readUserInfo(context);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> UserInfo <span style=color:#a6e22e>readUserInfo</span>(FrameworkContext context) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (UserInfo)framework.<span style=color:#a6e22e>readKey</span>(<span style=color:#e6db74>&#34;userInfo&#34;</span>, context);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>または、<a class=link href=https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/ThreadLocal.html target=_blank rel=noopener>ThreadLocal</a>を使用して以下のように書くこともできます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Framework</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Application application;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Framework</span>(Application app) { <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>application</span> <span style=color:#f92672>=</span> app; }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> ThreadLocal<span style=color:#f92672>&lt;</span>FrameworkContext<span style=color:#f92672>&gt;</span> CONTEXT 
</span></span><span style=display:flex><span>                       <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>serve</span>(Request request, Response response) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> context <span style=color:#f92672>=</span> createContext(request);
</span></span><span style=display:flex><span>        CONTEXT.<span style=color:#a6e22e>set</span>(context);
</span></span><span style=display:flex><span>        Application.<span style=color:#a6e22e>handle</span>(request, response);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PersistedObject <span style=color:#a6e22e>readKey</span>(String key) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> context <span style=color:#f92672>=</span> CONTEXT.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> db <span style=color:#f92672>=</span> getDBConnection(context);
</span></span><span style=display:flex><span>        db.<span style=color:#a6e22e>readKey</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>しかし、ThreadLocalを使う場合は色々と問題があります。まずThreadLocalの値そのものが変更されるということです。そして不要になったThreadLocalの値を適宜削除する必要があったり、オーバーヘッドが発生するということです。</p><p>そこでJava 21では<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/ScopedValue.html target=_blank rel=noopener>ScopedValue</a>というクラスが追加されました。これを使うと以下のようにスレッドあたりの値を設定することができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Framework</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> ScopedValue<span style=color:#f92672>&lt;</span>FrameworkContext<span style=color:#f92672>&gt;</span> CONTEXT 
</span></span><span style=display:flex><span>                        <span style=color:#f92672>=</span> ScopedValue.<span style=color:#a6e22e>newInstance</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>serve</span>(Request request, Response response) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> context <span style=color:#f92672>=</span> createContext(request);
</span></span><span style=display:flex><span>        ScopedValue.<span style=color:#a6e22e>where</span>(CONTEXT, context)
</span></span><span style=display:flex><span>                   .<span style=color:#a6e22e>run</span>(() <span style=color:#f92672>-&gt;</span> Application.<span style=color:#a6e22e>handle</span>(request, response));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PersistedObject <span style=color:#a6e22e>readKey</span>(String key) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> context <span style=color:#f92672>=</span> CONTEXT.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> db <span style=color:#f92672>=</span> getDBConnection(context);
</span></span><span style=display:flex><span>        db.<span style=color:#a6e22e>readKey</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ScopedVlaueにはsetterがないですが、だからと言って他の値を与えられないわけではないです。ThreadLocalとは別のアプローチで、特定の値を渡してrun()関数を実行することができるようになっています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ScopedValue<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> X <span style=color:#f92672>=</span> ScopedValue.<span style=color:#a6e22e>newInstance</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    ScopedValue.<span style=color:#a6e22e>where</span>(X, <span style=color:#e6db74>&#34;hello&#34;</span>).<span style=color:#a6e22e>run</span>(() <span style=color:#f92672>-&gt;</span> bar());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>bar</span>() {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(X.<span style=color:#a6e22e>get</span>()); <span style=color:#75715e>// prints hello</span>
</span></span><span style=display:flex><span>    ScopedValue.<span style=color:#a6e22e>where</span>(X, <span style=color:#e6db74>&#34;goodbye&#34;</span>).<span style=color:#a6e22e>run</span>(() <span style=color:#f92672>-&gt;</span> baz());
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(X.<span style=color:#a6e22e>get</span>()); <span style=color:#75715e>// prints hello</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>baz</span>() {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(X.<span style=color:#a6e22e>get</span>()); <span style=color:#75715e>// prints goodbye</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このScopedValueはスレッドの実行中にだけ値が保持されないので、ThreadLocalより安全な使い方ができるようになっています。</p><h3 id=vector-api-sixth-incubator>Vector API (Sixth Incubator)</h3><p>Java 1.0の時代の配列を扱う<a class=link href=https://docs.oracle.com/javase/jp/8/docs/api/java/util/Vector.html target=_blank rel=noopener>Vector</a>とは違って、数値（行列）の計算のためのVector APIが追加されました。基本的に以下のようなことができるようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Prior to Java 21</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>scalarComputation</span>(<span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> a, <span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> b, <span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> c) {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> a.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        c<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> (a<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>*</span> a<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> b<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>*</span> b<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>) <span style=color:#f92672>*</span> <span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0f</span>;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// As of Java 21</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> VectorSpecies<span style=color:#f92672>&lt;</span>Float<span style=color:#f92672>&gt;</span> SPECIES <span style=color:#f92672>=</span> FloatVector.<span style=color:#a6e22e>SPECIES_PREFERRED</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>vectorComputation</span>(<span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> a, <span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> b, <span style=color:#66d9ef>float</span><span style=color:#f92672>[]</span> c) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> upperBound <span style=color:#f92672>=</span> SPECIES.<span style=color:#a6e22e>loopBound</span>(a.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (; i <span style=color:#f92672>&lt;</span> upperBound; i <span style=color:#f92672>+=</span> SPECIES.<span style=color:#a6e22e>length</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// FloatVector va, vb, vc;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> va <span style=color:#f92672>=</span> FloatVector.<span style=color:#a6e22e>fromArray</span>(SPECIES, a, i);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> vb <span style=color:#f92672>=</span> FloatVector.<span style=color:#a6e22e>fromArray</span>(SPECIES, b, i);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> vc <span style=color:#f92672>=</span> va.<span style=color:#a6e22e>mul</span>(va)
</span></span><span style=display:flex><span>                   .<span style=color:#a6e22e>add</span>(vb.<span style=color:#a6e22e>mul</span>(vb))
</span></span><span style=display:flex><span>                   .<span style=color:#a6e22e>neg</span>();
</span></span><span style=display:flex><span>        vc.<span style=color:#a6e22e>intoArray</span>(c, i);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (; i <span style=color:#f92672>&lt;</span> a.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        c<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> (a<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>*</span> a<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> b<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>*</span> b<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>) <span style=color:#f92672>*</span> <span style=color:#f92672>-</span>1.<span style=color:#a6e22e>0f</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>一般的なWebアプリケーションではあまり使われることはないかと思いますが、もしこのような計算が必要とされる処理を書く場合、従来のコードよりも高速で並列かもできるということなので、使う場面があるかもしれません。</p><h3 id=deprecate-the-windows-32-bit-x86-port-for-removal>Deprecate the Windows 32-bit x86 Port for Removal</h3><p>Windows x86-32のポートがいずれ終わるので、まずはDeprecatedにしてするということです。Virtual Threadが該当のOSだと期待通りの性能向上がなく、32bitに対応する最後のWindowsであるWindows 10が2025年10月にサポート終了となるための対応とされています。</p><h3 id=prepare-to-disallow-the-dynamic-loading-of-agents>Prepare to Disallow the Dynamic Loading of Agents</h3><p>Java agentによる動的ロードは、実行中のアプリケーションを変更することも可能です。しかしこのよう機能はアプリケーションの整合性を保証できなくする可能性もあります。そのような問題を防ぐために、将来は動的ロードを禁止し、Java 21ではまず警告を出力します。以下のようなメッセージが出力されることがあります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>WARNING: A {Java,JVM TI} agent has been loaded dynamically (file:/u/bob/agent.jar)
</span></span><span style=display:flex><span>WARNING: If a serviceability tool is in use, please run with -XX:+EnableDynamicAgentLoading to hide this warning
</span></span><span style=display:flex><span>WARNING: If a serviceability tool is not in use, please run with -Djdk.instrument.traceUsage for more information
</span></span><span style=display:flex><span>WARNING: Dynamic loading of agents will be disallowed by default in a future release
</span></span></code></pre></div><p>このような警告を回避するためにはアプリケーションの実行時に<code>-XX:+EnableDynamicAgentLoading</code>というオプションを指定する必要があります。</p><p><a class=link href=https://www.datadoghq.com/ target=_blank rel=noopener>Datadog</a>や<a class=link href=https://docs.oracle.com/cd/F25597_01/document/products/wls/docs90/jmxinst/understanding.html target=_blank rel=noopener>JMX</a>などアプリケーションをモニタリングするためのツールがこのような機能に依存している場合があるので、今後のバージョンを使う際には何か実装の方法が変わるかもしれませんね。</p><h3 id=key-encapsulation-mechanism-api>Key Encapsulation Mechanism API</h3><p>最新の暗号化のアルゴリズムに対応するものです。量子コンピュータでは既存の暗号化アルゴリズムが通用しなくなるという話もあるので、その対応として導入されたものかと思われます（公式でも、<code> Post-Quantum Cryptography standardization process</code>と述べています）。</p><p>新しいアルゴリズムを用いた公開鍵・秘密鍵のペアの生成、カプセル化、カプセルの解除などの機能に対応しています。以下のような使い方となります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Receiver side</span>
</span></span><span style=display:flex><span>KeyPairGenerator g <span style=color:#f92672>=</span> KeyPairGenerator.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;ABC&#34;</span>);
</span></span><span style=display:flex><span>KeyPair kp <span style=color:#f92672>=</span> g.<span style=color:#a6e22e>generateKeyPair</span>();
</span></span><span style=display:flex><span>publishKey(kp.<span style=color:#a6e22e>getPublic</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Sender side</span>
</span></span><span style=display:flex><span>KEM kemS <span style=color:#f92672>=</span> KEM.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;ABC-KEM&#34;</span>);
</span></span><span style=display:flex><span>PublicKey pkR <span style=color:#f92672>=</span> retrieveKey();
</span></span><span style=display:flex><span>ABCKEMParameterSpec specS <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ABCKEMParameterSpec(...);
</span></span><span style=display:flex><span>KEM.<span style=color:#a6e22e>Encapsulator</span> e <span style=color:#f92672>=</span> kemS.<span style=color:#a6e22e>newEncapsulator</span>(pkR, specS, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>KEM.<span style=color:#a6e22e>Encapsulated</span> enc <span style=color:#f92672>=</span> e.<span style=color:#a6e22e>encapsulate</span>();
</span></span><span style=display:flex><span>SecretKey secS <span style=color:#f92672>=</span> enc.<span style=color:#a6e22e>key</span>();
</span></span><span style=display:flex><span>sendBytes(enc.<span style=color:#a6e22e>encapsulation</span>());
</span></span><span style=display:flex><span>sendBytes(enc.<span style=color:#a6e22e>params</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Receiver side</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> em <span style=color:#f92672>=</span> receiveBytes();
</span></span><span style=display:flex><span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> params <span style=color:#f92672>=</span> receiveBytes();
</span></span><span style=display:flex><span>KEM kemR <span style=color:#f92672>=</span> KEM.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;ABC-KEM&#34;</span>);
</span></span><span style=display:flex><span>AlgorithmParameters algParams <span style=color:#f92672>=</span> AlgorithmParameters.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;ABC-KEM&#34;</span>);
</span></span><span style=display:flex><span>algParams.<span style=color:#a6e22e>init</span>(params);
</span></span><span style=display:flex><span>ABCKEMParameterSpec specR <span style=color:#f92672>=</span> algParams.<span style=color:#a6e22e>getParameterSpec</span>(ABCKEMParameterSpec.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>KEM.<span style=color:#a6e22e>Decapsulator</span> d <span style=color:#f92672>=</span> kemR.<span style=color:#a6e22e>newDecapsulator</span>(kp.<span style=color:#a6e22e>getPrivate</span>(), specR);
</span></span><span style=display:flex><span>SecretKey secR <span style=color:#f92672>=</span> d.<span style=color:#a6e22e>decapsulate</span>(em);
</span></span></code></pre></div><h3 id=structured-concurrency-preview>Structured Concurrency (Preview)</h3><p>並列処理をより簡単にするためのAPIです。複数のスレッドで実行される作業の単位を一つのタスクとして扱うことができます。</p><p>例えば以下のようなコードがあったとします。userとorderのデータをそれぞれ違うスレッドで取得して、その結果を返す関数です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Response <span style=color:#a6e22e>handle</span>() <span style=color:#66d9ef>throws</span> ExecutionException, InterruptedException {
</span></span><span style=display:flex><span>    Future<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>  user  <span style=color:#f92672>=</span> esvc.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> findUser());
</span></span><span style=display:flex><span>    Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> order <span style=color:#f92672>=</span> esvc.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> fetchOrder());
</span></span><span style=display:flex><span>    String theUser  <span style=color:#f92672>=</span> user.<span style=color:#a6e22e>get</span>();   <span style=color:#75715e>// Join findUser</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span>    theOrder <span style=color:#f92672>=</span> order.<span style=color:#a6e22e>get</span>();  <span style=color:#75715e>// Join fetchOrder</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Response(theUser, theOrder);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上記のコードだと、以下のような問題が考えられます。</p><ul><li>findUser()で例外が発生してもfetchOrder()は実行されてリソースの無駄になる</li><li>handle()を実行しているスレッドがインタラプトされた場合、findUser()とfetchOrder()は実行されたままになる</li><li>findUser()の実行が長すぎる場合、fetchOrder()が失敗してもそれを待つことになる（結果的に失敗）</li></ul><p>これらの問題が挙げられてということは、新しいAPIではそれを解決できるということですね。新しいAPIでは上記の問題を、以下のようなコードで解決します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Response <span style=color:#a6e22e>handle</span>() <span style=color:#66d9ef>throws</span> ExecutionException, InterruptedException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> (<span style=color:#66d9ef>var</span> scope <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StructuredTaskScope.<span style=color:#a6e22e>ShutdownOnFailure</span>()) {
</span></span><span style=display:flex><span>        Supplier<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>  user  <span style=color:#f92672>=</span> scope.<span style=color:#a6e22e>fork</span>(() <span style=color:#f92672>-&gt;</span> findUser());
</span></span><span style=display:flex><span>        Supplier<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> order <span style=color:#f92672>=</span> scope.<span style=color:#a6e22e>fork</span>(() <span style=color:#f92672>-&gt;</span> fetchOrder());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        scope.<span style=color:#a6e22e>join</span>()            <span style=color:#75715e>// Join both subtasks</span>
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>throwIfFailed</span>();  <span style=color:#75715e>// ... and propagate errors</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Here, both subtasks have succeeded, so compose their results</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Response(user.<span style=color:#a6e22e>get</span>(), order.<span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/StructuredTaskScope.html target=_blank rel=noopener>StructuredTaskScope</a>を利用して処理を行う場合、以下のメリットがあります。</p><ul><li>findUser()やfecthOrder()のどちらかが失敗したら、残りの処理はキャンセルされる</li><li>handle()を実行しているスレッドがインタラプトされた場合、findUser()とfetchOrder()はキャンセルされる</li><li>処理が明確に理解できる</li></ul><h2 id=api>API</h2><p>今回の新しいAPIに関しては、言語スペックでよく説明されており、新しいJavadocの方でそれぞれのバージョン別にどんなものが追加されたかフィルタしながら確認ができるので、ここでは<a class=link href=https://download.java.net/java/early_access/jdk21/docs/api/new-list.html target=_blank rel=noopener>Javadocのリンク</a>だけを貼っておきます。</p><h2 id=最後に>最後に</h2><p>いかがだったでしょうか。私はもうJavaでアプリを書くことはほとんどなく、主にKotlinを書いていて、新しいAPIもそこまでコードに影響を与えることはないのですが、それでもJavaの新しいバージョンがリリースされると、なんだか嬉しくなりますね。特にVirtual ThreadのようなAPIはKotlinでも使えるし、Javaで作成されたTomcatやNettyのようなミドルウェアの性能もこれを活用することでさらに性能が上がると思うとありがたいです。他にも追加されるAPIはKotlinとはまた違うアプローチをしているので大変勉強になるなと思いました。</p><p>今は仕事でJava 17を使っているのですが、Java 21になったらすぐにでも使いたいと思います。特に来年はKotlinも2.0がリリースされるので、Javaの新機能を活かしてKotlinのビルドもパフォーマンスもさらに向上させていきたいなと思います。</p><p>では、また！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/kotlin/>Kotlin</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/java-enter-to-17/><div class=article-image><img src=/images/java.jpg loading=lazy data-key data-hash=/images/java.jpg></div><div class=article-details><h2 class=article-title>Java 17は何が変わったか</h2></div></a></article><article class=has-image><a href=/posts/java-string-concat-and-split/><div class=article-image><img src=/images/java.jpg loading=lazy data-key data-hash=/images/java.jpg></div><div class=article-details><h2 class=article-title>今更な文字列操作の話</h2></div></a></article><article class=has-image><a href=/posts/java-file-copy/><div class=article-image><img src=/images/java.jpg loading=lazy data-key data-hash=/images/java.jpg></div><div class=article-details><h2 class=article-title>今更なI/Oの話</h2></div></a></article><article class=has-image><a href=/posts/java-new-methods-from-9-to-11/><div class=article-image><img src=/images/java.jpg loading=lazy data-key data-hash=/images/java.jpg></div><div class=article-details><h2 class=article-title>9からの新メソッドめぐり</h2></div></a></article><article class=has-image><a href=/posts/java-collection-loop/><div class=article-image><img src=/images/java.jpg loading=lazy data-key data-hash=/images/java.jpg></div><div class=article-details><h2 class=article-title>今更なループの話</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2024 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>