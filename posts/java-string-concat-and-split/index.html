<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="もうこれで3回目の、「今更なシリーズ」です。このシリーズ自体は、またベンチマークとともに戻ってきました。さて、今回のテーマはJavaによる文"><title>今更な文字列操作の話</title><link rel=canonical href=https://retheviper.github.io/posts/java-string-concat-and-split/><link rel=stylesheet href=/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css><meta property="og:title" content="今更な文字列操作の話"><meta property="og:description" content="もうこれで3回目の、「今更なシリーズ」です。このシリーズ自体は、またベンチマークとともに戻ってきました。さて、今回のテーマはJavaによる文"><meta property="og:url" content="https://retheviper.github.io/posts/java-string-concat-and-split/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="java"><meta property="article:tag" content="string"><meta property="article:published_time" content="2021-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-08T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/java.jpg"><meta name=twitter:title content="今更な文字列操作の話"><meta name=twitter:description content="もうこれで3回目の、「今更なシリーズ」です。このシリーズ自体は、またベンチマークとともに戻ってきました。さて、今回のテーマはJavaによる文"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/java.jpg"><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BYJBEJB6DX",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/java-string-concat-and-split/><img src=/../../images/java.jpg loading=lazy alt="Featured image of post 今更な文字列操作の話"></a></div><div class=article-details><header class=article-category><a href=/categories/java/ style=background-color:#2a9d8f;color:#fff>java</a></header><h2 class=article-title><a href=/posts/java-string-concat-and-split/>今更な文字列操作の話</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 08, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>15 minute read</time></div></footer></div></header><section class=article-content><p>もうこれで3回目の、「今更なシリーズ」です。このシリーズ自体は、またベンチマークとともに戻ってきました。さて、今回のテーマはJavaによる文字列の操作となりますが、その中でも<code>連結(Join)</code>と<code>分割(split)</code>について述べたいと思います。最初は単純に、文字列の分割は<code>String.split()</code>でやるしかないのに、連結の場合は<code>String.join()</code>とか<code>Collectors.joining()</code>とか、色々あるなと思ったのがきっかけです。同じことが複数のAPIでできるのは、単純に<a class=link href=https://ja.wikipedia.org/wiki/%e7%b3%96%e8%a1%a3%e6%a7%8b%e6%96%87 target=_blank rel=noopener>シンタックスシュガー</a>な場合もありますが、実際は全く実装が違うケースもありますね。特に、Javaのように長い間使われてきた言語こそそのようなケースが多いかと思います。</p><p>また、単純なシンタックスシュガーに近い場合でも、その前後のコードや可読性など、周りの様相を考慮して適切なものを選ぶ必要がある場合もあります。例えば、以前紹介したInputStreamの<code>transferTo()</code>がそのようなケースですね。なので、一つのAPIを使う場合は、できればその実装がどうなっているかを確認してみるのも、良いコードを書くための工夫となるのではないかと思います。</p><p>ではでは、早速本題に入りましょう。まずは文字列の連結からです。</p><h2 id=concatenating>Concatenating</h2><p>文字列の連結といっても、色々なケースがありますね。そしてそういった場合は、<code>String.concat()</code>、<code>String.format()</code>などさまざまな方法があって、それら全部に対してシナリオを想定し検証するということは難しいと思います。なので今回は、「文字列の配列もしくはCollectionを、区切り文字でつないで一つの文字列にする」というケース一つに限定して述べたいと思います。</p><p>Javaでの区切り文字を使った文字列の連結には、主に以下のような方法が考えられます。これら一つ一つのAPIの特徴と、実際の使い方を持って比較して見た後、いつもの通りベンチマークをするということで性能を測定することとします。(<code>+</code>を使って文字列を繋ぐケースは、あまりよろしくないと思うのでケース外としています)</p><ul><li><code>String.join()</code></li><li><code>StringJoiner</code></li><li><code>StringBuffer</code></li><li><code>StringBuilder</code></li><li><code>Collectors.joining()</code></li></ul><h3 id=stringbuffer--stringbuilder>StringBuffer || StringBuilder</h3><p>純粋に、Collectionや配列になっている複数の文字列を連結する場合もあるとは思いますが、普通、文字列の連結が必要となる場合では、「とある規則によって」という条件がつくケースが多いかなと思います。例えば、ダッシュ(-)、アンダースコア(_)、カンマ(,)などで並ぶようにですね。そしてこのような規則がある場合、<code>StringBuffer</code>や<code>StringBuilder</code>を使った方法は他と比べて少し不利です。なぜなら、最後に区切り文字(delimiter)が付かないように制御するにはかなりコードの書き方に注意しなければならないからです。以下のコードが、そのようなケースです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// StringBufferを使う例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> List<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;B&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;C&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>String delimiter <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>StringBuffer buffer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuffer<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listの要素と区切り文字を足す
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String string <span style=color:#ff79c6>:</span> list<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>string<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// A, B, C,
</span></span></span></code></pre></div><p>あえて、文字列の末尾に区切り文字が付かないようにするとしたら、おそらくこういうコードを書く必要があるでしょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> List<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;B&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;C&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>String delimiter <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> limit <span style=color:#ff79c6>=</span> list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>StringBuffer buffer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuffer<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listの要素と区切り文字を足す(最後のインデックスの前まで)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> limit<span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 最後の要素を足す
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>limit<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// A, B, C
</span></span></span></code></pre></div><p>こういう問題があるのに比べて、他の方法(<code>String.join()</code>、<code>StringJoiner</code>、<code>Collectors.joining()</code>)は、区切り文字が最後の要素の後に付かないので、よりシンプルなコードで書けるというメリットがありますね。なので、結論として<code>StringBuffer</code>や<code>StringBuilder</code>は、少なくとも「とある規則によって」複数の文字列を連結する場合には可読性という観点からしてあまり良い選択肢ではないということがわかります。</p><h3 id=stringjoiner>StringJoiner</h3><p><code>StringBuffer</code>と<code>StringBuilder</code>ではループで文字列を連結して行くので、ループの中で条件分岐など他の処理も必要な場合に使えるのでは？と思われるかも知れません。しかし、そういう場合でも、<code>StringJoiner</code>を使ったほうが良いですね。なぜなら、使い方はほぼ変わらなく、特に操作をしなくても常に末尾に区切り文字が付かないからです。以下は、<code>StringJoiner</code>のもっともベーシックな使い方のコードとなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> List<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;B&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;C&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 区切り文字を指定してインスタンスを作る
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>StringJoiner joiner <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringJoiner<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// あとは要素を足していく
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String string <span style=color:#ff79c6>:</span> list<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>string<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// A, B, C
</span></span></span></code></pre></div><p>また、<code>StringJoiner</code>を使った場合は、PrefixとSuffixの指定も可能です。これらを指定した場合、文字列の先頭と末尾に指定したPrefixとSuffixが付くようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> List<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;B&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;C&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 区切り文字とPrefix、Suffixまで指定する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>StringJoiner joiner <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringJoiner<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;[&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;]&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String string <span style=color:#ff79c6>:</span> list<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>string<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// [A, B, C]
</span></span></span></code></pre></div><p>使い方だけ見ても、区切り文字を持って文字列を繋ぐ場合は<code>StringBuffer</code>や<code>StringBuilder</code>より<code>StringJoiner</code>の方がより簡単であるということが分かります。</p><h4 id=番外stringjoinerの実装>番外：StringJoinerの実装</h4><p>ついでに、StringJoinerはどんなコードで書かれているかを見ていきたいと思います。まずは<code>add()</code>ですが、これは面白くも、<code>ArrayList</code>の実装と似たような感じになっています。<code>StringJoiner</code>クラスはフィールドとして<code>String[]</code>を持っていて、<code>add()</code>がよばれる度にそれより大きいコピーを作っていく形です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> StringJoiner <span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>CharSequence newElement<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> String elt <span style=color:#ff79c6>=</span> String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>valueOf</span><span style=color:#ff79c6>(</span>newElement<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>elts <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        elts <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[</span>8<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>size <span style=color:#ff79c6>==</span> elts<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>            elts <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>copyOf</span><span style=color:#ff79c6>(</span>elts<span style=color:#ff79c6>,</span> 2 <span style=color:#ff79c6>*</span> size<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        len <span style=color:#ff79c6>+=</span> delimiter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    len <span style=color:#ff79c6>+=</span> elt<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    elts<span style=color:#ff79c6>[</span>size<span style=color:#ff79c6>++]</span> <span style=color:#ff79c6>=</span> elt<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>そして<code>toString()</code>では、フィールドの<code>String[]</code>をループしながら、区切り文字とともに繋げて行くのが分かります。少し変わっているのは、性能を意識しているからか、<code>char[]</code>として文字列をつめた後から新しく<code>String</code>のインスタンスを作って返しているというところですね。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>toString</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> String<span style=color:#ff79c6>[]</span> elts <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>elts</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>elts <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> emptyValue <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> emptyValue<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> size <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> addLen <span style=color:#ff79c6>=</span> prefix<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> suffix<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>addLen <span style=color:#ff79c6>==</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        compactElts<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> size <span style=color:#ff79c6>==</span> 0 <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> elts<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> String delimiter <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>delimiter</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>[]</span> chars <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>[</span>len <span style=color:#ff79c6>+</span> addLen<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> k <span style=color:#ff79c6>=</span> getChars<span style=color:#ff79c6>(</span>prefix<span style=color:#ff79c6>,</span> chars<span style=color:#ff79c6>,</span> 0<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>size <span style=color:#ff79c6>&gt;</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        k <span style=color:#ff79c6>+=</span> getChars<span style=color:#ff79c6>(</span>elts<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>],</span> chars<span style=color:#ff79c6>,</span> k<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 1<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> size<span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            k <span style=color:#ff79c6>+=</span> getChars<span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>,</span> chars<span style=color:#ff79c6>,</span> k<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            k <span style=color:#ff79c6>+=</span> getChars<span style=color:#ff79c6>(</span>elts<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>],</span> chars<span style=color:#ff79c6>,</span> k<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    k <span style=color:#ff79c6>+=</span> getChars<span style=color:#ff79c6>(</span>suffix<span style=color:#ff79c6>,</span> chars<span style=color:#ff79c6>,</span> k<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>(</span>chars<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=stringjoin>String.join()</h3><p><code>String.join()</code>は、<code>InputStream.transferTo()</code>のように、あくまでシンタックスシュガーとして存在するものだと言えます。以下は実際のコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> String <span style=color:#50fa7b>join</span><span style=color:#ff79c6>(</span>CharSequence delimiter<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>        Iterable<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> CharSequence<span style=color:#ff79c6>&gt;</span> elements<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Objects<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requireNonNull</span><span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    Objects<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requireNonNull</span><span style=color:#ff79c6>(</span>elements<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    StringJoiner joiner <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringJoiner<span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>CharSequence cs<span style=color:#ff79c6>:</span> elements<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>cs<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> joiner<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>引数に対するNullチェック以外は、Prefix・Suffixなしの<code>StringJoiner</code>での連結になっているということを確認できます。なので、より短いコードを書きたい場合は<code>StringJoiner</code>を使うよりも、こちらの方が便利ではありますね。</p><h3 id=collectorsjoining>Collectors.joining()</h3><p>文字列の連結で<code>Stream</code>を利用する場合、他にも<code>filter()</code>、<code>map()</code>、<code>peek()</code>など、さまざまな処理をメソッドチェイニングで書けるというところが魅力的ですね。個人的には、処理の役割と目的・影響範囲が明確に見えるので、<code>Stream</code>による処理を好んで使っています。ただ、以前のポストでも書いたことがありますが、多くの場合に<code>Stream</code>は伝統的なループより性能面で不利ですので、時と場合によって適切に選ぶべきでしょう。</p><p>さて、そんな<code>Stream</code>ですが、中の実装はどうなっているのでしょうか。<code>Collectors.joining()</code>の場合、以下のような実装となっています。結局は、<code>StringJoiner</code>を内部で使っているだけですので、<code>String.join()</code>・<code>StringJoiner</code>と比べては、<code>Stream</code>によるコードの変化や性能に影響されるだけと言えるでしょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Collector<span style=color:#ff79c6>&lt;</span>CharSequence<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>?,</span> String<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>joining</span><span style=color:#ff79c6>(</span>CharSequence delimiter<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>                                                            CharSequence prefix<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>                                                            CharSequence suffix<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> CollectorImpl<span style=color:#ff79c6>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>new</span> StringJoiner<span style=color:#ff79c6>(</span>delimiter<span style=color:#ff79c6>,</span> prefix<span style=color:#ff79c6>,</span> suffix<span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>            StringJoiner<span style=color:#ff79c6>::</span>add<span style=color:#ff79c6>,</span> StringJoiner<span style=color:#ff79c6>::</span>merge<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>            StringJoiner<span style=color:#ff79c6>::</span>toString<span style=color:#ff79c6>,</span> CH_NOID<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=tostring>toString()</h3><p>実は、Collectionの場合(<code>List&lt;String></code>)は、もっと簡単に文字列を作る方法がありますね。<code>toString()</code>を呼ぶことで、簡単にカンマ区切りの文字列が出来上がります。ただ、そうして文字列を作った場合、先頭と末尾に<code>[]</code>が入ってしまうので、場合によってはそれらを取り消すか、<code>substring()</code>で抽出するかの追加的な処理が必要となりますね。以下は、<code>substring()</code>を利用して<code>[]</code>の中の文字列だけを切り取るサンプルとなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> List<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;B&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;C&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>String toString <span style=color:#ff79c6>=</span> list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// [A, B, C]
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>String result <span style=color:#ff79c6>=</span> toString<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>,</span> toString<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// A, B, C
</span></span></span></code></pre></div><p>また、もし区切り文字がカンマではない場合は、とりあえず<code>toString()</code>で文字列に変換した結果の文字列から、更に<code>replace()</code>を呼び出し、区切り文字だけを入れ替えるというやり方でも対応はできます。ただ、これは非常に非効率的なやり方ではあります。なぜなら、<code>replace()</code>のコードをみると、結局はループの中で<code>StrinbBuilder</code>を使って新しく作り出すような構造となっているからです。実際のコードは、以下の通りです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>replace</span><span style=color:#ff79c6>(</span>CharSequence target<span style=color:#ff79c6>,</span> CharSequence replacement<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String tgtStr <span style=color:#ff79c6>=</span> target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    String replStr <span style=color:#ff79c6>=</span> replacement<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> indexOf<span style=color:#ff79c6>(</span>tgtStr<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>j <span style=color:#ff79c6>&lt;</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> tgtLen <span style=color:#ff79c6>=</span> tgtStr<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> tgtLen1 <span style=color:#ff79c6>=</span> Math<span style=color:#ff79c6>.</span><span style=color:#50fa7b>max</span><span style=color:#ff79c6>(</span>tgtLen<span style=color:#ff79c6>,</span> 1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> thisLen <span style=color:#ff79c6>=</span> length<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> newLenHint <span style=color:#ff79c6>=</span> thisLen <span style=color:#ff79c6>-</span> tgtLen <span style=color:#ff79c6>+</span> replStr<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>newLenHint <span style=color:#ff79c6>&lt;</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> OutOfMemoryError<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    StringBuilder sb <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuilder<span style=color:#ff79c6>(</span>newLenHint<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>do</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        sb<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>,</span> j<span style=color:#ff79c6>).</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>replStr<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        i <span style=color:#ff79c6>=</span> j <span style=color:#ff79c6>+</span> tgtLen<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>j <span style=color:#ff79c6>&lt;</span> thisLen <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>j <span style=color:#ff79c6>=</span> indexOf<span style=color:#ff79c6>(</span>tgtStr<span style=color:#ff79c6>,</span> j <span style=color:#ff79c6>+</span> tgtLen1<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>&gt;</span> 0<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> sb<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>,</span> thisLen<span style=color:#ff79c6>).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>少なくとも区切り文字がカンマではない場合は、<code>toString()</code>と<code>replace()</code>での文字列の生成よりは、他の方法をとったほうが性能面では有利ではないか、という推測が可能です。もちろん、要素数という変数があるので、実際の性能は測ってみないとわからないものですが…</p><h3 id=ベンチマークしてみる>ベンチマークしてみる</h3><p>では、文字列を連結するために使える色々なAPIと、その特徴を簡単に把握できたので、次に確認したいのは、やはり性能です。特に気になるのは、<code>String.join()</code>や<code>Collectors.joining()</code>でも結局は内部で<code>StringJoiner</code>を使っているというところです。それはつまり、<code>StringBuffer</code>や<code>StringBuilder</code>よりも<code>StringJoiner</code>が性能で有利だから、でしょうか。</p><p>これらのAPIを利用して、実際のアプリケーションに使われるビジネスロジックのコードを書く立場としては、それはコードを簡単に書ける方が良いのは当然ですが、そもそもこういうAPIの場合は、手間を省けるために性能は良くても複雑なコードで実装する可能性もあるのですので、疑問になります。しかも、多くの場合、文字列の操作では<code>StringBuilder</code>が早いと言われていますので、ますます性能差というのが気になってきます。なので、いつもの通りにベンチマークを実施してみました。</p><p>ベンチマークは、カンマ区切りで文字列を連結する例として作成しています。以下がそのコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@State<span style=color:#ff79c6>(</span>Scope<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Benchmark</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>StringConcatTest</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String DELIMITER <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> target<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Setup
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> DecimalFormat format <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DecimalFormat<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;0000000&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span> <span style=color:#ff79c6>=</span> IntStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rangeClosed</span><span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>,</span> 1000000<span style=color:#ff79c6>).</span><span style=color:#50fa7b>mapToObj</span><span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>-&gt;</span> format<span style=color:#ff79c6>.</span><span style=color:#50fa7b>format</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>)).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toList</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>toString</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> String toString <span style=color:#ff79c6>=</span> target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>toString<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>,</span> toString<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>stringJoin</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>join</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>,</span> target<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>collectorsJoining</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stream</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>joining</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>stringBuffer</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> StringBuffer buffer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuffer<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> limit <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> limit<span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>            buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>limit<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>buffer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>stringBuilder</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> StringBuilder builder <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuilder<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> limit <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> limit<span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            builder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>            builder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        builder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>limit<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>builder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>そして、結果は以下の通りです。</p><pre tabindex=0><code class=language-dos data-lang=dos>Benchmark                            Mode  Cnt   Score   Error  Units
StringConcatTest.toString           thrpt   25  41.445 ± 0.461  ops/s
StringConcatTest.stringJoin         thrpt   25  28.396 ± 0.447  ops/s
StringConcatTest.collectorsJoining  thrpt   25  31.024 ± 1.313  ops/s
StringConcatTest.stringBuffer       thrpt   25  30.570 ± 1.205  ops/s
StringConcatTest.stringBuilder      thrpt   25  45.965 ± 1.736  ops/s
</code></pre><p>この結果からわかるのは、やはり<code>StringBuilder</code>の性能は優秀ということですね。ただ、よく知られているように、<code>StringBuilder</code>はマルチスレッドを考慮したAPIではないので、スレッドセーフなAPIを使う必要のある環境であるなら、他のAPIを考慮すべきですね。そのような観点からすると、意外と、誤差範囲を踏まえて考えると<code>String.join()</code>が<code>Collectors.joining()</code>と大差ない性能を見せるという結果となりましたが…このような結果だとすると、気軽に<code>Stream</code>を使っても良さそうな気がします。</p><p>また、<code>toString()</code>の結果は、やはり早いものとなっていますが、ここで<code>replace()</code>を挟んだ瞬間性能は半分以下という結果となっています。なので、無理して<code>toString()</code>を使う必要はあまりないかな、と思いますね。文字列の連結という目的に合うコードかどうかもすぐわからないし…</p><p>もう一つ確かなのは、<code>StringBuffer</code>はもう使わなくても良さそうということですね。もうレガシーなコードとして残しておいて、これからはなるべく違うAPIを使うべきなのではないかと思います。</p><h2 id=split>Split</h2><p>次に検証したいのは、文字列の分割です。先に述べたのように、文字列の分割は実質、<code>String.split()</code>しかない状態と言えますね。<code>substring()</code>でもなんとか分割はできるかも知れませんが、その場合はループと条件分岐なしでは話にならないので、そもそも論外かと思います。</p><p>ただ、ここで注目したいのは分割した後のことです。<code>String.split()</code>の戻り値は<code>String[]</code>なので、場合によって<code>Collection</code>に変えたくなりますね。なので、どちらかというと「配列をListに」する方法の検証ということとなりますが…とりあえずListをStringに変えてみたので、その逆の場合を考えてみるということで受け止めてくださると幸いです。</p><h3 id=arraysaslist>Arrays.asList()</h3><p>配列をListに変えるもっとも簡単な方法は、<code>Arrays.asList()</code>だと思います。コードも簡単ですね。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String string <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;A, B, C&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// まずは分割する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>String<span style=color:#ff79c6>[]</span> array <span style=color:#ff79c6>=</span> string<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listに変える
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>ただ、こうやって生成したListのインスタンスは、<a class=link href=https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%96%E3%83%AB target=_blank rel=noopener>Immutable</a>となってしまいます。中の要素を操作できないということですね。</p><p>もちろん、これは新しいListのインスタンスに要素をコピーすることで解決できます。もっとも簡単なのは、コンストラクタの引数としてListを渡す方法ですね。なので、「配列をMutableなListにする」もっとも簡単な方法は、おそらく以下のようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String string <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;A, B, C&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// まずは分割する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>String<span style=color:#ff79c6>[]</span> array <span style=color:#ff79c6>=</span> string<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listに変える
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> list <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// MutableなListのインスタンスを作成する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> mutableList <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;(</span>list<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><h3 id=arraysstream>Arrays.stream()</h3><p>配列をListにするまたの方法は、<code>Stream</code>を利用することです。文字列の連結でも言及したことなのですが、<code>Stream</code>の場合は、<code>map()</code>や<code>filter()</code>のような中間操作のメソッドを使えるというメリットがありますね。また、<code>Collectors</code>のどのメソッドを呼ぶかによって結果として生成されるListがImmutableか、Mutableかを決定できるという面もメリット(可読性という観点で)ではないのかと思います。コードは<code>Arrays.asList()</code>と比べて少し複雑になっているように見えるかも知れませんが。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String string <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;A, B, C&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// まずは分割する
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>String<span style=color:#ff79c6>[]</span> array <span style=color:#ff79c6>=</span> string<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listに変える(Mutable)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> mutableList <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stream</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toList</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Listに変える(Immutable)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> mutableList <span style=color:#ff79c6>=</span> Stream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toUnmodifiableList</span><span style=color:#ff79c6>());</span>
</span></span></code></pre></div><h3 id=ベンチマークしてみる-1>ベンチマークしてみる</h3><p>では、次にまたベンチマークとなります。コード自体は明らかに<code>Arrays.toList()</code>の方が簡単だったのですが、MutableなListを作るためにはListを生成した後にさらにインスタンスを作成する必要があるということで、性能面で損する可能性もあるのかなという気がします。なので、以上で紹介した<code>Arrays.asList()</code>と<code>Stream</code>によるListのインスタンスの作成を、Immutable・Mutableという二つのケースに分けて検証してみました。以下がそのベンチマークのコードです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@State<span style=color:#ff79c6>(</span>Scope<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Benchmark</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>StringSplitTest</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String DELIMITER <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;, &#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String target<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Setup
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> DecimalFormat format <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DecimalFormat<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;0000000&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>target</span> <span style=color:#ff79c6>=</span> IntStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rangeClosed</span><span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>,</span> 1000000<span style=color:#ff79c6>).</span><span style=color:#50fa7b>mapToObj</span><span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>-&gt;</span> format<span style=color:#ff79c6>.</span><span style=color:#50fa7b>format</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>)).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>joining</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>arraysAsListImmutable</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>arraysAsListMutable</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>))));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>streamCollectImmutable</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stream</span><span style=color:#ff79c6>(</span>target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>)).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toUnmodifiableList</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Benchmark
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>streamCollectMutable</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> Blackhole bh<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        bh<span style=color:#ff79c6>.</span><span style=color:#50fa7b>consume</span><span style=color:#ff79c6>(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stream</span><span style=color:#ff79c6>(</span>target<span style=color:#ff79c6>.</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span>DELIMITER<span style=color:#ff79c6>)).</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toList</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>そして結果は以下の通りです。</p><pre tabindex=0><code class=language-dos data-lang=dos>Benchmark                                Mode  Cnt  Score   Error  Units
StringSplitTest.arraysAsListImmutable   thrpt   25  8.316 ± 1.085  ops/s
StringSplitTest.arraysAsListMutable     thrpt   25  8.133 ± 0.435  ops/s
StringSplitTest.streamCollectImmutable  thrpt   25  6.086 ± 0.312  ops/s
StringSplitTest.streamCollectMutable    thrpt   25  7.247 ± 0.262  ops/s
</code></pre><p>ここでは、<code>Arrays.asList()</code>の方が、性能が高い結果となっていますね。途中で何かしらの操作が必要な場合は<code>Stream</code>の方が良いかと思いますが、そうではなく、単純に配列をListに変えたい場合はやはり<code>Arrays.AsList()</code>を使った方がコードもより簡単で、性能面でも少し優勢ということがわかりました。なので、(いつもそうですが)何をしたいかによって適切なコードを選ぶべきかんと思います。</p><h2 id=最後に>最後に</h2><p>他にも、文字列の操作に関しては<a class=link href=https://www.baeldung.com/java-string-performance target=_blank rel=noopener>Baeldungさんの記事</a>がかなり良かったので、皆さんにもおすすめしたいと思います。最近は特に、アプリケーションでもっともよく扱うデータ型が文字列となっているので、文字列の操作に関してはなるべく性能と可読性という観点から良い書き方を取りたいものです。個人的には<code>Stream</code>が大好きなので、なるべくなんでも<code>Stream</code>で解決したいものですが…Javaだけでなく、プログラミング言語にとって「どんなケースでも正解」というものはないので。</p><p>しかし、Javaに触れてからもう3年も過ぎていますが、今更こんなことを考えるということが恥ずかしい限りですね…次からは、もっと興味深い(そしてこのブログを読まれる方々にも役立つような)ネタを探したいと思います。うまくいくかは少しわからない状態なのですが…！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>java</a>
<a href=/tags/string/>string</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/java-new-methods-from-9-to-11/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>9からの新メソッドめぐり</h2></div></a></article><article class=has-image><a href=/posts/java-enter-to-17/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>Java 17は何が変わったか</h2></div></a></article><article class=has-image><a href=/posts/java-file-copy/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>今更なI/Oの話</h2></div></a></article><article class=has-image><a href=/posts/java-collection-loop/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>今更なループの話</h2></div></a></article><article class=has-image><a href=/posts/java-string-pattern-validator/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>パターンと一致する文字列かを判定する</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2022 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#concatenating>Concatenating</a><ol><li><a href=#stringbuffer--stringbuilder>StringBuffer || StringBuilder</a></li><li><a href=#stringjoiner>StringJoiner</a><ol><li><a href=#番外stringjoinerの実装>番外：StringJoinerの実装</a></li></ol></li><li><a href=#stringjoin>String.join()</a></li><li><a href=#collectorsjoining>Collectors.joining()</a></li><li><a href=#tostring>toString()</a></li><li><a href=#ベンチマークしてみる>ベンチマークしてみる</a></li></ol></li><li><a href=#split>Split</a><ol><li><a href=#arraysaslist>Arrays.asList()</a></li><li><a href=#arraysstream>Arrays.stream()</a></li><li><a href=#ベンチマークしてみる-1>ベンチマークしてみる</a></li></ol></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>