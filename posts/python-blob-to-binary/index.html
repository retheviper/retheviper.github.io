<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="あまり詳しくない上に、何か新しいプログラムを作り出すこととは少し距離があるなと思ってDBにはあまり興味を持ってなかった私ですが、ITの業界で"><title>PythonでDBの処理がしたい</title>
<link rel=canonical href=https://retheviper.github.io/posts/python-blob-to-binary/>
<link rel=stylesheet href=/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css><meta property="og:title" content="PythonでDBの処理がしたい">
<meta property="og:description" content="あまり詳しくない上に、何か新しいプログラムを作り出すこととは少し距離があるなと思ってDBにはあまり興味を持ってなかった私ですが、ITの業界で">
<meta property="og:url" content="https://retheviper.github.io/posts/python-blob-to-binary/">
<meta property="og:site_name" content="Korean-man in Tokyo">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="oracle"><meta property="article:tag" content="postgresql"><meta property="article:tag" content="blob"><meta property="article:tag" content="python"><meta property="article:published_time" content="2019-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2019-06-30T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/python.jpg">
<meta name=twitter:title content="PythonでDBの処理がしたい">
<meta name=twitter:description content="あまり詳しくない上に、何か新しいプログラムを作り出すこととは少し距離があるなと思ってDBにはあまり興味を持ってなかった私ですが、ITの業界で"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://retheviper.github.io/images/python.jpg">
<link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png>
<link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png>
<link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png>
<link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png>
<link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png>
<link rel=manifest href=/favicon/manifest.json>
<meta name=msapplication-TileColor content="#ffffff">
<meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png">
<meta name=theme-color content="#ffffff">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-139986442-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/posts/python-blob-to-binary/>
<img src=/../../images/python.jpg loading=lazy alt="Featured image of post PythonでDBの処理がしたい">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/categories/python/ style=background-color:#2a9d8f;color:#fff>
python
</a>
</header>
<h2 class=article-title>
<a href=/posts/python-blob-to-binary/>PythonでDBの処理がしたい</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 30, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
11 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>あまり詳しくない上に、何か新しいプログラムを作り出すこととは少し距離があるなと思ってDBにはあまり興味を持ってなかった私ですが、ITの業界で働きながらDBと接しないのは難しいことです。そしてそうやって接するDBはまた優しくない課題になってきますね。この度の仕事でも主にPythonを使ってスクリプトを書いたものの、そのタスクのメインとなるものはDBとの連携でした。なので今回のポストではどうやってPythonでDBに繋ぎ、SQL文を発行し、そのデータを扱ったかについて述べたいと思います。</p>
<p>今回私に与えられたタスクは、DBからバイナリーのデータを抽出して、それをAWSのS3<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>にアップロードするスクリプトを作ることでした。また、アップロードが終わった時点でテーブルを更新する必要がありますが、抽出の対象となるDBと更新の対象となるDBがそれぞれ違うものでした。片方はOracleで片方はPostgreSQL。そしてロガーを入れ各DBやS3の接続に失敗するなどの時にはログで分かるようにしたり、DBの接続情報を外出しにして外部ファイルから読み込むようにするなどの条件がありました。ロガーについては[前回のポスト](../../../06/15/python-logger/で述べましたので、今回は省略とさせていただきます。他にバイナリーデータを抽出するには引数を受け、最終更新日を確認した上でそれより後のファイルを保存する、S3にアップロードする際はテーブルのカラムからパス名を決める、画像のアップロードの後には最終更新日を更新する、などの条件がありました。</p>
<p>要略すると、今回作るスクリプトの仕様は以下となります。</p>
<ol>
<li>コマンドラインで引数を受ける</li>
<li>引数からPostgreSQLのテーブル(1)を参照し、引数に当たる作業の最終更新日を取得する</li>
<li>OcaleDBのテーブルから最終更新日以後のバイナリーデータをSELECTしてJPGファイルとして保存する</li>
<li>PostgreSQLのテーブル(2)からファイルの保存先のパスとなるカラムを取得する。</li>
<li>S3へJPGファイルごとのフォルダーに画像をアップロードする</li>
<li>PostgreSQLのテーブル(3)にアップロードされたJPGファイルの情報を記録する</li>
<li>PostgreSQLのテーブル(1)最終更新日を更新する</li>
<li>正常終了したらexitコード0となり、例外が発生するとexitコード9を出力して終了する</li>
</ol>
<p>PostgreSQLの場合は参照するテーブルが多く、処理の順番があるので少し複雑にも感じられますが、まずはDBとの連動を試しみスクリプトを組むことにしました。</p>
<h2 id=pythonでdbを連動する>PythonでDBを連動する</h2>
<p>案外、PythonでDBに接続することはそんな難しいことではなかったです。それぞれ違うモジュールを使っていてコマンドにも違いがあるわけですが、検索してみると例題が多かったですね。Oracleの場合はホスト名、ポート、サービス名、ユーザー名、パスワードを用意します。使うモジュールは<code>cx_Oracle</code>です。</p>
<p>PostgreSQLの場合は、<code>psycopg2</code>を使います。接続に必要となる情報はホスト名、ポート、DB名、ユーザー名、パスワードです。ただし、モジュールは両方<code>pip</code>からインストールできますが、psycopg2の場合はライブラリー依存性があるのでAmazon Linuxを基準に<code>postgresql-develop</code>をyumからインストールする必要があります。他は触れたことがないのでよくわかりませんが、CentOSも同様かと。psycopg2のインストールに問題が生じたらエラーメッセージを確認して、必要なPosgreSQLのライブラリーをインストールしましょう。</p>
<p>二つのDBに接続するための手順には少し違いがありますが、接続した後の処理は同じです(本当はSQL文の文法も少し違うようですが…)。それではOracleとPostgreSQLの接続方法と接続以後の処理を分けて説明しましょう。</p>
<h3 id=接続oracleの場合>接続(Oracleの場合)</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>cx_Oracle</span>

<span class=n>tns</span> <span class=o>=</span> <span class=n>cx_Oracle</span><span class=o>.</span><span class=n>makedsn</span><span class=p>(</span><span class=s1>&#39;ホスト名&#39;</span><span class=p>,</span> <span class=s1>&#39;ポート&#39;</span><span class=p>,</span> <span class=s1>&#39;サービス名&#39;</span><span class=p>)</span>
<span class=n>connect</span> <span class=o>=</span> <span class=n>cx_Oracle</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;ユーザー名&#39;</span><span class=p>,</span> <span class=s1>&#39;パスワード&#39;</span><span class=p>,</span> <span class=n>tns</span><span class=p>)</span>
</code></pre></div><p>cx_Oracleの<code>makedsn</code>にホスト名、ポート、サービス名を入れます。そしてその情報を<code>connect</code>を使う際にユーザー名、パスワードと共に入れます。これでOracleの接続設定は終わりです。</p>
<h3 id=接続postgresqlの場合>接続(PostgreSQLの場合)</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>psycopg2</span>

<span class=n>connect</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;host=&#39;</span> <span class=o>+</span> <span class=s1>&#39;ホスト名&#39;</span> <span class=o>+</span> <span class=s1>&#39; port=&#39;</span> <span class=o>+</span> <span class=s1>&#39;ポート&#39;</span> <span class=o>+</span> <span class=s1>&#39; dbname=&#39;</span> <span class=o>+</span> <span class=s1>&#39;DB名&#39;</span> <span class=o>+</span> <span class=s1>&#39; user=&#39;</span> <span class=o>+</span> <span class=s1>&#39;ユーザー名&#39;</span> <span class=o>+</span> <span class=s1>&#39; password=&#39;</span> <span class=o>+</span> <span class=s1>&#39;パスワード&#39;</span><span class=p>)</span>
</code></pre></div><p>PostgreSQLの場合はより簡単です。Linuxで使うコマンドラインツールの<code>psql</code>みたいに、接続に必要な情報を文字列として並び<code>connect</code>すれば終了です。</p>
<h3 id=db処理の共通部分>DB処理の共通部分</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># 実際DBに接続してカーソルを取得</span>
<span class=n>cursor</span> <span class=o>=</span> <span class=n>connect</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
<span class=c1># カーソルからSQL文の実行</span>
<span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;発行したいSQL文&#39;</span><span class=p>)</span>

<span class=c1># SQL文を実行した結果を取得</span>
<span class=c1># 一件だけの結果が必要な時</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
<span class=c1># 結果を1000件づつフィッチして処理したい場合</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchmany</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
<span class=c1># 結果を全部フェッチしたい場合</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>

<span class=c1># カーソルをクローズする</span>
<span class=n>cursor</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=c1># SQL文をコミットする(INSERT/UPDATEなどの変動)</span>
<span class=n>connect</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<span class=c1># コネクションを切る</span>
<span class=n>connect</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></div><p>接続したあとはカーソルを取得し、そのカーソルでSQL文を発行します。SQL文の実行結果を取得するには<code>fecth</code>を使いますが、処理したい結果の規模によって三つの選択肢があります。あと、大量のデータを処理したい場合はなるべく<code>fetchall</code>よりは<code>fetchmany</code>でフェッチサイズを指定して使う方が良いらしいです。データが多すぎると性能に影響が出ますので。フェッチまで終わって取得した結果は、Pythonでは一つのレコードを配列にして、それらを集めたリストになります。コードで言いますと以下のような形となります。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># &#39;SELECT column_1, column2 FROM TABLE&#39;の場合</span>

<span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchmany</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>

<span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span> <span class=c1># 結果は1000件のリストとなる</span>
    <span class=nb>print</span> <span class=n>row</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=c1># column_1の内容が出力される</span>
    <span class=nb>print</span> <span class=n>row</span> <span class=c1># column_2の内容が出力される</span>

</code></pre></div><p>これでDBの連動の基礎は終わりです。それでは早速、スクリプトのコードをいかに公開します。</p>
<h2 id=画像ファイルをs3へアップロードするコード>画像ファイルをS3へアップロードするコード</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># -*- coding: UTF-8 -*-</span>
<span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>cx_Oracle</span><span class=o>,</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>boto3</span><span class=o>,</span> <span class=nn>datetime</span><span class=o>,</span> <span class=nn>shutil</span>

<span class=n>function_code</span> <span class=o>=</span> <span class=s1>&#39;引数で受け取る&#39;</span>

<span class=c1># 以下、DB環境情報(DBConnection.confから読み込む)</span>
<span class=n>HOST_POST</span> <span class=o>=</span> <span class=s1>&#39;PostgreSQLの接続ホスト名&#39;</span>
<span class=n>PORT_POST</span> <span class=o>=</span> <span class=s1>&#39;PostgreSQLの接続ポート&#39;</span>
<span class=n>DB_NAME_POST</span> <span class=o>=</span> <span class=s1>&#39;PostgreSQLのDM名&#39;</span>
<span class=n>USER_POST</span> <span class=o>=</span> <span class=s1>&#39;PostgreSQLのユーザ名&#39;</span>
<span class=n>PWD_POST</span> <span class=o>=</span> <span class=s1>&#39;PostgreSQLのパスワード&#39;</span>
<span class=n>HOST_ORAC</span> <span class=o>=</span> <span class=s1>&#39;Oracleの接続ホスト名&#39;</span>
<span class=n>PORT_ORAC</span> <span class=o>=</span> <span class=s1>&#39;Oracleの接続ポート&#39;</span>
<span class=n>SERVICE_NAME</span> <span class=o>=</span> <span class=s1>&#39;Oracleのサービス名&#39;</span>
<span class=n>USER_ORAC</span> <span class=o>=</span> <span class=s1>&#39;Oracleのスキーマ名&#39;</span>
<span class=n>PWD_ORAC</span> <span class=o>=</span> <span class=s1>&#39;Oracleのパスワード&#39;</span>

<span class=c1># コマンドライン引数</span>
<span class=n>args</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span>

<span class=c1># 環境関連変数</span>
<span class=n>imageFolder</span> <span class=o>=</span> <span class=s1>&#39;/tmp/images&#39;</span>

<span class=c1># 差分連携のための前処理</span>
<span class=k>def</span> <span class=nf>GetProcdate</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>function_code</span>
    <span class=n>function_code</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
 
    <span class=k>try</span><span class=p>:</span>
        <span class=c1># PostgreSQL接続</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Starting Job. The function Code is: &#39;</span> <span class=o>+</span> <span class=n>function_code</span><span class=p>)</span>
        <span class=n>connect</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;host=&#39;</span> <span class=o>+</span> <span class=n>HOST_POST</span> <span class=o>+</span> <span class=s1>&#39; port=&#39;</span> <span class=o>+</span> <span class=n>PORT_POST</span> <span class=o>+</span> <span class=s1>&#39; dbname=&#39;</span> <span class=o>+</span> <span class=n>DB_NAME_POST</span> <span class=o>+</span> <span class=s1>&#39; user=&#39;</span> <span class=o>+</span> <span class=n>USER_POST</span> <span class=o>+</span> <span class=s1>&#39; password=&#39;</span> <span class=o>+</span> <span class=n>PWD_POST</span><span class=p>)</span>
        <span class=n>cursor</span> <span class=o>=</span> <span class=n>connect</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Unable to connect PostgreSQL. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>

    <span class=n>selectSQL</span> <span class=o>=</span> <span class=s2>&#34;SELECT last_date FROM date_table WHERE function_code=&#39;</span><span class=si>%s</span><span class=s2>&#39;&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>function_code</span><span class=p>,)</span>
    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>selectSQL</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>

    <span class=c1># 結果があった場合最終更新日を変数として保存</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=n>last_date</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; No data matches with &#39;</span> <span class=o>+</span> <span class=n>function_code</span> <span class=o>+</span> <span class=s1>&#39;. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

    <span class=n>cursor</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>connect</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

    <span class=c1># 次の処理へ移行</span>
    <span class=n>GetImageFromTable</span><span class=p>(</span><span class=n>last_date</span><span class=p>)</span>

<span class=c1># OracleにSQL文を発行してファイルを読み込み保存</span>
<span class=k>def</span> <span class=nf>GetImageFromTable</span><span class=p>(</span><span class=n>last_date</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>imageFolder</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=c1># Oracle接続開始</span>
        <span class=n>tns</span> <span class=o>=</span> <span class=n>cx_Oracle</span><span class=o>.</span><span class=n>makedsn</span><span class=p>(</span><span class=n>HOST_ORAC</span><span class=p>,</span> <span class=n>PORT_ORAC</span><span class=p>,</span> <span class=n>SERVICE_NAME</span><span class=p>)</span>
        <span class=n>connect</span> <span class=o>=</span> <span class=n>cx_Oracle</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>USER_ORAC</span><span class=p>,</span> <span class=n>PWD_ORAC</span><span class=p>,</span> <span class=n>tns</span><span class=p>)</span>
        <span class=n>cursor</span> <span class=o>=</span> <span class=n>connect</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Unable to connect Oracle DB. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>

    <span class=c1># Oracleのテーブルから商品画像ファイル取得</span>
    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT image_data, image_name FROM WHERE &gt;=(:last_date)&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;last_date&#39;</span><span class=p>:</span> <span class=n>last_date</span><span class=p>})</span>

    <span class=c1># フォルダがなかったら作成・あったら削除</span>
    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>):</span>
        <span class=n>shutil</span><span class=o>.</span><span class=n>rmtree</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>)</span>

    <span class=c1># 1000件づつ取り出し</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=n>rows</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchmany</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
        
        <span class=c1># 結果がない場合はループから出る</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>break</span>

        <span class=c1># 画像ファイル置き場に画像ファイル保存(イメージネーム.jpg)</span>
        <span class=k>for</span> <span class=n>image</span> <span class=ow>in</span> <span class=n>rows</span><span class=p>:</span>
            <span class=n>fileNameS</span> <span class=o>=</span> <span class=n>imageFolder</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;.jpg&#39;</span>
            <span class=n>imageFile</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>fileNameS</span><span class=p>,</span> <span class=s1>&#39;wb+&#39;</span><span class=p>)</span>
            <span class=n>imageFile</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
            <span class=n>imageFile</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
            <span class=n>counter</span> <span class=o>=</span> <span class=n>counter</span> <span class=o>+</span> <span class=mi>1</span>

    <span class=c1># 保存されたファイルの数をカウント</span>
    <span class=n>fileCount</span> <span class=o>=</span> <span class=nb>len</span><span class=p>([</span><span class=n>name</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>)</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>,</span> <span class=n>name</span><span class=p>))])</span>
    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; As result: &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>fileCount</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; files were written.&#39;</span><span class=p>)</span>
    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Finished job. Closing connection.&#39;</span><span class=p>)</span>
    <span class=n>cursor</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>connect</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>FileUploadToS3</span><span class=p>()</span>

<span class=c1># S3へ画像ファイルを格納</span>
<span class=k>def</span> <span class=nf>FileUploadToS3</span><span class=p>():</span>
    <span class=c1># グローバル変数取得</span>
    <span class=k>global</span> <span class=n>imageFolder</span>
    <span class=k>global</span> <span class=n>function_code</span>

    <span class=c1># ファイル名リスト(イメージネーム)取得</span>
    <span class=n>files</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>)</span>
    <span class=n>item_cd_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>f</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>files</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>imageFolder</span><span class=p>,</span> <span class=n>f</span><span class=p>))]</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=c1># PostgreSQL接続</span>
        <span class=n>connect</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;host=&#39;</span> <span class=o>+</span> <span class=n>HOST_POST</span> <span class=o>+</span> <span class=s1>&#39; port=&#39;</span> <span class=o>+</span> <span class=n>PORT_POST</span> <span class=o>+</span> <span class=s1>&#39; dbname=&#39;</span> <span class=o>+</span> <span class=n>DB_NAME_POST</span> <span class=o>+</span> <span class=s1>&#39; user=&#39;</span> <span class=o>+</span> <span class=n>USER_POST</span> <span class=o>+</span> <span class=s1>&#39; password=&#39;</span> <span class=o>+</span> <span class=n>PWD_POST</span><span class=p>)</span>
        <span class=n>cursor</span> <span class=o>=</span> <span class=n>connect</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Unable to connect PostgreSQL. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>

    <span class=c1># 結果確認用のファイル数カウンター</span>
    <span class=n>fileCount</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=k>for</span> <span class=n>item_cd</span> <span class=ow>in</span> <span class=n>item_cd_list</span><span class=p>:</span>
        <span class=c1># アイテム管理用テーブルからコードと一致するレコード取得⇒ファイル格納パス用</span>
        <span class=n>selectSQL1</span> <span class=o>=</span> <span class=s2>&#34;SELECT file_path1, file_path2, file_path3 FROM item_table WHERE item_cd=&#39;</span><span class=si>%s</span><span class=s2>&#39;&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>item_cd</span><span class=p>),)</span>
        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>selectSQL1</span><span class=p>)</span>
        <span class=n>resultMaster</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>

        <span class=c1># 一致するレコードがなかった場合でも処理続行</span>
        <span class=k>if</span> <span class=n>resultMaster</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Result was 0. continue job.&#39;</span><span class=p>)</span>
            <span class=k>continue</span>

        <span class=c1># 結果から必要な情報を取得し変数に保存</span>
        <span class=n>image_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>resultMaster</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
        <span class=n>path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>resultMaster</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>resultMaster</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>resultMaster</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span>

        <span class=c1># アイテムイメージ管理用テーブルからコードと一致するレコード取得⇒分岐処理</span>
        <span class=n>selectSQL2</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM WHERE image_table image_id=&#39;</span><span class=si>%s</span><span class=s2>&#39;;&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>image_id</span><span class=p>,)</span>
        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>selectSQL2</span><span class=p>)</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
        <span class=n>uploadToS3</span><span class=p>(</span><span class=n>item_cd</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
        <span class=n>fileCount</span> <span class=o>=</span> <span class=n>fileCount</span> <span class=o>+</span> <span class=mi>1</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Processing file upload.&#39;</span><span class=p>)</span>

    <span class=c1># 作業完了日時を更新</span>
    <span class=n>updateProcSQL</span> <span class=o>=</span> <span class=s2>&#34;UPDATE date_table SET last_date = CURRENT_TIMESTAMP WHERE function_code=&#39;</span><span class=si>%s</span><span class=s2>&#39;&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>function_code</span><span class=p>,)</span>
    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>updateProcSQL</span><span class=p>)</span>

    <span class=c1># 作業終了</span>
    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; As result: &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>fileCount</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; files were uploaded.&#39;</span><span class=p>)</span>
    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Finished job. Closing connection and quit.&#39;</span><span class=p>)</span>
    <span class=n>cursor</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>connect</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
    <span class=n>connect</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

<span class=c1># S3へ画像ファイルをアップロード</span>
<span class=k>def</span> <span class=nf>uploadToS3</span><span class=p>(</span><span class=n>item_cd</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>imageFolder</span>
    <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Upload image files to AWS S3.&#39;</span><span class=p>)</span>
    <span class=n>bucket_name</span> <span class=o>=</span> <span class=s1>&#39;image&#39;</span>
    <span class=n>s3</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>resource</span><span class=p>(</span><span class=s1>&#39;s3&#39;</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=c1># サーバーに保存されたファイルを指定したパスに保存(file_path1/file_path2/file_path3/1_1_YYYYMMDD.jpg)</span>
        <span class=n>s3</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>)</span><span class=o>.</span><span class=n>upload_file</span><span class=p>(</span><span class=n>imageFolder</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span> <span class=o>+</span> <span class=n>item_cd</span> <span class=o>+</span> <span class=s1>&#39;.jpg&#39;</span><span class=p>,</span> <span class=n>path</span> <span class=o>+</span> <span class=s1>&#39;/1_1_&#39;</span> <span class=o>+</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>today</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y%m</span><span class=si>%d</span><span class=s1>%H%M%S&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;.jpg&#39;</span><span class=p>)</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Image file uploaded. (Item code: &#39;</span> <span class=o>+</span> <span class=n>item_cd</span> <span class=o>+</span> <span class=s1>&#39;)&#39;</span><span class=p>)</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Unable to upload files. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>

<span class=c1># コネクション情報を入力ファイルから読み込む</span>
<span class=k>def</span> <span class=nf>getDBConnection</span><span class=p>():</span>

    <span class=c1># DBConnection接続情報ファイルのパスを取得</span>
    <span class=n>pwd</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
    <span class=n>dbConnection</span> <span class=o>=</span> <span class=n>pwd</span><span class=o>.</span><span class=n>rsplit</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;/env/DBConnection.conf&#39;</span>

    <span class=c1># ファイルがない場合異常終了</span>
    <span class=k>if</span> <span class=p>(</span><span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>dbConnection</span><span class=p>)):</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Please check DBConnection.conf. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>

    <span class=c1># ファイルを読み込む</span>
    <span class=n>connectionInfo</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>dbConnection</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span>
    <span class=n>lines</span> <span class=o>=</span> <span class=n>connectionInfo</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>

    <span class=c1># グローバル変数として保存するための宣言</span>
    <span class=k>global</span> <span class=n>HOST_POST</span>
    <span class=k>global</span> <span class=n>PORT_POST</span>
    <span class=k>global</span> <span class=n>DB_NAME_POST</span>
    <span class=k>global</span> <span class=n>USER_POST</span>
    <span class=k>global</span> <span class=n>PWD_POST</span>
    <span class=k>global</span> <span class=n>HOST_ORAC</span>
    <span class=k>global</span> <span class=n>PORT_ORAC</span>
    <span class=k>global</span> <span class=n>SERVICE_NAME</span>
    <span class=k>global</span> <span class=n>USER_ORAC</span>
    <span class=k>global</span> <span class=n>PWD_ORAC</span>

    <span class=c1># 条件と一致するデータがある場合変数に保存</span>
    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
        <span class=k>if</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=ow>and</span> <span class=s1>&#39;POSTGRESQL&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=s1>&#39;ORACLE&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>line</span><span class=p>):</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)</span>
            <span class=k>if</span> <span class=p>(</span><span class=s1>&#39;HOST_POST&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>HOST_POST</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;PORT_POST&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>PORT_POST</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;DB_NAME_POST&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>DB_NAME_POST</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;USER_POST&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>USER_POST</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;PWD_POST&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>PWD_POST</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;HOST_ORAC&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>HOST_ORAC</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;PORT_ORAC&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>PORT_ORAC</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;SERVICE_NAME&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>SERVICE_NAME</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;USER_ORAC&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>USER_ORAC</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
            <span class=k>elif</span> <span class=p>(</span><span class=s1>&#39;PWD_ORAC&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
                <span class=n>PWD_ORAC</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>

<span class=c1># 起動部</span>
<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=n>getDBConnection</span><span class=p>()</span>

    <span class=c1># 引数がない場合は異常終了処理分岐</span>
    <span class=k>if</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>):</span>
        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;&gt;&gt; Please check arguement. quitting.&#39;</span><span class=p>)</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>GetProcdate</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</code></pre></div><p>DBConnectionファイルを読み込む処理に関してはより良い書き方があるのではないかと思います…が、Python特有のGetter/Setterの書き方にあまり慣れてないゆえ、自分が理解できるコードとして書いた結果がこうです。グローバル変数がメソッド内で<code>global</code>宣言をしないと使えないというところがJavaに慣れていた自分にはかなり新鮮でした。逆にグローバル変数をそれぞれ違うメソッドではなるべく使うなという意味もあるような気もします。</p>
<p>あとはファイル書き込みがテキストだけでなく、バイナリーデータの場合も簡単にかけるということが魅力的ですね。Javaだったらストリームやバッファーをはじめとしてかなり複雑な書き方になっていただろうと思いますが(しかも私はテキストしか扱ったことがないので、同じやり方でバイナリーまでかけるかどうかわかりません)、Pythonではモジュールのインポートもなしで簡単にできますね。もちろん性能を考えるとJavaでかいた方がよかったかも知れませんが、こういう簡単さんがやっぱり生産性の向上に役立つのではないかと思います。</p>
<p>あと、やはりPythonはLinux親和的な構造が魅力的だと思います。処理の結果を判別するために<code>sys.exit()</code>を設定すると終了コードを簡単に確認できますし、<code>sys.args</code>を通じてコマンドラインから引数を受け入れることもできます。簡単かつLinux親和的なので、Linuxでのスクリプト処理が必要な場合はシェルスクリプトよりもPythonを用いる方が良いのでは、と思うようになりました。性能もシェルより良いところもあるという話もありますしね。</p>
<p>結果的にPythonを褒めるようなポストとなりましたが、私としてはプログラミングの初心者もしくはLinuxサーバーからスクリプトを組むことの多い開発者に魅力的な言語と思うので、皆さんにもぜひPythonを使って欲しいです。楽しく、楽に開発しましょう！</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Simple Storage Serviceの略で、その名の通りOSにマウントして普通のディスクのように使えるサービスだそうです。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/oracle/>oracle</a>
<a href=/tags/postgresql/>postgresql</a>
<a href=/tags/blob/>blob</a>
<a href=/tags/python/>python</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/posts/python-xml-modifier-2/>
<div class=article-image>
<img src=/../../images/python.jpg loading=lazy data-key data-hash=/../../images/python.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Pythonでxmlファイルを操作する(2)</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/python-logger/>
<div class=article-image>
<img src=/../../images/python.jpg loading=lazy data-key data-hash=/../../images/python.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Pythonでログを出したい</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/posts/python-xml-modifier-1/>
<div class=article-image>
<img src=/../../images/python.jpg loading=lazy data-key data-hash=/../../images/python.jpg>
</div>
<div class=article-details>
<h2 class=article-title>Pythonでxmlファイルを操作する(1)</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2019 -
2022 Korean-man in Tokyo
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#pythonでdbを連動する>PythonでDBを連動する</a>
<ol>
<li><a href=#接続oracleの場合>接続(Oracleの場合)</a></li>
<li><a href=#接続postgresqlの場合>接続(PostgreSQLの場合)</a></li>
<li><a href=#db処理の共通部分>DB処理の共通部分</a></li>
</ol>
</li>
<li><a href=#画像ファイルをs3へアップロードするコード>画像ファイルをS3へアップロードするコード</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>