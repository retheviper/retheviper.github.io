<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="サーバサイドの機能を作っていると、ファイルダウンロード機能が必要な時があります。ただ、ストレージに保存されてあるファイルをそのまま返すという"><title>KotlinでZIP圧縮してみる</title><link rel=canonical href=https://retheviper.github.io/posts/kotlin-zip-files/><link rel=stylesheet href=/scss/style.min.fbb68fe51fb77bdd639dccfe1c7b590d2330cf8b81da91f1585b35c3d07fbac8.css><meta property="og:title" content="KotlinでZIP圧縮してみる"><meta property="og:description" content="サーバサイドの機能を作っていると、ファイルダウンロード機能が必要な時があります。ただ、ストレージに保存されてあるファイルをそのまま返すという"><meta property="og:url" content="https://retheviper.github.io/posts/kotlin-zip-files/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="kotlin"><meta property="article:tag" content="java"><meta property="article:published_time" content="2021-04-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-04-14T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/kotlin.jpg"><meta name=twitter:title content="KotlinでZIP圧縮してみる"><meta name=twitter:description content="サーバサイドの機能を作っていると、ファイルダウンロード機能が必要な時があります。ただ、ストレージに保存されてあるファイルをそのまま返すという"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/kotlin.jpg"><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BYJBEJB6DX",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/kotlin-zip-files/><img src=/../../images/kotlin.jpg loading=lazy alt="Featured image of post KotlinでZIP圧縮してみる"></a></div><div class=article-details><header class=article-category><a href=/categories/kotlin/ style=background-color:#2a9d8f;color:#fff>kotlin</a></header><h2 class=article-title><a href=/posts/kotlin-zip-files/>KotlinでZIP圧縮してみる</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Apr 14, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p>サーバサイドの機能を作っていると、ファイルダウンロード機能が必要な時があります。ただ、ストレージに保存されてあるファイルをそのまま返すということだけでなく、場合によってはファイルを生成してそのまま返したり、複数のファイルをまとめて転送する必要もありますね。</p><p>リクエストごとに一つのファイルをダウンロードさせるとしたら、実装はそう難しくないものですが、複数のファイルをダウンロードさせるという場合は少し複雑になりますね。ファイルを一つにまとめて送るとしたら、ZIPに圧縮した方が良いでしょう。幸い、Javaでは基本的に<a class=link href=https://docs.oracle.com/javase/jp/8/docs/api/java/util/zip/ZipOutputStream.html target=_blank rel=noopener>ZipOutputStream</a>というAPIを提供しているので、エントリに圧縮対象のファイルを追加したあとZIPファイルを出力だけで良いです。</p><p>ただ、単純にファイルが複数だるだけでなく、ディレクトリが多重にネストされてあったりする場合は、ディレクトリ構造を維持しつつそのまま圧縮するとかの追加的な処理が必要となります。そして場合によっては含めたくないファイルがあるケースもあったりしますね。そしてなるべくファイルの数に関係なく(ファイルが一つであれ、ディレクトリであれ)一つの機能で済ませたいものです。なので、今回はそのようなユースケースに合わせた簡単なメソッドを作る方法を、JavaのコードからKotlinへ移行していく過程を簡単に紹介したいと思います。</p><p>今回紹介しますコードは、はBaeldungの<a class=link href=https://www.baeldung.com/java-compress-and-uncompress target=_blank rel=noopener>JavaでZipを圧縮する方法</a>に関する記事に紹介されてあるものをベースにしています。</p><h2 id=java>Java</h2><p>まずJavaのコードを見ていきましょう。上記の記事には、以下のようなコードが紹介されています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ZipDirectory</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String sourceFile <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;zipTest&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        FileOutputStream fos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;dirCompressed.zip&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        ZipOutputStream zipOut <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ZipOutputStream<span style=color:#ff79c6>(</span>fos<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        File fileToZip <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> File<span style=color:#ff79c6>(</span>sourceFile<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        zipFile<span style=color:#ff79c6>(</span>fileToZip<span style=color:#ff79c6>,</span> fileToZip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>(),</span> zipOut<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        fos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>zipFile</span><span style=color:#ff79c6>(</span>File fileToZip<span style=color:#ff79c6>,</span> String fileName<span style=color:#ff79c6>,</span> ZipOutputStream zipOut<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>fileToZip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isHidden</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>fileToZip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isDirectory</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>fileName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>endsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;/&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>putNextEntry</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ZipEntry<span style=color:#ff79c6>(</span>fileName<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>                zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>closeEntry</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>putNextEntry</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ZipEntry<span style=color:#ff79c6>(</span>fileName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;/&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>                zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>closeEntry</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            File<span style=color:#ff79c6>[]</span> children <span style=color:#ff79c6>=</span> fileToZip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>listFiles</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>File childFile <span style=color:#ff79c6>:</span> children<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                zipFile<span style=color:#ff79c6>(</span>childFile<span style=color:#ff79c6>,</span> fileName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;/&#34;</span> <span style=color:#ff79c6>+</span> childFile<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>(),</span> zipOut<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        FileInputStream fis <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> FileInputStream<span style=color:#ff79c6>(</span>fileToZip<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        ZipEntry zipEntry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ZipEntry<span style=color:#ff79c6>(</span>fileName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>putNextEntry</span><span style=color:#ff79c6>(</span>zipEntry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span><span style=color:#bd93f9>1024</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> length<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>((</span>length <span style=color:#ff79c6>=</span> fis<span style=color:#ff79c6>.</span><span style=color:#50fa7b>read</span><span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            zipOut<span style=color:#ff79c6>.</span><span style=color:#50fa7b>write</span><span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> length<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        fis<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>zipFile</code>メソッドをみると、引数の<code>fileToZip</code>にZIPで圧縮したいファイルやディレクトリのパスを指定して、<code>fileName</code>にはファイルもしくはディレクトリ名、<code>zipOut</code>には圧縮後のZIPのファイル名を指定するようになっています。</p><p>そして実装としては、指定したファイルやディレクトリに<code>hidden</code>属性がある場合は圧縮しなく、圧縮元のファイルがディレクトリである場合は中のファイルを全部ZIPに含ませるという処理が含まれてありますね。対象のファイルとディレクトリを全部エントリに追加した後は、圧縮元を読み込んでZipOutputStreamに書き込むという処理となっています。これをKotlinのコードに変えてみましょう。</p><h2 id=kotlinのコードに変えてみる>Kotlinのコードに変えてみる</h2><p>JavaのコードをKotlinのコードに変えるのはそう難しくありません。Intellijの場合、すでにJavaのコードを貼り付けると自動でKotlinのコードの変換してくれる機能を搭載していますので。ただ、それだけでは十分ではないですね。簡単に変換ができるとしても、それが本当に<code>Kotlinらしいコード</code>になっているとはいえない場合があります。</p><p>そして、処理自体もより単純に、もしくは読みやすいコードにする方法もあるはずですね。上記のJavaコードをまずKotlinに変えて、色々改善したいところを含めて変えていきます。</p><h3 id=kotlinらしいコードに変える>Kotlinらしいコードに変える</h3><p>Intellij 2021.1を基準に、Javaのコードをそのまま貼り付けると以下のようなコードに自動変換されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>@Throws(IOException<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>private</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>zipFile</span>(fileToZip: File, fileName: String, zipOut: ZipOutputStream) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (fileToZip.isHidden) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (fileToZip.isDirectory) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (fileName.endsWith(<span style=color:#f1fa8c>&#34;/&#34;</span>)) {
</span></span><span style=display:flex><span>            zipOut.putNextEntry(ZipEntry(fileName))
</span></span><span style=display:flex><span>            zipOut.closeEntry()
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            zipOut.putNextEntry(ZipEntry(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>$fileName</span><span style=color:#f1fa8c>/&#34;</span>))
</span></span><span style=display:flex><span>            zipOut.closeEntry()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>val</span> children = fileToZip.listFiles()
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (childFile <span style=color:#ff79c6>in</span> children) {
</span></span><span style=display:flex><span>            zipFile(childFile, fileName + <span style=color:#f1fa8c>&#34;/&#34;</span> + childFile.name, zipOut)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>val</span> fis = FileInputStream(fileToZip)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>val</span> zipEntry = ZipEntry(fileName)
</span></span><span style=display:flex><span>    zipOut.putNextEntry(zipEntry)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>val</span> bytes = ByteArray(<span style=color:#bd93f9>1024</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>var</span> length: Int
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (fis.read(bytes).also { length = <span style=color:#ff79c6>it</span> } <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        zipOut.write(bytes, <span style=color:#bd93f9>0</span>, length)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    fis.close()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ここでもっとKotlinらしいコードに変えたい部分は、<code>InputStream</code>や<code>OutputStream</code>の使い方です。Javaでも<code>try-with-resource</code>があって、Kotlinには<code>use()</code>があるのでそちらを使った方が<code>close</code>よりも良い気がします。</p><p>また、<code>if</code>は<code>when</code>に変えたり、<code>for</code>を<code>forEach()</code>に変えたりなどでよりやりたいことを明確にすることができるようにも見えます。個人的にはスコープをあえて分けたほうが責任が明確になり、処理を追うときに混乱しないのでなるべくスコープ関数やCollection専用のオペレーションを積極的に使用して処理の単位を分けられるところはきちんと分けたいと思います。Javaのやり方をとっても処理としては全く問題がありませんが、せっかくなのでKotlinならではのコードを描きたいものです。</p><p>あえてIOExceptionを投げるという表示をしておくというのも、ランタイム時の例外の処理を強制してないKotlinには相応しくないのではないかという気もするので、アノテーションは削除することとします。</p><h3 id=ioからnioに変える>IOからNIOに変える</h3><p>NIOに関しては以前のポストで何回か言及したことがありますが、サーバのように頻繁かつ同時実行数が多いケースは積極的に採用した方が良いと思います。また、Java 1.8以降から追加されたメソッドでかなり便利に使える機能が多いので、IOをNIOに変えるだけでコードの量をかなり減らせる可能性もあります。</p><p>特にディレクトリを指定した場合、そのディレクトリの子要素を循環するにはNIOの<code>Files</code>が提供する機能が強力なので、今回はそれを積極活用することにします。</p><h3 id=シグニチャーを変える>シグニチャーを変える</h3><p>上記のメソッドでは、三つの引数を取っていますが、実際に必要なのは圧縮元のパスと、圧縮先のパスのみですね。ZipOutputStreamを呼び出し元で渡す理由は特になく、むしろこのメソッドを利用する度に定義する必要があるので不便ですね。そして、メソッドの中で単純にエントリを追加していて、呼び出し元とオブジェクトに対する処理の職務を分担するという構造もあまりよくないかと思います。なので、ZipOutputStreamの生成と使用はメソッドの中で完結するように変えることにします。</p><p>こうすることで、メソッドの外側(呼び出し元)での使い方はもっと簡単になりますし、圧縮元のデータを読み込む際に使う<code>InputStream</code>は中で閉じているのに引数の<code>OutputStream</code>は外で閉じるという複雑な状況は避けられます。</p><h3 id=再帰を無くす>再帰を無くす</h3><p>圧縮元のパスがディレクトリである場合は、さらにネストされたディレクトリやファイルもまとめて圧縮するために再帰を使うようになっています。再帰はアルゴリズムとしては重要ではあるものの、処理が全部終わるまでメモリに全データと処理を詰めておくので処理の効率という面ではあまりよくない場合もありますね。やりたいのは単純に<code>hidden</code>属性を持つファイルやディレクトリを除外すること、そしてそれ以外のファイルやディレクトリは全部ZipOutputStreamのエントリに入れたいという単純な事です。</p><p>幸い、NIOを使うことでディレクトリの子要素を全部取得することができますし、取得した子要素は<code>Stream&lt;Path></code>として取得できるので、<code>filter()</code>や<code>forEach()</code>のようなメソッドが使えます。これで十分、再帰を使わずに目的を達成できそうですね。</p><h2 id=完成したコード>完成したコード</h2><p>以上のことを反映し、修正したコードは以下の通りになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>ZipService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>archive</span>(source: Path, target: Path): Unit =
</span></span><span style=display:flex><span>        ZipOutputStream(<span style=color:#50fa7b>Files</span>.newOutputStream(target)).use { zos <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>Files</span>.walk(source)
</span></span><span style=display:flex><span>                .filter { <span style=color:#50fa7b>Files</span>.isHidden(<span style=color:#ff79c6>it</span>).not() }
</span></span><span style=display:flex><span>                .forEach {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>Files</span>.isDirectory(<span style=color:#ff79c6>it</span>)) {
</span></span><span style=display:flex><span>                        zos.putNextEntry(ZipEntry(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>$it</span><span style=color:#f1fa8c>/&#34;</span>))
</span></span><span style=display:flex><span>                        zos.closeEntry()
</span></span><span style=display:flex><span>                    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                        zos.putNextEntry(ZipEntry(<span style=color:#ff79c6>it</span>.toString()))
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>Files</span>.copy(<span style=color:#ff79c6>it</span>, zos)
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>簡単に説明しますと、<code>object</code>として宣言したSingletonクラスにおくことでどこでも活用できるユーティリティクラスにして、メソッドのシグニチャはより単純なものにしました。引数の<code>source</code>には圧縮元のファイルやディレクトリを、<code>target</code>には圧縮先のZIPファイルを指定する事になっています。ZipOutputStreamはメソッドの中で生成して、<code>use()</code>を使って自動にクローズされるようにしています。</p><p>まず優先的に<code>Files.walk()</code>を使って子要素を全部取得するようにしています。取得した子要素は<code>filter()</code>で<code>hidden</code>でない場合を選別しているので、分岐は無くなりますね。また、子要素がディレクトリである場合ディレクトリ名であることを表すために<code>/</code>をつけて<code>ZipEntry</code>を追加とクローズします。子要素がファイルの場合は<code>ZipEntry</code>の追加とコンテンツのコピーを行います。これでより短く、単純なコードの出来上がりです。</p><h2 id=最後に>最後に</h2><p><code>Kotlinらしいコード</code>と述べましたが、上記のコードはあくまで<code>Kotlin/JVM</code>でのみ有効ですね。なのでもし<code>Kotlin/Native</code>や<code>Kotlin/JS</code>などで使うには、別の方法を探す必要があるはずです。また、<code>Files.walk()</code>はJava 1.8から追加されたメソッドなので、1.7の場合は<code>Files.walkFileTree()</code>を、その以前なら仕方なくNIOではない別の方法を使う必要があると思います。</p><p>なので、<code>Kotlin/JVM</code>(Java 1.8以上)ではこれが最善なのかも知れませんが、また色々と研究の余地はありそうですね。こうやってJavaのAPIをKotlinの作法で切り替えていくのも、それなりに価値のあることではないかと思います。</p><p>では、また！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/kotlin/>kotlin</a>
<a href=/tags/java/>java</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/kotlin-write-csv/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>data classのListをCSVにする</h2></div></a></article><article class=has-image><a href=/posts/kotlin-prospect/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>Kotlinのこれからを語る</h2></div></a></article><article class=has-image><a href=/posts/effective-kotlin/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>Effective Kotlinを読む</h2></div></a></article><article class=has-image><a href=/posts/kotlin-japanese-era/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>Kotlinで和暦を使う</h2></div></a></article><article class=has-image><a href=/posts/kotlin-hidden-cost-3/><div class=article-image><img src=/../../images/kotlin.jpg loading=lazy data-key data-hash=/../../images/kotlin.jpg></div><div class=article-details><h2 class=article-title>Kotlinの隠されたコストーその３</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2022 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#java>Java</a></li><li><a href=#kotlinのコードに変えてみる>Kotlinのコードに変えてみる</a><ol><li><a href=#kotlinらしいコードに変える>Kotlinらしいコードに変える</a></li><li><a href=#ioからnioに変える>IOからNIOに変える</a></li><li><a href=#シグニチャーを変える>シグニチャーを変える</a></li><li><a href=#再帰を無くす>再帰を無くす</a></li></ol></li><li><a href=#完成したコード>完成したコード</a></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>