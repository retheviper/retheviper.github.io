<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Javaでアプリケーションを組みながら最も遭遇率の高い例外が何かとしたら、それはNullPointerException(NPE)でしょう。"><title>Nullチェックの地獄から脱出したい</title><link rel=canonical href=https://retheviper.github.io/posts/java-optional/><link rel=stylesheet href=/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css><meta property="og:title" content="Nullチェックの地獄から脱出したい"><meta property="og:description" content="Javaでアプリケーションを組みながら最も遭遇率の高い例外が何かとしたら、それはNullPointerException(NPE)でしょう。"><meta property="og:url" content="https://retheviper.github.io/posts/java-optional/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="optional"><meta property="article:tag" content="java"><meta property="article:published_time" content="2020-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-05T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/java.jpg"><meta name=twitter:title content="Nullチェックの地獄から脱出したい"><meta name=twitter:description content="Javaでアプリケーションを組みながら最も遭遇率の高い例外が何かとしたら、それはNullPointerException(NPE)でしょう。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/java.jpg"><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/favicon/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-139986442-1","auto"),ga("send","pageview"))</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/java-optional/><img src=/../../images/java.jpg loading=lazy alt="Featured image of post Nullチェックの地獄から脱出したい"></a></div><div class=article-details><header class=article-category><a href=/categories/java/ style=background-color:#2a9d8f;color:#fff>java</a></header><h2 class=article-title><a href=/posts/java-optional/>Nullチェックの地獄から脱出したい</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 05, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><p>Javaでアプリケーションを組みながら最も遭遇率の高い例外が何かとしたら、それはNullPointerException(NPE)でしょう。初めてプログラミングを接する人に取っては「空白」と「Null」がどう違うのかを理解することもかなり難しいことではないのかと思いますが、Nullを理解できたとしても予想してなかったところで出てくるNPEで苦労する場合は決して少なくないと思います。ある意味、Javaでのアプリケーション開発はNPEとの戦いであるといっても過言ではないのではないでしょうか。</p><p>なので今回は、NPEに対処するための方法を紹介します。Nullをチェックし、安全なコードを書く方法を探してみましょう。</p><h2 id=nullチェックで十分か>Nullチェックで十分か？</h2><p>とある学生の名前を取得するメソッドがあるとしましょう。データオブジェクトを引数として渡すと、そこから順番に学校、学年、組、学生の情報を取得して最後に学生の名前をStringとして返却するようなものです。これをコードで表現したら、例えば以下のように表現できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudentName</span><span style=color:#ff79c6>(</span>Data data<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    School school <span style=color:#ff79c6>=</span> data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSchool</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Grade grade <span style=color:#ff79c6>=</span> school<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getGrade</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    ClassName className <span style=color:#ff79c6>=</span> grade<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>これをより簡潔なコードで表現するとしたら、以下のようになるでしょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudentName</span><span style=color:#ff79c6>(</span>Data data<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSchool</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getGrade</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getClassName</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>このメソッドが意図通りに作動するとしたら、シグネチャーとコードだけで意図と結果が明確なものとなるはずです。しかし、皆さんにもわかるように、このコードにはいつどこでも例外が発生する可能性があります。</p><p>学生の名前フィールドがNullだとしたら？いや、そもそも学生が、もしくは組が、学年が、学校がNullだったら？引数がNullだとしたら？どれもNPEになりうる可能性があるので、極めて危険なコードとなっています。</p><p>ここでまず考えられる対策は、事前にNullチェックの処理を入れNullでない場合にだけ次の処理に移行するようなコードを書くことでしょう。そしてNullだった場合にまた適切な処理(もしくはデフォルト値)を書くことで意図した通りに動かすことができます。</p><p>では、上のコードにNullチェックの処理を入れ、をNull Safeなコードに変えてみましょう。例えば以下のように変えることができるでしょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudentName</span><span style=color:#ff79c6>(</span>Data data<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>data <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        School school <span style=color:#ff79c6>=</span> data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSchool</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>school <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            Grade grade <span style=color:#ff79c6>=</span> school<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getGrade</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>grade <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                ClassRoom classRoom <span style=color:#ff79c6>=</span> grade<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassRoom</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>classRoom <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    Student student <span style=color:#ff79c6>=</span> classRoom<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>student <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        String studentName <span style=color:#ff79c6>=</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>studentName <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>return</span> studentName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>以上のコードはネストしすぎて、極めて読みづらいコードとなっています。なのでもし一つの項目でもNullチェックが抜けているとしてもわからなくなります。また、コードを直すこともかなり困難になります。メソッドの目的はあくまで、「学生の名前が知りたい」というシンプルな要求に応えるためのものだったのですが、もはやNullチェックが入りすぎてなんのためのロジックなのかわかりづらいですね。</p><p>ネストしている処理を避けるためif文をバラバラにしても結果はあまり変わりません。以下のコードをご覧ください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudentName</span><span style=color:#ff79c6>(</span>Data data<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>data <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    School school <span style=color:#ff79c6>=</span> data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSchool</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>school <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Grade grade <span style=color:#ff79c6>=</span> school<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getGrade</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>grade <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ClassRoom classRoom <span style=color:#ff79c6>=</span> grade<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassRoom</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>classRoom <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> classRoom<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>student <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String studentName <span style=color:#ff79c6>=</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>studentName <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// Default value
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> studentName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>if文のネストを無くして読みやすくしてみようとしました。でも、このやり方だとむしろreturnが多すぎてこれはこれであまりよくない処理になっています。</p><p>このようなコードはどう直したらいいのか？という時に、使えるAPIをJavaでは用意しています。今回の主題であるOptionalです。</p><h2 id=optionalを導入する>Optionalを導入する</h2><p>現代の言語はこのNullによって起こり得る問題を最初からブロックするため最初からNullを代入することを許さなかったり、Nullになりえるオブジェクトを扱えるAPIを提供したりするようです。例えばKotlinやSwiftではNullableやOptionalを制約の一つとして使っているようで(触ってみたことがないのでこうとしかいえませんが)、Pythonの場合もUnionやOptionaと言ったAPIが用意されているようです。そしてJavaもそう言ったトレンドに答えるべく、Java 1.8でOptionalをAPIとして導入しています。</p><p>Optionalは、Nullになる可能性のあるオブジェクトに対しての新しい(といってもJava 1.8で導入されたのでもうそんなに新くもないですが)方法です。基本的には関数型言語から影響を受けて作られているらしいですね。</p><p>私自身は関数型言語に詳しくないのですが、確かにこのOptionalの使い方をみるとLambda同様、元のJavaの思想とはかなり違うもののような気がします。なぜなら、オブジェクトのNullチェックを比較演算してその後の処理を決めるわけではなく、メソッドの連鎖で決めていくような形になっていて、書き方がかなり異質的だからです。</p><p>なら、そんな異質的なAPIをなぜ使うのか？それはOptionalがどんなものであり、どんな特徴を持っているかをまず見て判断することにしましょう。</p><h3 id=使い方が簡単>使い方が簡単</h3><p>map()やfilter()などCollection<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>やStream<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>と似たような機能をするメソッドがあり、さらに引数としてLambdaを使えるので、CollectionやStreamに慣れていると簡単に適応できます。</p><p>Optionalを効率的に使うためにはメソッドチェーニング<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>やLambdaにまずなれる必要があるので、まずはjava.util.functionsになれるとしましょう。<a class=link href=../java-functional-interface>以前のポスト</a>を参考にしてください。</p><h3 id=見ただけでわかる>見ただけでわかる</h3><p>Optionalはオブジェクトを包み、そのオブジェクトがNullである場合の処理のため作られたAPIです。なのでOptionalで包まれているオブジェクトがあると、そのオブジェクトはNullになる可能性があることを明らかにしているということです。なので戻り値だけでNullになる可能性があるコードを見分けることができるようになります。</p><h3 id=可読性が上がる>可読性が上がる</h3><p>Nullチェックという本来の目的に充実しながらも、コードが簡潔になるので読みやすいコードになります。取得したいオブジェクトがネストしている場合もOptionalで対応できます。最初のオブジェクトのNullチェックをして、さらにネストしているオブジェクトをNullチェックしていくような形です。</p><h2 id=optionalでnullチェックを変えてみましょう>OptionalでNullチェックを変えてみましょう</h2><p>では、実際のコードを持ってOptionalでのNullチェックがどう可能になるのかをコードを持ってみてみましょう。さっきのメソッドは以下のように変えることができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudentName</span><span style=color:#ff79c6>(</span>Data data<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Data<span style=color:#ff79c6>::</span>getSchool<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>School<span style=color:#ff79c6>::</span>getGrade<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Grade<span style=color:#ff79c6>::</span>getClassRoom<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>::</span>getStudent<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Student<span style=color:#ff79c6>::</span>getName<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElse</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Optionalが初めての方にはどんなことをしているか一見わからなくなるのではと思いますが、それでもコードの量が減り、可読性がよくなったのはわかるでしょう。もちろん、Nullチェックが省略されているわけでもありません。このように簡潔で分かり安く、安全なNullチェックを可能にするのがOptionalです。</p><h2 id=optionalのメソッド>Optionalのメソッド</h2><p>OptionalはSingletonの<code>java.util.Optional&lt;T></code>をインポートしてオブジェクトを包み、包まれたオブジェクトがNullか否かによってどんな挙動をするかのメソッドを持っています。これからそれらのメソッドを一つづつ見ていきましょう。</p><h3 id=empty>empty()</h3><p>空のOptionalを作成します。空のOptionalはその名の通り空で、中にラップされたオブジェクトがNullの状態です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> emtpyName <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>empty</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// StringはNull
</span></span></span></code></pre></div><h3 id=get>get()</h3><p>Optionalでラップされたオブジェクトを取得する時に使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String value <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Optinal<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>());</span> <span style=color:#6272a4>// Sato
</span></span></span></code></pre></div><h3 id=oft-value>of(T value)</h3><p>引数として渡したオブジェクトを包むOptionalを生成します。ただ、引数のオブジェクトがNullの場合はget()の結果もNullになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Optinal<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// Null
</span></span></span></code></pre></div><h3 id=ofnullablet-value>ofNullable(T value)</h3><p>引数として渡したオブジェクトを包むOptionalを生成するということではof()と同じですが、引数のオブジェクトがNullだった場合はempty()で生成されたOptionalを返却します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Optinal<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// Optional&lt;String&gt;
</span></span></span></code></pre></div><h3 id=mapfunction-super-t--extends-u-mapper>map(Function&lt;? super T, ? extends U> mapper)</h3><p>CollectionやStreamのmap()と似たようなメソッドです。複雑にネストされているフィールドを安全にチェックする時に使います。mapで取り出したオブジェクトは自動的にOptionalでラップされたクラスとなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Student sato <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Student<span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> student <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>sato<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>String nameOfSato <span style=color:#ff79c6>=</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Student<span style=color:#ff79c6>::</span>getName<span style=color:#ff79c6>).</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// Optional&lt;Student&gt; -&gt; Optional&lt;String&gt;
</span></span></span></code></pre></div><p>ここで使われている::での表現式はMethod Referenceといい、ターゲットレファレンスとメソッドを書くだけで一般的なLambdaと同じ効果を期待できる書き方です。Lambdaで既存のコードをより簡潔に書くことができるようになりましたが、さらに引数の変数名を省略できるようにしたものですね。変数名を書かなくても指している対象が明確でメソッドも一つだけを呼ぶ場合に使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 引数を標準出力するLambdaの一般的な書き方
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Consumer<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> print <span style=color:#ff79c6>=</span> name <span style=color:#ff79c6>-&gt;</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Method Referenceに変えた形
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Consumer<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> print <span style=color:#ff79c6>=</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>::</span>print<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// インスタンスの生成
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Supplier<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>=</span> String<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>;</span>
</span></span></code></pre></div><h3 id=filterpredicate-super-t-predicate>filter(Predicate&lt;? super T> predicate)</h3><p>filter()もまたCollectionやStreamのメソッドに慣れているなら簡単に使えるメソッドの一つです。条件と一致する場合(PredicateによりTrueとなる)にだけ値を返却します。単にNullかどうかの判定だけでなく、何かの処理を付け加えたい時に使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 伝統的なパターン
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getSato</span><span style=color:#ff79c6>(</span>Student student<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String name <span style=color:#ff79c6>=</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>name <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// filter
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getSato</span><span style=color:#ff79c6>(</span>Student student<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>.</span><span style=color:#50fa7b>filter</span><span style=color:#ff79c6>(</span>s <span style=color:#ff79c6>-&gt;</span> s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>(</span>Student<span style=color:#ff79c6>::</span>getName<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Optionalの要素は一つしかないのでfilterで指定した条件の結果がfalseの時は以後のメソッドが無視されます。</p><h3 id=ispresent>isPresent()</h3><p>OptionalでラップしたクラスがNullであるかを判定するためのメソッド。Nullでない場合はTrue、Nullの場合はFalseとなるシンプルなものです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> studentName <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>studentName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isPresent</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// true
</span></span></span></code></pre></div><h3 id=ifpresentconsumer-super-t-consumer>ifPresent(Consumer&lt;? super T> consumer)</h3><p>ラップされたオブジェクトがNullでない場合にだけ実行するメソッドを記述します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ifPresent</span><span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>-&gt;</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span>n<span style=color:#ff79c6>));</span>
</span></span></code></pre></div><h3 id=orelset-other>orElse(T other)</h3><p>引数として渡したオブジェクトがNullの場合にデフォルト値を使います。このメソッドを使った場合はget()は記述しなくてもよくなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String defaultName <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Sato&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElse</span><span style=color:#ff79c6>(</span>defaultName<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// student.getName()がNullの場合defaultNameになる
</span></span></span></code></pre></div><h3 id=orelsegetsupplier-extends-t-other>orElseGet(Supplier&lt;? extends T> other)</h3><p>引数として渡したオブジェクトがNullの場合にデフォルト値として指定したLambdaを実行し、その結果を返却します。このメソッドを使った場合はget()は記述しなくてもよくなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElseGet</span><span style=color:#ff79c6>(()</span> <span style=color:#ff79c6>-&gt;</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getNumber</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;の名前がありません&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// student.getName()がNullの場合Lambdaを実行する
</span></span></span></code></pre></div><h3 id=orelsethrowsupplier-extends-x-exceptionsupplier>orElseThrow(Supplier&lt;? extends X> exceptionSupplier)</h3><p>引数として渡したオブジェクトがNullの場合に例外を投げます。このメソッドを使った場合はget()は記述しなくてもよくなります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>String result <span style=color:#ff79c6>=</span> name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElseThrow</span><span style=color:#ff79c6>((</span>BusinessException<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>);</span>
</span></span></code></pre></div><h2 id=optionalで注意すべきこと>Optionalで注意すべきこと</h2><p>Nullチェックで便利で安全なOptionalですが、全ての状況でNullに関する処理を全部Optionalに変える必要はありません。Optionalの導入を検討する時、注意すべきことについて説明します。</p><h3 id=性能を意識する>性能を意識する</h3><p>すでに気づいている方もいらっしゃると思いますが、Optionalはオブジェクトをラップするものなので必然的に性能の低下と繋がります。なのでNullチェックがいる場面では一旦Optionalを使う、ということはあまり良い考えではありません。簡単なNullチェックはOptionalでなくてもできますし、早いです。</p><p>Optionalを使ってオブジェクトがNullの場合の処理を書く際もorElse()よりはorElseGet()を使った方が良いです。orElse()はNullではない場合も必ず実行されるからです。それに対してorElseGet()の場合はLazy<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>なメソッドなのでより良い性能を期待できます。</p><p>ただ、場合によっては(staticなデフォルト値をフィールドとして持っているなど)、orElse()の方を使った方が良いケースもあるのでその場の判断が重要です。返却したいデフォルト値のインスタンスがどこで作成されるかの時点をよく把握しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例(Nullではない場合捨てられるインスタンス)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> Student <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>).</span><span style=color:#50fa7b>orElse</span><span style=color:#ff79c6>(</span>Student<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> Student <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>).</span><span style=color:#50fa7b>orElseGet</span><span style=color:#ff79c6>(</span>Student<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>また、戻り値としてNullもしくは決まったデフォルト値を期待する場合はOptionalよりもNullチェックの方が良い場合もあります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例(常に同じデフォルト値が決まっている場合)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> Student defaultStudent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Student <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>).</span><span style=color:#50fa7b>orElse</span><span style=color:#ff79c6>(</span>defaultStudent<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> Student <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Student student <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> student <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> student <span style=color:#ff79c6>:</span> defaultStudent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=ispresentとgetの組み合わせはng>isPresent()とget()の組み合わせはNG</h3><p>isPresent()でオブジェクトがNullかを確認したあと、get()でオブジェクトを取得するようなコードは結局普通のNullチェックと変わりません。デフォルト値を使いたい場合はorElseGet()を、例外としたい場合はorElseThrow()を活用しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Optional<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> student <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isPresent</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// (value != null)の方が良い
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> NullPointerException<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Optional<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> student <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElseThrow</span><span style=color:#ff79c6>(</span>NullPointerException<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>また、オブジェクトがNullでない場合にだけ処理を行いたい場合なら、ifPresent()を使いましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>adjustScore</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> score<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Optional<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> student <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isPresent</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>setScore</span><span style=color:#ff79c6>(</span>score<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>adjustScore</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> score<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Optional<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> student <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStudent</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    student<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ifPresent</span><span style=color:#ff79c6>(</span>s <span style=color:#ff79c6>-&gt;</span> s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setScore</span><span style=color:#ff79c6>(</span>score<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=フィールドでは使わない>フィールドでは使わない</h3><p>そもそもOptionalはフィールドとして使われる場合を想定していないようです。なぜなら、OptionalはSerializableを継承してないからです。なのでDTOなどでフィールドとしてOptionalを使うとNullチェック以前に問題が起こる可能性があります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>@Data
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Student</span> <span style=color:#8be9fd;font-style:italic>implements</span> Serializable<span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name<span style=color:#ff79c6>;</span> <span style=color:#6272a4>// 直列化できない
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>@Data
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Student</span> <span style=color:#8be9fd;font-style:italic>implements</span> Serializable<span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name<span style=color:#ff79c6>;</span> <span style=color:#6272a4>// 直列化できる
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=引数では使わない>引数では使わない</h3><p>メソッドやコンストラクターの引数としてOptionalを使うと、それを呼び出すたびに引数としてOptionalを生成する必要があります。また、内部的にOptionalでNullチェックのロジックが入るのでコードも複雑になりますね。こういう場合、内部でどんな処理が行われ、期待通りの処理になっているかわからなくなるので不便です。</p><p>なのでメソッドやコンストラクターの引数は普通のオブジェクトにして、Nullチェックをした方が使いやすく意図した処理を期待できるようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Student</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>Student</span><span style=color:#ff79c6>(</span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// インスタンスを作成するたびOptionalも必要となる
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>name</span> <span style=color:#ff79c6>=</span> name<span style=color:#ff79c6>.</span><span style=color:#50fa7b>orElseThrow</span><span style=color:#ff79c6>(</span>NullPointerException<span style=color:#ff79c6>::</span><span style=color:#ff79c6>new</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// OptionalでNullチェックおよび代入が必要
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Student</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>Student</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>name</span> <span style=color:#ff79c6>=</span> name<span style=color:#ff79c6>;</span> <span style=color:#6272a4>// 期待通りの処理
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=collectionの中では使わない>Collectionの中では使わない</h3><p>Collectionの中の要素は無理やり入れない限りNullが入らない場合もあれば、Nullチェックに対応するメソッドを含めている場合もあります。そして中の要素は複数になるので、Optionalを要素として使う場合は性能の低下が必然的に起こります。なので要素ではなるべくOptionalを使わないようにしましょう。また、フィールドや引数と同じく要素を追加したり取得する場合に毎回Optionalを経由しなければならないという不便さがあります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>Optional<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> names <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>names<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>name1<span style=color:#ff79c6>));</span> <span style=color:#6272a4>// 要素を追加するたびラップが必要
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> names <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>names<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>name1<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><h3 id=collectionはcollectionで>CollectionはCollectionで</h3><p>Collectionが戻り値のメソッドの場合、NullだとCollections.emptyList()やCollections.emptyMap()などで空のCollectionを返却した方が良い場合が多いです。Collectionは</p><p>また、Spring Data JPAを使っている場合はそもそも戻り値がNullだと、自動的に空のListを生成してくれるので尚更Optionalを使う必要がありません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> Optional<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>listStudent</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> students <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>listStudent</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>ofNullable</span><span style=color:#ff79c6>(</span>students<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> List<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>listStudent</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>Student<span style=color:#ff79c6>&gt;</span> students <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>repository</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>listStudent</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> students <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> students <span style=color:#ff79c6>:</span> Collections<span style=color:#ff79c6>.</span><span style=color:#50fa7b>emptyList</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=intlongdoubleはoptionalでラップしない>int/long/doubleはOptionalでラップしない</h3><p>Optionalのバリエーションでは、一部プリミティブ型のためのクラスも用意されています。int/long/doubleの場合がそうです。これらはOptionalInt、OptionalLong、OptionalDoubleで包む方が良いです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// よくない例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Optional<span style=color:#ff79c6>&lt;</span>Integer<span style=color:#ff79c6>&gt;</span> count <span style=color:#ff79c6>=</span> Optional<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span>100<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> countNum <span style=color:#ff79c6>=</span> count<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 良い例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>OptionalInt count <span style=color:#ff79c6>=</span> OptionalInt<span style=color:#ff79c6>.</span><span style=color:#50fa7b>of</span><span style=color:#ff79c6>(</span>100<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> countNum <span style=color:#ff79c6>=</span> count<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAsInt</span><span style=color:#ff79c6>();</span>
</span></span></code></pre></div><h2 id=最後に>最後に</h2><p>今は使われているJavaのバージョンが古くても、公式サポートなどの理由でJava 1.8以上にバージョンアップするところも多いと聞きます。ならばJavaプログラマーとして、未来に備えJava 1.8の重要なAPIに慣れて置いた方が良いでしょう。そういう意味でFunctionやOptionalは皆さんにもぜひ使ってみて欲しいAPIでもあります。そもそもJavaがこんなにメジャーな言語になり得たのは、開発しやすいというメリットがあったからなので、さらに開発が楽になるAPIは覚えておいて損はないでしょう。</p><p>Javaもかなり古い言語ですが、最近は急激なバージョンアップと共に関数型言語など最近のトレンドを反映して変化しているところもあります。今は性能も書きやすさも優秀な言語が溢れ出している時代ですが、こんなJavaの変化がどこまで続き、いつまで生き残ることができるか気になります。JVMは依然として強力ですが、LLVMなどより性能が優れた技術も続々と登場していますしね。でも、Javaの変化に適応し、大体のAPIを使うことができたら、他の言語にも適応しやすくなるのではと思います。そういう理由ででも、みなさん、Java 1.8以後のAPIは注目してください。では！</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>List, Set, Mapなど複数の要素を持つオブジェクトのことを指します。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>ファイルの入出力で使われるInputStreamやOutputStreamではなく、Collectionの要素を一つずつ巡回しながら特定のメソッド(主にLambda)を実行できるようにしてくれるJava 1.8のAPIです。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>戻り値が自分自身のため、何度もメソッドをつなげて書くことのできる仕組み。Builderパターンが代表的なメソッドチェーニングの例です。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>プログラミングでLazyということは、とある処理が常にではなく、呼ばれた際に初めて実行される仕組みのことを意味します。必要な時だけ処理が始まるので不要な処理が減ります。&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></section><footer class=article-footer><section class=article-tags><a href=/tags/optional/>optional</a>
<a href=/tags/java/>java</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/java-new-methods-from-9-to-11/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>9からの新メソッドめぐり</h2></div></a></article><article class=has-image><a href=/posts/java-enter-to-17/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>Java 17は何が変わったか</h2></div></a></article><article class=has-image><a href=/posts/java-string-concat-and-split/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>今更な文字列操作の話</h2></div></a></article><article class=has-image><a href=/posts/java-file-copy/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>今更なI/Oの話</h2></div></a></article><article class=has-image><a href=/posts/java-collection-loop/><div class=article-image><img src=/../../images/java.jpg loading=lazy data-key data-hash=/../../images/java.jpg></div><div class=article-details><h2 class=article-title>今更なループの話</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2022 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#nullチェックで十分か>Nullチェックで十分か？</a></li><li><a href=#optionalを導入する>Optionalを導入する</a><ol><li><a href=#使い方が簡単>使い方が簡単</a></li><li><a href=#見ただけでわかる>見ただけでわかる</a></li><li><a href=#可読性が上がる>可読性が上がる</a></li></ol></li><li><a href=#optionalでnullチェックを変えてみましょう>OptionalでNullチェックを変えてみましょう</a></li><li><a href=#optionalのメソッド>Optionalのメソッド</a><ol><li><a href=#empty>empty()</a></li><li><a href=#get>get()</a></li><li><a href=#oft-value>of(T value)</a></li><li><a href=#ofnullablet-value>ofNullable(T value)</a></li><li><a href=#mapfunction-super-t--extends-u-mapper>map(Function&lt;? super T, ? extends U> mapper)</a></li><li><a href=#filterpredicate-super-t-predicate>filter(Predicate&lt;? super T> predicate)</a></li><li><a href=#ispresent>isPresent()</a></li><li><a href=#ifpresentconsumer-super-t-consumer>ifPresent(Consumer&lt;? super T> consumer)</a></li><li><a href=#orelset-other>orElse(T other)</a></li><li><a href=#orelsegetsupplier-extends-t-other>orElseGet(Supplier&lt;? extends T> other)</a></li><li><a href=#orelsethrowsupplier-extends-x-exceptionsupplier>orElseThrow(Supplier&lt;? extends X> exceptionSupplier)</a></li></ol></li><li><a href=#optionalで注意すべきこと>Optionalで注意すべきこと</a><ol><li><a href=#性能を意識する>性能を意識する</a></li><li><a href=#ispresentとgetの組み合わせはng>isPresent()とget()の組み合わせはNG</a></li><li><a href=#フィールドでは使わない>フィールドでは使わない</a></li><li><a href=#引数では使わない>引数では使わない</a></li><li><a href=#collectionの中では使わない>Collectionの中では使わない</a></li><li><a href=#collectionはcollectionで>CollectionはCollectionで</a></li><li><a href=#intlongdoubleはoptionalでラップしない>int/long/doubleはOptionalでラップしない</a></li></ol></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>