<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前回までご紹介したJenkinsでのジョブ生成は、どちらかというと、古いやり方によるものでした。実際、2016年にJenkinsが2.0にア"><title>Jenkins Pipelineを使う</title>
<link rel=canonical href=https://retheviper.github.io/posts/jenkins-pipeline/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Jenkins Pipelineを使う"><meta property="og:description" content="前回までご紹介したJenkinsでのジョブ生成は、どちらかというと、古いやり方によるものでした。実際、2016年にJenkinsが2.0にア"><meta property="og:url" content="https://retheviper.github.io/posts/jenkins-pipeline/"><meta property="og:site_name" content="Korean-man in Tokyo"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="groovy"><meta property="article:tag" content="ci/cd"><meta property="article:tag" content="jenkins"><meta property="article:published_time" content="2020-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-26T00:00:00+00:00"><meta property="og:image" content="https://retheviper.github.io/images/jenkins.jpg"><meta name=twitter:title content="Jenkins Pipelineを使う"><meta name=twitter:description content="前回までご紹介したJenkinsでのジョブ生成は、どちらかというと、古いやり方によるものでした。実際、2016年にJenkinsが2.0にア"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://retheviper.github.io/images/jenkins.jpg"><link rel="shortcut icon" href=/favicon.ico><link rel=icon href=/favicon/favicon.ico><link rel=mask-icon href=safari-pinned-tab.svg color=black><link rel=manifest href=/favicon/manifest.json><script async src="https://www.googletagmanager.com/gtag/js?id=G-BYJBEJB6DX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BYJBEJB6DX",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu768313a802c015f07dded3abd3d4245d_264018_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>👋</span></figure><div class=site-meta><h1 class=site-name><a href=/>Korean-man in Tokyo</a></h1><h2 class=site-description>一人前になりたいです</h2></div></header><ol class=social-menu><li><a href=https://www.credly.com/users/youngbin-kim.6d7122f1/badges target=_blank title=Certificates rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-certificate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="15" cy="15" r="3"/><path d="M13 17.5V22l2-1.5 2 1.5v-4.5"/><path d="M10 19H5a2 2 0 01-2-2V7c0-1.1.9-2 2-2h14a2 2 0 012 2v10a2 2 0 01-1 1.73"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="12" x2="9" y2="12"/><line x1="6" y1="15" x2="8" y2="15"/></svg></a></li><li><a href=https://github.com/retheviper target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/%E8%8B%B1%E6%96%8C-%E9%87%91-6736ba194/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://retheviper.github.io/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#pipeline使うと何が嬉しい>Pipeline使うと何が嬉しい？</a></li><li><a href=#pipeline作成チュートリアル>Pipeline作成チュートリアル</a><ol><li><a href=#pipelineジョブの作成>Pipelineジョブの作成</a></li><li><a href=#pipelineスクリプト>Pipelineスクリプト</a></li><li><a href=#pipelineの実行結果>Pipelineの実行結果</a></li><li><a href=#pipelineスクリプトの構造>Pipelineスクリプトの構造</a></li><li><a href=#実行エージェントの設定>実行エージェントの設定</a></li><li><a href=#ステージを作る>ステージを作る</a></li><li><a href=#pipelineスクリプト例題>Pipelineスクリプト例題</a></li></ol></li><li><a href=#最後に>最後に</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/jenkins-pipeline/><img src=/../../images/jenkins.jpg loading=lazy alt="Featured image of post Jenkins Pipelineを使う"></a></div><div class=article-details><header class=article-category><a href=/categories/jenkins/ style=background-color:#2a9d8f;color:#fff>jenkins</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/jenkins-pipeline/>Jenkins Pipelineを使う</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 26, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p>前回までご紹介したJenkinsでのジョブ生成は、どちらかというと、古いやり方によるものでした。実際、2016年にJenkinsが2.0にアップデートされながら、スクリプトでジョブを作成できるPipelineというものが導入されていました。</p><p>Pipelineではgroovyを使って、実行したいコマンドやタスクなどをステージという単位で書きます。書いたスクリプトは上から順次実行され、各ステージごとに実行結果を画面上に表示してくれます。今までのJenkinsジョブと比べ使い方がかなり違うので、今回はそのPipelineジョブを作成する方法をサンプルを持って紹介したいと思います。</p><h2 id=pipeline使うと何が嬉しい>Pipeline使うと何が嬉しい？</h2><p>まずは普通のジョブと比べ、どんなメリットがあるかを知りたいですね。既存のFreestyleジョブでなく、PipelineでJenkinsのジョブを作成すると以下のようなメリットがあります。</p><ul><li>スクリプトなので管理がしやすい<ul><li>ファイルとしても管理ができるので、Gitなどでバージョンコントロールができます。</li></ul></li><li>作成が簡単<ul><li>Snippetを提供するので簡単にスクリプトを作成できます。</li></ul></li><li>ジョブの成功・失敗履歴を簡単に確認できる<ul><li>ステージ単位でジョブを実行するので、どのステージが成功・失敗したか簡単に確認できます。</li></ul></li></ul><p>Pipelineジョブ内のステージに関する実行履歴はGUIから表示され、簡単に確認できる実行ログを提供しています。以下のような画面です。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_stage_view.png width=1536 height=1148 srcset="/posts/jenkins-pipeline/jenkins_pipeline_stage_view_hu27a45b97e566fd3c07d8a8e59512b8f3_155188_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_stage_view_hu27a45b97e566fd3c07d8a8e59512b8f3_155188_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Stage View" class=gallery-image data-flex-grow=133 data-flex-basis=321px></p><h2 id=pipeline作成チュートリアル>Pipeline作成チュートリアル</h2><h3 id=pipelineジョブの作成>Pipelineジョブの作成</h3><p>では、まずPipelineジョブを作成する手順を簡単に説明していきましょう。ジョブ作成画面からジョブ名を入力して、Pipelineを選択します。</p><p><img src=/posts/jenkins-pipeline/jenkins_create_pipeline.png width=1944 height=1540 srcset="/posts/jenkins-pipeline/jenkins_create_pipeline_hu8b25d7eb3ac6973876c62934a54cb3de_341771_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_create_pipeline_hu8b25d7eb3ac6973876c62934a54cb3de_341771_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Create Pipeline" class=gallery-image data-flex-grow=126 data-flex-basis=302px></p><h3 id=pipelineスクリプト>Pipelineスクリプト</h3><p>Pipelineでジョブを作成すると、ジョブで実行する項目を指定する画面もFreestyleジョブとは違うものになります。ビルドトリガーなどの設定は同じですが、画面を下にスクロールしてみるとPipelineというタブがあることを確認できます。ここに直接スクリプトを書くか、Gitなどで管理しているスクリプトファイルを指定するかで何を実行するか選べられます。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_script1.png width=1950 height=1532 srcset="/posts/jenkins-pipeline/jenkins_pipeline_script1_hu2dabcb0670808e6f856d8197ebaa4564_163416_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_script1_hu2dabcb0670808e6f856d8197ebaa4564_163416_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Script" class=gallery-image data-flex-grow=127 data-flex-basis=305px></p><p>しかし、いきなりスクリプトを書くのも難しいことです。まず画面の右にあるtry sample Pipeline&mldr;をクリックしてみましょう。まずはHello worldを選んでみます。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_script2.png width=1924 height=1508 srcset="/posts/jenkins-pipeline/jenkins_pipeline_script2_hue8d0b88836df39e07c63367422db2ab1_192700_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_script2_hue8d0b88836df39e07c63367422db2ab1_192700_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Script 2" class=gallery-image data-flex-grow=127 data-flex-basis=306px></p><p>Pipelineのスクリプトはgroovyを使っていますが、groovyの文法をまず勉強する必要はありません。サンプルのコードは他にもあるので、それらを参考してどんな書き方をするかを確認しましょう。</p><p>また、Pipelineスクリプトに慣れてない人のためにJenkinsではSnippet作成機能を提供しています。実行したいタスクをドロップダウンメニューから選び、必要なパラメータなどを入力すると自動的にスクリプトを生成してくれる便利な機能です。Pipelineのスクリプト入力欄の下にあるPipeline Syntaxをクリックすると以下のような画面が表示されます。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_snippet.png width=2626 height=1312 srcset="/posts/jenkins-pipeline/jenkins_pipeline_snippet_hu7cf75d3cec4a4c7e27c273d3fda53e97_220706_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_snippet_hu7cf75d3cec4a4c7e27c273d3fda53e97_220706_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Snippet" class=gallery-image data-flex-grow=200 data-flex-basis=480px></p><p>最初からスクリプトを手で書いても良いですが、どう書いたらわからない場合はこちらの機能を使いましょう。</p><h3 id=pipelineの実行結果>Pipelineの実行結果</h3><p>完成したPipelineジョブを実行するとステージ別に成功と失敗の結果が表示されます。先ほど作成したHello Worldサンプルの場合の実行結果画面です。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_result1.png width=842 height=922 srcset="/posts/jenkins-pipeline/jenkins_pipeline_result1_hu8ad7bfbb76d1c266f47d510bdb3d24f5_86999_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_result1_hu8ad7bfbb76d1c266f47d510bdb3d24f5_86999_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Result" class=gallery-image data-flex-grow=91 data-flex-basis=219px></p><p>ここでは各ステージをクリックすると、ステージ別に書いたタスクに対して結果を確認できます。Logsをクリックしてみましょう。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_result2.png width=852 height=922 srcset="/posts/jenkins-pipeline/jenkins_pipeline_result2_huc907378f3d97b44e901709f5063ca344_104457_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_result2_huc907378f3d97b44e901709f5063ca344_104457_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Result 2" class=gallery-image data-flex-grow=92 data-flex-basis=221px></p><p>Log画面ではステージで実行したコマンドやタスクの結果がそれぞれ出力され、実行時間と共に詳細を確認することもできます。</p><p><img src=/posts/jenkins-pipeline/jenkins_pipeline_result3.png width=1786 height=1082 srcset="/posts/jenkins-pipeline/jenkins_pipeline_result3_hude4f41dfa45580d3665f04bc7b92f2cb_143532_480x0_resize_box_3.png 480w, /posts/jenkins-pipeline/jenkins_pipeline_result3_hude4f41dfa45580d3665f04bc7b92f2cb_143532_1024x0_resize_box_3.png 1024w" loading=lazy alt="Jenkins Pipeline Result 3" class=gallery-image data-flex-grow=165 data-flex-basis=396px></p><h3 id=pipelineスクリプトの構造>Pipelineスクリプトの構造</h3><p>では、簡単にPipelineスクリプトがどんな構造となっているかもみていきましょう。Pipelineスクリプトはまず以下のようなコードで定義します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// この中に実行するエージェントやステージを書く
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=実行エージェントの設定>実行エージェントの設定</h3><p>pipelineブロックを書いたら、次はpipelineを実行する環境を設定します。単純にJenkinsが起動しているインスタンスの中での実行ならagent anyと書くだけですが、最近はジョブを実行するためだけのDockerコンテナを使うことも多いようです。その場合は実行環境としてDockerコンテナを指定する必要がありますね。以下のようなコードでコンテナを指定します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    docker <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      image <span style=color:#e6db74>&#39;実行したいイメージ&#39;</span>
</span></span><span style=display:flex><span>      args <span style=color:#e6db74>&#39;イメージを実行する時に渡すコマンドライン変数&#39;</span> <span style=color:#75715e>// 省略可能
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=ステージを作る>ステージを作る</h3><p>環境まで設定できたら、次は実行したいタスクを書きます。ここで大事なのはステージという概念です。Jenkinsの公式サイトではステージブロックを「Pipeline全体で実行するタスクの明確なサブセット」として定義しています。つまり、ステージ一つが一つのタスクの段階という意味でしょう。ステージの中では一つのタスク単位であるステップを定義し、ステップの中で実行するコマンドを書きます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Docker環境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;ステージ名1&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 実行したいコマンド
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;ステージ名2&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Pipelineそのものに対する説明は以上となります。では、次に実際のPipelineジョブを書いたらどんな形になるのかを紹介します。</p><h3 id=pipelineスクリプト例題>Pipelineスクリプト例題</h3><p>以下のジョブをPipelineで作ると仮定して、簡単な例題を作ってみました。</p><ol><li>実行環境はopenjdkコンテナ(rootユーザー)</li><li>Gitでソースコードをチェックアウト(ディレクトリはspringboot)</li><li>gradlewタスクを実行してwarファイルを作る</li><li>出来上がったwarファイルをAzure Blobにアップロード</li></ol><p>これを実際のコードで表現すると以下のようになります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    docker <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      image <span style=color:#e6db74>&#39;openjdk&#39;</span> <span style=color:#75715e>// openjdk公式イメージを使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      args <span style=color:#e6db74>&#39;-u root&#39;</span> <span style=color:#75715e>// ユーザーをrootに指定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Checkout&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// Gitチェックアウトステージ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkout<span style=color:#f92672>([</span>$class<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GitSCM&#39;</span><span style=color:#f92672>,</span> branches: <span style=color:#f92672>[[</span>name: <span style=color:#e6db74>&#39;*/ブランチ&#39;</span><span style=color:#f92672>]],</span> doGenerateSubmoduleConfigurations: <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> extensions: <span style=color:#f92672>[[</span>$class<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;RelativeTargetDirectory&#39;</span><span style=color:#f92672>,</span> relativeTargetDir: <span style=color:#e6db74>&#39;保存するディレクトリ&#39;</span><span style=color:#f92672>]],</span> submoduleCfg: <span style=color:#f92672>[],</span> userRemoteConfigs: <span style=color:#f92672>[[</span>credentialsId: <span style=color:#e6db74>&#39;GitクレデンシャルID&#39;</span><span style=color:#f92672>,</span> url: <span style=color:#e6db74>&#39;https://Gitレポジトリ&#39;</span><span style=color:#f92672>]]])</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Build&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// ビルドステージ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        dir<span style=color:#f92672>(</span>path: <span style=color:#e6db74>&#39;springbootapi&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// 作業ディレクトリを指定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          sh <span style=color:#e6db74>&#39;./gradlew bootWar&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Upload&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// ビルドしたwarファイルをAzure Blobにアップロードするステージ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        dir<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;springbootapi/web/build/libs&#39;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>          azureUpload storageCredentialId: <span style=color:#e6db74>&#39;ストレージクレデンシャルID&#39;</span><span style=color:#f92672>,</span> storageType: <span style=color:#e6db74>&#39;blob&#39;</span><span style=color:#f92672>,</span> containerName: <span style=color:#e6db74>&#39;コンテナ名&#39;</span><span style=color:#f92672>,</span> filesPath: <span style=color:#e6db74>&#39;**/*.war&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Finalize&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// 作業が終わるとワークスペースを削除するステージ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        cleanWs<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>まだPipelineのコードに慣れてないと難しいと思われるかもしれませんが、Pipeline Syntaxを活用するとすぐかけるものなので皆さんもぜひ挑戦してみてください。</p><h2 id=最後に>最後に</h2><p>最初Jenkinsに接した時もこんなに便利なツールがあるとは！と思いましたが、Pipelineの導入でさらに便利かつ明確にタスクがわかるようになっていて驚きました。最近はAzure Pipelinesを少し触る機会があったのですが、そちらのジョブ作成もこのJenkinsのPipelineを意識した感じです。これからのCI/CDツールは多分言語や文法は違っても、どれもこのような形になるのではないかと思うくらい良い変化です。皆さんもぜひJenkinsのPipelineに触れて、快適なビルド・デプロイを楽しんてみてください。</p><p>では、また！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/groovy/>groovy</a>
<a href=/tags/ci/cd/>ci/cd</a>
<a href=/tags/jenkins/>jenkins</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/jenkins-java-deploy/><div class=article-image><img src=/../../images/jenkins.jpg loading=lazy data-key data-hash=/../../images/jenkins.jpg></div><div class=article-details><h2 class=article-title>JenkinsでJarファイルをデプロイする</h2></div></a></article><article class=has-image><a href=/posts/jenkins-java-build/><div class=article-image><img src=/../../images/jenkins.jpg loading=lazy data-key data-hash=/../../images/jenkins.jpg></div><div class=article-details><h2 class=article-title>JenkinsでJavaプロジェクトをビルドする</h2></div></a></article><article class=has-image><a href=/posts/jenkins-automation-3/><div class=article-image><img src=/../../images/jenkins.jpg loading=lazy data-key data-hash=/../../images/jenkins.jpg></div><div class=article-details><h2 class=article-title>Jenkinsで何もかも楽にしたい(3)</h2></div></a></article><article class=has-image><a href=/posts/jenkins-automation-2/><div class=article-image><img src=/../../images/jenkins.jpg loading=lazy data-key data-hash=/../../images/jenkins.jpg></div><div class=article-details><h2 class=article-title>Jenkinsで何もかも楽にしたい(2)</h2></div></a></article><article class=has-image><a href=/posts/jenkins-automation-1/><div class=article-image><img src=/../../images/jenkins.jpg loading=lazy data-key data-hash=/../../images/jenkins.jpg></div><div class=article-details><h2 class=article-title>Jenkinsで何もかも楽にしたい(1)</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2024 Korean-man in Tokyo</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>